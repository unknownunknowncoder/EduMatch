<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åŒºå¸–å­æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .post {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        .post-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .post-meta {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .post-content {
            font-size: 16px;
            line-height: 1.5;
            color: #444;
        }
        .post-tags {
            margin-top: 10px;
        }
        .tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #1976d2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç¤¾åŒºå¸–å­è°ƒè¯•é¡µé¢</h1>
        <div id="status" class="status loading">æ­£åœ¨åˆå§‹åŒ–...</div>
        <button onclick="loadPosts()" id="loadBtn">åŠ è½½å¸–å­</button>
        <button onclick="testConnection()" id="testBtn">æµ‹è¯•è¿æ¥</button>
        <button onclick="checkRLS()" id="rlsBtn">æ£€æŸ¥RLSç­–ç•¥</button>
    </div>

    <div class="container">
        <h2>ğŸ“Š å¸–å­åˆ—è¡¨ (å…± <span id="postCount">0</span> æ¡)</h2>
        <div id="postsList">
            <p>ç‚¹å‡»"åŠ è½½å¸–å­"æŒ‰é’®è·å–æ•°æ®</p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ·ï¸ çƒ­é—¨æ ‡ç­¾</h2>
        <div id="tagsList">
            <p>æš‚æ— æ ‡ç­¾æ•°æ®</p>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://aonlahundnkxuyxfsmcy.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvbmxhaHVuZG5reHV5eGZzbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjYwNTUsImV4cCI6MjA3ODY0MjA1NX0.IQswPG1NkJKht83isjWJk5nzuhymzETAf81_71kXaVE'
        
        // åˆ›å»º Supabase å®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        let posts = []
        let isLoading = false

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'loading') {
            const statusEl = document.getElementById('status')
            statusEl.textContent = message
            statusEl.className = `status ${type}`
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString)
            const now = new Date()
            const diff = now.getTime() - date.getTime()
            const days = Math.floor(diff / (1000 * 60 * 60 * 24))
            
            if (days === 0) {
                return 'ä»Šå¤©'
            } else if (days === 1) {
                return 'æ˜¨å¤©'
            } else if (days < 7) {
                return `${days}å¤©å‰`
            } else if (days < 30) {
                return `${Math.floor(days / 7)}å‘¨å‰`
            } else {
                return date.toLocaleDateString('zh-CN')
            }
        }

        // æ¸²æŸ“å¸–å­åˆ—è¡¨
        function renderPosts() {
            const postsList = document.getElementById('postsList')
            const postCount = document.getElementById('postCount')
            
            postCount.textContent = posts.length
            
            if (posts.length === 0) {
                postsList.innerHTML = '<p>æš‚æ— å¸–å­æ•°æ®</p>'
                return
            }
            
            postsList.innerHTML = posts.map(post => `
                <div class="post">
                    <div class="post-title">${post.title}</div>
                    <div class="post-meta">
                        <strong>ä½œè€…:</strong> ${post.author} | 
                        <strong>åˆ†ç±»:</strong> ${post.category} | 
                        <strong>æ—¶é—´:</strong> ${formatDate(post.created_at)} | 
                        <strong>ç‚¹èµ:</strong> ${post.likes_count || 0}
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="post-tags">
                            ${post.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('')
        }

        // åŠ è½½æ ‡ç­¾
        async function loadTags() {
            try {
                const { data, error } = await supabase
                    .from('community_posts')
                    .select('tags')
                
                if (error) {
                    console.error('åŠ è½½æ ‡ç­¾å¤±è´¥:', error)
                    return
                }
                
                // ç»Ÿè®¡æ ‡ç­¾
                const tagCount = {}
                data.forEach(post => {
                    if (post.tags && Array.isArray(post.tags)) {
                        post.tags.forEach(tag => {
                            tagCount[tag] = (tagCount[tag] || 0) + 1
                        })
                    }
                })
                
                const tagsList = document.getElementById('tagsList')
                const sortedTags = Object.entries(tagCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                
                if (sortedTags.length === 0) {
                    tagsList.innerHTML = '<p>æš‚æ— æ ‡ç­¾æ•°æ®</p>'
                } else {
                    tagsList.innerHTML = sortedTags.map(([tag, count]) => 
                        `<span class="tag">${tag} (${count})</span>`
                    ).join(' ')
                }
                
            } catch (error) {
                console.error('åŠ è½½æ ‡ç­¾å¼‚å¸¸:', error)
            }
        }

        // åŠ è½½å¸–å­
        async function loadPosts() {
            if (isLoading) return
            
            isLoading = true
            document.getElementById('loadBtn').disabled = true
            showStatus('æ­£åœ¨åŠ è½½å¸–å­...', 'loading')
            
            try {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½å¸–å­...')
                
                const { data, error } = await supabase
                    .from('community_posts')
                    .select('*')
                    .order('created_at', { ascending: false })
                
                console.log('ğŸ“Š æŸ¥è¯¢ç»“æœ:', { data, error })
                
                if (error) {
                    console.error('âŒ åŠ è½½å¸–å­å¤±è´¥:', error)
                    showStatus(`åŠ è½½å¤±è´¥: ${error.message}`, 'error')
                    return
                }
                
                posts = data || []
                console.log('âœ… æˆåŠŸåŠ è½½', posts.length, 'æ¡å¸–å­')
                console.log('ğŸ“„ å¸–å­è¯¦æƒ…:', posts)
                
                renderPosts()
                loadTags()
                showStatus(`æˆåŠŸåŠ è½½ ${posts.length} æ¡å¸–å­`, 'success')
                
            } catch (error) {
                console.error('âŒ åŠ è½½å¸–å­å¼‚å¸¸:', error)
                showStatus(`åŠ è½½å¼‚å¸¸: ${error.message}`, 'error')
            } finally {
                isLoading = false
                document.getElementById('loadBtn').disabled = false
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            showStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'loading')
            
            try {
                const { data, error } = await supabase
                    .from('community_posts')
                    .select('count', { count: 'exact' })
                
                if (error) {
                    showStatus(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                } else {
                    showStatus(`è¿æ¥æˆåŠŸï¼å…±æœ‰ ${data[0].count} æ¡å¸–å­`, 'success')
                }
            } catch (error) {
                showStatus(`è¿æ¥æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error')
            }
        }

        // æ£€æŸ¥RLSç­–ç•¥
        async function checkRLS() {
            showStatus('æ­£åœ¨æ£€æŸ¥RLSç­–ç•¥...', 'loading')
            
            try {
                const { data, error } = await supabase
                    .from('community_posts')
                    .select('id, title')
                    .limit(1)
                
                if (error) {
                    if (error.code === '42501' || error.message.includes('permission')) {
                        showStatus('RLSç­–ç•¥é˜»æ­¢äº†åŒ¿åè®¿é—®ï¼Œéœ€è¦ä¿®æ”¹ç­–ç•¥', 'error')
                    } else {
                        showStatus(`RLSæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error')
                    }
                } else {
                    showStatus('RLSç­–ç•¥å…è®¸åŒ¿åè®¿é—®', 'success')
                }
            } catch (error) {
                showStatus(`RLSæ£€æŸ¥å¼‚å¸¸: ${error.message}`, 'error')
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            showStatus('é¡µé¢åŠ è½½å®Œæˆï¼ŒSupabaseå®¢æˆ·ç«¯å·²åˆå§‹åŒ–', 'success')
            setTimeout(loadPosts, 1000) // 1ç§’åè‡ªåŠ¨åŠ è½½å¸–å­
        }
    </script>
</body>
</html>