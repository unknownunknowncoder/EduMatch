<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®å¯¼å‡ºæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .log-container {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">æ•°æ®åº“å¯¼å‡ºæµ‹è¯•</h1>
        
        <div class="grid grid-cols-2 gap-6">
            <!-- æµ‹è¯•æ§åˆ¶ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">æµ‹è¯•æ§åˆ¶</h2>
                
                <div class="space-y-4">
                    <button id="testConnection" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        æµ‹è¯•æ•°æ®åº“è¿æ¥
                    </button>
                    
                    <button id="testUsers" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        æµ‹è¯•è·å–ç”¨æˆ·æ•°æ®
                    </button>
                    
                    <button id="testPosts" class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        æµ‹è¯•è·å–å¸–å­æ•°æ®
                    </button>
                    
                    <button id="testPlans" class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                        æµ‹è¯•è·å–å­¦ä¹ è®¡åˆ’
                    </button>
                    
                    <button id="testResources" class="w-full bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                        æµ‹è¯•è·å–å­¦ä¹ èµ„æº
                    </button>
                    
                    <button id="exportAll" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-bold">
                        å¯¼å‡ºå®Œæ•´æ•°æ®åˆ°Excel
                    </button>
                </div>
                
                <!-- æ•°æ®ç»Ÿè®¡ -->
                <div class="mt-6 p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">æ•°æ®ç»Ÿè®¡</h3>
                    <div class="space-y-1 text-sm">
                        <div>ç”¨æˆ·æ•°é‡: <span id="userCount" class="font-bold">-</span></div>
                        <div>å¸–å­æ•°é‡: <span id="postCount" class="font-bold">-</span></div>
                        <div>è®¡åˆ’æ•°é‡: <span id="planCount" class="font-bold">-</span></div>
                        <div>èµ„æºæ•°é‡: <span id="resourceCount" class="font-bold">-</span></div>
                    </div>
                </div>
            </div>
            
            <!-- æ—¥å¿—è¾“å‡º -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">æµ‹è¯•æ—¥å¿—</h2>
                <div id="logOutput" class="log-container bg-gray-900 text-green-400 p-4 rounded text-sm">
                    ç­‰å¾…æµ‹è¯•å¼€å§‹...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿ Supabase å®¢æˆ·ç«¯
        const SUPABASE_URL = 'https://your-supabase-url.supabase.co'
        const SUPABASE_ANON_KEY = 'your-anon-key'
        
        let logElement = document.getElementById('logOutput')
        let exportData = {
            users: [],
            posts: [],
            plans: [],
            resources: []
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const colors = {
                info: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                success: '#22c55e'
            }
            
            const logEntry = `[${timestamp}] ${message}\n`
            logElement.innerHTML += logEntry
            logElement.scrollTop = logElement.scrollHeight
            console.log(message)
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('userCount').textContent = exportData.users.length
            document.getElementById('postCount').textContent = exportData.posts.length  
            document.getElementById('planCount').textContent = exportData.plans.length
            document.getElementById('resourceCount').textContent = exportData.resources.length
        }
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        document.getElementById('testConnection').addEventListener('click', async () => {
            log('ğŸ”„ æµ‹è¯•æ•°æ®åº“è¿æ¥...')
            try {
                // è¿™é‡Œåº”è¯¥è¿æ¥çœŸå®çš„Supabase
                // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
                log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ (æ¨¡æ‹Ÿ)', 'success')
            } catch (error) {
                log(`âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`, 'error')
            }
        })
        
        // è·å–ç”¨æˆ·æ•°æ®
        document.getElementById('testUsers').addEventListener('click', async () => {
            log('ğŸ“¥ æ­£åœ¨è·å–ç”¨æˆ·æ•°æ®...')
            try {
                // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
                exportData.users = [
                    {
                        id: '1',
                        username: 'admin',
                        nickname: 'ç®¡ç†å‘˜',
                        email: 'admin@example.com',
                        avatar_url: 'https://example.com/avatar.jpg',
                        is_banned: false,
                        created_at: '2024-01-01T00:00:00Z',
                        last_login_at: '2024-12-06T10:00:00Z'
                    },
                    {
                        id: '2', 
                        username: 'user1',
                        nickname: 'ç”¨æˆ·1',
                        email: 'user1@example.com',
                        avatar_url: '',
                        is_banned: false,
                        created_at: '2024-02-01T00:00:00Z',
                        last_login_at: '2024-12-05T15:30:00Z'
                    }
                ]
                log(`âœ… ç”¨æˆ·æ•°æ®è·å–å®Œæˆ: ${exportData.users.length} æ¡`, 'success')
                updateStats()
            } catch (error) {
                log(`âŒ è·å–ç”¨æˆ·æ•°æ®å¤±è´¥: ${error.message}`, 'error')
            }
        })
        
        // è·å–å¸–å­æ•°æ®
        document.getElementById('testPosts').addEventListener('click', async () => {
            log('ğŸ“¥ æ­£åœ¨è·å–å¸–å­æ•°æ®...')
            try {
                // æ¨¡æ‹Ÿå¸–å­æ•°æ®
                exportData.posts = [
                    {
                        id: '1',
                        title: 'å¦‚ä½•é«˜æ•ˆå­¦ä¹ Vue.js',
                        content: 'Vue.jsæ˜¯ä¸€ä¸ªæ¸è¿›å¼JavaScriptæ¡†æ¶ï¼Œé€‚åˆæ„å»ºç”¨æˆ·ç•Œé¢...',
                        user_id: '1',
                        category: 'æŠ€æœ¯åˆ†äº«',
                        tags: ['Vue', 'å‰ç«¯', 'æ¡†æ¶'],
                        created_at: '2024-03-01T10:00:00Z',
                        updated_at: '2024-03-01T10:00:00Z',
                        status: 'published',
                        views: 150,
                        likes: 25,
                        comments_count: 8
                    },
                    {
                        id: '2',
                        title: 'å­¦ä¹ è®¡åˆ’åˆ¶å®šæŠ€å·§',
                        content: 'åˆ¶å®šä¸€ä¸ªå¥½çš„å­¦ä¹ è®¡åˆ’éœ€è¦è€ƒè™‘å¤šä¸ªå› ç´ ...',
                        user_id: '2',
                        category: 'å­¦ä¹ æ–¹æ³•',
                        tags: ['å­¦ä¹ ', 'è®¡åˆ’', 'æ•ˆç‡'],
                        created_at: '2024-03-02T14:00:00Z',
                        updated_at: '2024-03-02T14:00:00Z',
                        status: 'published',
                        views: 89,
                        likes: 12,
                        comments_count: 3
                    }
                ]
                log(`âœ… å¸–å­æ•°æ®è·å–å®Œæˆ: ${exportData.posts.length} æ¡`, 'success')
                updateStats()
            } catch (error) {
                log(`âŒ è·å–å¸–å­æ•°æ®å¤±è´¥: ${error.message}`, 'error')
            }
        })
        
        // è·å–å­¦ä¹ è®¡åˆ’æ•°æ®
        document.getElementById('testPlans').addEventListener('click', async () => {
            log('ğŸ“¥ æ­£åœ¨è·å–å­¦ä¹ è®¡åˆ’æ•°æ®...')
            try {
                // æ¨¡æ‹Ÿå­¦ä¹ è®¡åˆ’æ•°æ®
                exportData.plans = [
                    {
                        id: '1',
                        title: 'Vue.jsè¿›é˜¶å­¦ä¹ è®¡åˆ’',
                        description: 'æ·±å…¥å­¦ä¹ Vue.jsçš„é«˜çº§ç‰¹æ€§å’Œæœ€ä½³å®è·µï¼ŒåŒ…æ‹¬ç»„ä»¶é€šä¿¡ã€çŠ¶æ€ç®¡ç†ã€è·¯ç”±ç­‰æ ¸å¿ƒæ¦‚å¿µ...',
                        user_id: '1',
                        user: {
                            id: '1',
                            username: 'admin',
                            nickname: 'ç®¡ç†å‘˜'
                        },
                        created_at: '2024-01-15T00:00:00Z',
                        updated_at: '2024-02-01T00:00:00Z',
                        difficulty: 'è¿›é˜¶',
                        target_hours: 40,
                        progress: 65,
                        participants_count: 12,
                        status: 'è¿›è¡Œä¸­'
                    },
                    {
                        id: '2',
                        title: 'JavaScriptåŸºç¡€å¼ºåŒ–',
                        description: 'ä»é›¶å¼€å§‹å­¦ä¹ JavaScriptç¼–ç¨‹è¯­è¨€çš„åŸºç¡€çŸ¥è¯†å’Œè¯­æ³•...',
                        user_id: '2',
                        user: {
                            id: '2',
                            username: 'user1',
                            nickname: 'ç”¨æˆ·1'
                        },
                        created_at: '2024-02-01T00:00:00Z',
                        updated_at: '2024-02-15T00:00:00Z',
                        difficulty: 'åŸºç¡€',
                        target_hours: 20,
                        progress: 80,
                        participants_count: 8,
                        status: 'è¿›è¡Œä¸­'
                    }
                ]
                log(`âœ… å­¦ä¹ è®¡åˆ’æ•°æ®è·å–å®Œæˆ: ${exportData.plans.length} æ¡`, 'success')
                updateStats()
            } catch (error) {
                log(`âŒ è·å–å­¦ä¹ è®¡åˆ’æ•°æ®å¤±è´¥: ${error.message}`, 'error')
            }
        })
        
        // è·å–å­¦ä¹ èµ„æºæ•°æ®
        document.getElementById('testResources').addEventListener('click', async () => {
            log('ğŸ“¥ æ­£åœ¨è·å–å­¦ä¹ èµ„æºæ•°æ®...')
            try {
                // æ¨¡æ‹Ÿå­¦ä¹ èµ„æºæ•°æ®
                exportData.resources = [
                    {
                        id: '1',
                        title: 'Vue.jså®˜æ–¹æ–‡æ¡£ä¸­æ–‡ç‰ˆ',
                        description: 'Vue.jså®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆæœ¬ï¼ŒåŒ…å«äº†å®Œæ•´çš„APIå‚è€ƒå’Œæ•™ç¨‹...',
                        file_type: 'PDF',
                        file_size: 5242880, // 5MB
                        created_by: '1',
                        created_at: '2024-01-10T00:00:00Z',
                        updated_at: '2024-01-10T00:00:00Z',
                        tags: ['Vue', 'æ–‡æ¡£', 'å®˜æ–¹'],
                        difficulty: 'åŸºç¡€',
                        view_count: 200,
                        download_count: 45,
                        favorite_count: 23,
                        status: 'æ­£å¸¸'
                    },
                    {
                        id: '2',
                        title: 'JavaScripté«˜çº§ç¼–ç¨‹è§†é¢‘æ•™ç¨‹',
                        description: 'æ·±å…¥è®²è§£JavaScripté«˜çº§ç‰¹æ€§çš„è§†é¢‘æ•™ç¨‹ç³»åˆ—...',
                        file_type: 'MP4',
                        file_size: 104857600, // 100MB
                        created_by: '2',
                        created_at: '2024-02-05T00:00:00Z',
                        updated_at: '2024-02-05T00:00:00Z',
                        tags: ['JavaScript', 'è§†é¢‘', 'é«˜çº§'],
                        difficulty: 'é«˜çº§',
                        view_count: 150,
                        download_count: 30,
                        favorite_count: 18,
                        status: 'æ­£å¸¸'
                    }
                ]
                log(`âœ… å­¦ä¹ èµ„æºæ•°æ®è·å–å®Œæˆ: ${exportData.resources.length} æ¡`, 'success')
                updateStats()
            } catch (error) {
                log(`âŒ è·å–å­¦ä¹ èµ„æºæ•°æ®å¤±è´¥: ${error.message}`, 'error')
            }
        })
        
        // å¯¼å‡ºExcel
        document.getElementById('exportAll').addEventListener('click', () => {
            log('ğŸ”„ å¼€å§‹ç”ŸæˆåŒ…å«å¤šä¸ªå·¥ä½œè¡¨çš„ Excel æ–‡ä»¶...')
            
            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new()
                
                // å‡†å¤‡å·¥ä½œè¡¨æ•°æ®
                const sheets = {
                    'ç”¨æˆ·æ•°æ®': exportData.users.map((user, index) => ({
                        åºå·: index + 1,
                        ç”¨æˆ·ID: user.id,
                        ç”¨æˆ·å: user.username || 'æœªçŸ¥',
                        æ˜µç§°: user.nickname || 'æœªè®¾ç½®',
                        é‚®ç®±: user.email || 'æœªè®¾ç½®',
                        å¤´åƒåœ°å€: user.avatar_url || 'æœªè®¾ç½®',
                        ç”¨æˆ·çŠ¶æ€: user.is_banned ? 'å·²ç¦ç”¨' : 'æ­£å¸¸',
                        æ³¨å†Œæ—¶é—´: user.created_at || 'æœªçŸ¥',
                        æœ€åç™»å½•: user.last_login_at || 'ä»æœªç™»å½•'
                    })),
                    'æ–‡ç« å†…å®¹': exportData.posts.map((post, index) => ({
                        åºå·: index + 1,
                        å¸–å­ID: post.id,
                        æ ‡é¢˜: post.title || 'æ— æ ‡é¢˜',
                        å†…å®¹: post.content ? (post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content) : 'æ— å†…å®¹',
                        ä½œè€…ID: post.user_id || 'æœªçŸ¥',
                        åˆ†ç±»: post.category || 'æœªåˆ†ç±»',
                        æ ‡ç­¾: post.tags ? post.tags.join(', ') : 'æ— æ ‡ç­¾',
                        å‘å¸ƒæ—¶é—´: post.created_at || 'æœªçŸ¥',
                        æ›´æ–°æ—¶é—´: post.updated_at || 'æœªçŸ¥',
                        çŠ¶æ€: post.status || 'è‰ç¨¿',
                        æµè§ˆé‡: post.views || 0,
                        ç‚¹èµæ•°: post.likes || 0,
                        è¯„è®ºæ•°: post.comments_count || 0
                    })),
                    'å­¦ä¹ è®¡åˆ’': exportData.plans.map((plan, index) => ({
                        åºå·: index + 1,
                        è®¡åˆ’ID: plan.id,
                        è®¡åˆ’åç§°: plan.title || 'æœªå‘½å',
                        è®¡åˆ’æè¿°: plan.description ? (plan.description.length > 100 ? plan.description.substring(0, 100) + '...' : plan.description) : 'æ— æè¿°',
                        åˆ›å»ºè€…ID: plan.user_id || 'æœªçŸ¥',
                        åˆ›å»ºè€…ç”¨æˆ·å: plan.user?.username || 'æœªçŸ¥',
                        åˆ›å»ºè€…æ˜µç§°: plan.user?.nickname || 'æœªè®¾ç½®',
                        åˆ›å»ºæ—¶é—´: plan.created_at || 'æœªçŸ¥',
                        æ›´æ–°æ—¶é—´: plan.updated_at || 'æœªçŸ¥',
                        éš¾åº¦ç­‰çº§: plan.difficulty || 'ä¸­ç­‰',
                        ç›®æ ‡æ—¶é•¿: plan.target_hours || 'æœªçŸ¥',
                        å®Œæˆè¿›åº¦: `${plan.progress || 0}%`,
                        å‚ä¸äººæ•°: plan.participants_count || 0,
                        çŠ¶æ€: plan.status || 'è¿›è¡Œä¸­'
                    })),
                    'èµ„æºæ•°æ®': exportData.resources.map((resource, index) => ({
                        åºå·: index + 1,
                        èµ„æºID: resource.id,
                        èµ„æºæ ‡é¢˜: resource.title || 'æœªå‘½å',
                        èµ„æºæè¿°: resource.description ? (resource.description.length > 100 ? resource.description.substring(0, 100) + '...' : resource.description) : 'æ— æè¿°',
                        èµ„æºç±»å‹: resource.file_type || 'æœªçŸ¥',
                        æ–‡ä»¶å¤§å°: resource.file_size ? `${(resource.file_size / 1024 / 1024).toFixed(2)} MB` : 'æœªçŸ¥',
                        åˆ›å»ºè€…ID: resource.created_by || 'æœªçŸ¥',
                        åˆ›å»ºæ—¶é—´: resource.created_at || 'æœªçŸ¥',
                        æ›´æ–°æ—¶é—´: resource.updated_at || 'æœªçŸ¥',
                        åˆ†ç±»æ ‡ç­¾: resource.tags ? resource.tags.join(', ') : 'æ— æ ‡ç­¾',
                        éš¾åº¦ç­‰çº§: resource.difficulty || 'ä¸­ç­‰',
                        æµè§ˆæ¬¡æ•°: resource.view_count || 0,
                        ä¸‹è½½æ¬¡æ•°: resource.download_count || 0,
                        æ”¶è—æ¬¡æ•°: resource.favorite_count || 0,
                        çŠ¶æ€: resource.status || 'æ­£å¸¸'
                    }))
                }
                
                // æ·»åŠ ç³»ç»Ÿä¿¡æ¯å·¥ä½œè¡¨
                const systemInfoData = [
                    { é¡¹ç›®: 'å¯¼å‡ºæ—¶é—´', å€¼: new Date().toLocaleString('zh-CN') },
                    { é¡¹ç›®: 'ç³»ç»Ÿç‰ˆæœ¬', å€¼: 'EduMatch v1.0.0' },
                    { é¡¹ç›®: 'å¯¼å‡ºäºº', å€¼: 'ç®¡ç†å‘˜' },
                    { é¡¹ç›®: 'ç”¨æˆ·æ€»æ•°', å€¼: exportData.users.length },
                    { é¡¹ç›®: 'æ–‡ç« æ€»æ•°', å€¼: exportData.posts.length },
                    { é¡¹ç›®: 'è®¡åˆ’æ€»æ•°', å€¼: exportData.plans.length },
                    { é¡¹ç›®: 'èµ„æºæ€»æ•°', å€¼: exportData.resources.length }
                ]
                sheets['ç³»ç»Ÿä¿¡æ¯'] = systemInfoData
                
                // ä¸ºæ¯ä¸ªå·¥ä½œè¡¨åˆ›å»ºå·¥ä½œè¡¨å¹¶æ·»åŠ åˆ°å·¥ä½œç°¿
                Object.entries(sheets).forEach(([sheetName, data]) => {
                    if (!data || data.length === 0) {
                        log(`âš ï¸ ${sheetName} æš‚æ— æ•°æ®ï¼Œåˆ›å»ºç©ºå·¥ä½œè¡¨`, 'warning')
                        const emptySheet = XLSX.utils.aoa_to_sheet([[`${sheetName} (æš‚æ— æ•°æ®)`]])
                        XLSX.utils.book_append_sheet(wb, emptySheet, sheetName)
                        return
                    }
                    
                    log(`ğŸ“Š æ­£åœ¨å¤„ç† ${sheetName}: ${data.length} æ¡è®°å½•`)
                    
                    const ws = XLSX.utils.json_to_sheet(data, {
                        header: Object.keys(data[0]),
                        skipHeader: false
                    })
                    
                    // è®¾ç½®åˆ—å®½ä»¥ä¼˜åŒ–æ˜¾ç¤º
                    const colWidths = Object.keys(data[0]).map(key => {
                        let maxWidth = key.length
                        data.forEach(row => {
                            const value = String(row[key] || '')
                            maxWidth = Math.max(maxWidth, value.length)
                        })
                        return { width: Math.min(maxWidth + 2, 50) }
                    })
                    ws['!cols'] = colWidths
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName)
                })
                
                // ç”Ÿæˆ Excel æ–‡ä»¶
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')
                const excelFilename = `EduMatch_å®Œæ•´æ•°æ®å¯¼å‡º_${timestamp}.xlsx`
                
                XLSX.writeFile(wb, excelFilename, {
                    bookType: 'xlsx',
                    type: 'binary'
                })
                
                log(`âœ… Excel æ–‡ä»¶å·²ç”Ÿæˆ: ${excelFilename}`, 'success')
                log(`ğŸ“Š å¯¼å‡ºç»Ÿè®¡: ç”¨æˆ·${exportData.users.length}äººã€å¸–å­${exportData.posts.length}ç¯‡ã€è®¡åˆ’${exportData.plans.length}ä¸ªã€èµ„æº${exportData.resources.length}ä¸ª`)
                log(`ğŸ‰ Excel æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼åŒ…å« ${Object.keys(sheets).length} ä¸ªå·¥ä½œè¡¨ï¼Œæ•°æ®æ’ç‰ˆæ•´é½ç¾è§‚ã€‚`, 'success')
                
            } catch (error) {
                log(`âŒ Excel æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error')
            }
        })
        
        // åˆå§‹åŒ–
        log('ğŸš€ æ•°æ®å¯¼å‡ºæµ‹è¯•é¡µé¢å·²åŠ è½½')
        log('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•å„é¡¹åŠŸèƒ½')
    </script>
</body>
</html>