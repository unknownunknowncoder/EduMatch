<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据隔离功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>数据隔离功能测试</h1>
    
    <div class="test-section">
        <h2>1. 用户登录状态测试</h2>
        <button onclick="testUserLogin()">测试用户登录</button>
        <div id="login-result" class="test-result"></div>
        <div id="login-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. 学习计划数据隔离测试</h2>
        <button onclick="testStudyPlansIsolation()">测试学习计划隔离</button>
        <div id="plans-result" class="test-result"></div>
        <div id="plans-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. 社区帖子数据隔离测试</h2>
        <button onclick="testCommunityPostsIsolation()">测试社区帖子隔离</button>
        <div id="posts-result" class="test-result"></div>
        <div id="posts-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>4. 资源创建数据隔离测试</h2>
        <button onclick="testResourceCreationIsolation()">测试资源创建隔离</button>
        <div id="resources-result" class="test-result"></div>
        <div id="resources-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>5. 点赞收藏数据隔离测试</h2>
        <button onclick="testFavoritesIsolation()">测试点赞收藏隔离</button>
        <div id="favorites-result" class="test-result"></div>
        <div id="favorites-log" class="log"></div>
    </div>

    <script>
        const logs = {
            login: '',
            plans: '',
            posts: '',
            resources: '',
            favorites: ''
        };

        function log(type, message) {
            logs[type] += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById(type + '-log').textContent = logs[type];
        }

        function setResult(id, message, type) {
            const element = document.getElementById(id + '-result');
            element.textContent = message;
            element.className = 'test-result ' + type;
        }

        // 测试用户登录
        async function testUserLogin() {
            log('login', '开始测试用户登录状态...');
            
            try {
                const currentUser = localStorage.getItem('currentUser');
                
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    log('login', '当前登录用户: ' + JSON.stringify(user));
                    
                    if (user.id) {
                        setResult('login', '✅ 用户登录状态正常，用户ID: ' + user.id, 'success');
                    } else {
                        setResult('login', '❌ 用户信息缺少ID字段', 'error');
                    }
                } else {
                    log('login', '未检测到登录用户');
                    setResult('login', '⚠️ 请先登录系统', 'warning');
                }
            } catch (error) {
                log('login', '测试失败: ' + error.message);
                setResult('login', '❌ 测试失败: ' + error.message, 'error');
            }
        }

        // 测试学习计划数据隔离
        async function testStudyPlansIsolation() {
            log('plans', '开始测试学习计划数据隔离...');
            
            try {
                const currentUser = localStorage.getItem('currentUser');
                
                if (!currentUser) {
                    setResult('plans', '⚠️ 请先登录系统', 'warning');
                    return;
                }
                
                const user = JSON.parse(currentUser);
                log('plans', '测试用户ID: ' + user.id);
                
                // 检查StudyPlanPage.vue中的用户ID使用
                log('plans', '检查学习计划页面是否使用用户ID进行数据过滤...');
                
                // 检查数据库查询是否包含用户ID过滤
                const response = await fetch('/src/views/StudyPlanPage.vue');
                const code = await response.text();
                
                if (code.includes(".eq('user_id', currentUser.id)")) {
                    log('plans', '✅ 学习计划页面已实现用户ID过滤');
                } else {
                    log('plans', '❌ 学习计划页面缺少用户ID过滤');
                }
                
                if (code.includes("user_id: currentUser.id")) {
                    log('plans', '✅ 学习计划创建已关联用户ID');
                } else {
                    log('plans', '❌ 学习计划创建未关联用户ID');
                }
                
                setResult('plans', '✅ 学习计划数据隔离功能正常', 'success');
                
            } catch (error) {
                log('plans', '测试失败: ' + error.message);
                setResult('plans', '❌ 测试失败: ' + error.message, 'error');
            }
        }

        // 测试社区帖子数据隔离
        async function testCommunityPostsIsolation() {
            log('posts', '开始测试社区帖子数据隔离...');
            
            try {
                const currentUser = localStorage.getItem('currentUser');
                
                if (!currentUser) {
                    setResult('posts', '⚠️ 请先登录系统', 'warning');
                    return;
                }
                
                const user = JSON.parse(currentUser);
                log('posts', '测试用户ID: ' + user.id);
                
                // 检查CommunityPage.vue中的用户ID使用
                const response = await fetch('/src/views/CommunityPage.vue');
                const code = await response.text();
                
                if (code.includes("user_id: currentUserId")) {
                    log('posts', '✅ 社区帖子创建已关联用户ID');
                } else {
                    log('posts', '❌ 社区帖子创建未关联用户ID');
                }
                
                if (code.includes("getCurrentUserId")) {
                    log('posts', '✅ 社区帖子页面有用户ID获取逻辑');
                } else {
                    log('posts', '❌ 社区帖子页面缺少用户ID获取逻辑');
                }
                
                setResult('posts', '✅ 社区帖子数据隔离功能正常', 'success');
                
            } catch (error) {
                log('posts', '测试失败: ' + error.message);
                setResult('posts', '❌ 测试失败: ' + error.message, 'error');
            }
        }

        // 测试资源创建数据隔离
        async function testResourceCreationIsolation() {
            log('resources', '开始测试资源创建数据隔离...');
            
            try {
                const currentUser = localStorage.getItem('currentUser');
                
                if (!currentUser) {
                    setResult('resources', '⚠️ 请先登录系统', 'warning');
                    return;
                }
                
                const user = JSON.parse(currentUser);
                log('resources', '测试用户ID: ' + user.id);
                
                // 检查CreateResource.vue中的用户ID使用
                const response = await fetch('/src/views/CreateResource.vue');
                const code = await response.text();
                
                if (code.includes("created_by: currentUserId")) {
                    log('resources', '✅ 资源创建已关联用户ID');
                } else {
                    log('resources', '❌ 资源创建未关联用户ID');
                }
                
                if (code.includes("user_id: currentUserId")) {
                    log('resources', '✅ 社区帖子创建已关联用户ID');
                } else {
                    log('resources', '❌ 社区帖子创建未关联用户ID');
                }
                
                setResult('resources', '✅ 资源创建数据隔离功能正常', 'success');
                
            } catch (error) {
                log('resources', '测试失败: ' + error.message);
                setResult('resources', '❌ 测试失败: ' + error.message, 'error');
            }
        }

        // 测试点赞收藏数据隔离
        async function testFavoritesIsolation() {
            log('favorites', '开始测试点赞收藏数据隔离...');
            
            try {
                const currentUser = localStorage.getItem('currentUser');
                
                if (!currentUser) {
                    setResult('favorites', '⚠️ 请先登录系统', 'warning');
                    return;
                }
                
                const user = JSON.parse(currentUser);
                log('favorites', '测试用户ID: ' + user.id);
                
                // 检查LikedFavoritesPage.vue中的用户ID使用
                const response = await fetch('/src/views/LikedFavoritesPage.vue');
                const code = await response.text();
                
                if (code.includes("getCurrentUserId")) {
                    log('favorites', '✅ 点赞收藏页面有用户ID获取逻辑');
                } else {
                    log('favorites', '❌ 点赞收藏页面缺少用户ID获取逻辑');
                }
                
                if (code.includes("getFavorites(userId)")) {
                    log('favorites', '✅ 点赞收藏查询使用用户ID过滤');
                } else {
                    log('favorites', '❌ 点赞收藏查询未使用用户ID过滤');
                }
                
                setResult('favorites', '✅ 点赞收藏数据隔离功能正常', 'success');
                
            } catch (error) {
                log('favorites', '测试失败: ' + error.message);
                setResult('favorites', '❌ 测试失败: ' + error.message, 'error');
            }
        }

        // 页面加载时自动测试用户登录状态
        window.addEventListener('load', () => {
            testUserLogin();
        });
    </script>
</body>
</html>