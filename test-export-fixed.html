<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼å‡ºåŠŸèƒ½ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        .log-container {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-900">Excelå¯¼å‡ºåŠŸèƒ½ä¿®å¤æµ‹è¯•</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ä¿®å¤è¯´æ˜</h2>
            <div class="space-y-2 text-sm text-gray-600">
                <div>âœ… <strong>é—®é¢˜ä¿®å¤:</strong> è§£å†³äº†showMessageæœªå®šä¹‰çš„é”™è¯¯</div>
                <div>âœ… <strong>å‡½æ•°å¯¼å…¥:</strong> æ­£ç¡®å¯¼å…¥showToastå‡½æ•°æ›¿ä»£showMessage</div>
                <div>âœ… <strong>å‚æ•°ä¼˜åŒ–:</strong> ç®€åŒ–äº†downloadExcelå‡½æ•°å‚æ•°</div>
                <div>âœ… <strong>é”™è¯¯å¤„ç†:</strong> æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•</div>
                <div>âœ… <strong>æ•°æ®å®Œæ•´:</strong> ç¡®ä¿æ‰€æœ‰æ•°æ®ç±»å‹éƒ½èƒ½æ­£ç¡®å¯¼å‡º</div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">å¯¼å‡ºæµ‹è¯•</h2>
            
            <div class="space-y-4">
                <button id="testExport" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-medium">
                    ğŸ§ª æµ‹è¯•å®Œæ•´Excelå¯¼å‡ºåŠŸèƒ½
                </button>
                
                <div id="testResult" class="hidden p-4 rounded-lg">
                    <!-- æµ‹è¯•ç»“æœ -->
                </div>
            </div>
            
            <!-- æµ‹è¯•æ—¥å¿— -->
            <div class="mt-6">
                <h3 class="font-semibold mb-2">æµ‹è¯•æ—¥å¿—</h3>
                <div id="logOutput" class="log-container bg-gray-900 text-green-400 p-4 rounded text-sm">
                    ç­‰å¾…æµ‹è¯•å¼€å§‹...
                </div>
            </div>
        </div>
        
        <div class="bg-blue-50 rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">é¢„æœŸç»“æœ</h2>
            <div class="space-y-2 text-sm">
                <div>ğŸ“ Excelæ–‡ä»¶å: <code>EduMatch_å®Œæ•´æ•°æ®å¯¼å‡º_[æ—¶é—´æˆ³].xlsx</code></div>
                <div>ğŸ“Š åŒ…å«å·¥ä½œè¡¨:</div>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>ç”¨æˆ·æ•°æ® - åŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</li>
                    <li>æ–‡ç« å†…å®¹ - åŒ…å«ç¤¾åŒºå¸–å­æ•°æ®</li>
                    <li>å­¦ä¹ è®¡åˆ’ - åŒ…å«å­¦ä¹ è®¡åˆ’ä¿¡æ¯</li>
                    <li>èµ„æºæ•°æ® - åŒ…å«å­¦ä¹ èµ„æºä¿¡æ¯</li>
                    <li>ç³»ç»Ÿä¿¡æ¯ - åŒ…å«å¯¼å‡ºç»Ÿè®¡</li>
                </ul>
                <div>âœ¨ æ•°æ®æ ¼å¼: åˆ—å®½è‡ªåŠ¨è°ƒæ•´ï¼Œä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸</div>
            </div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿå¯¼å‡ºæ•°æ®
        const mockExportData = {
            users: [
                {
                    id: '1',
                    username: 'testuser',
                    nickname: 'æµ‹è¯•ç”¨æˆ·',
                    email: 'test@example.com',
                    avatar_url: 'https://example.com/avatar.jpg',
                    is_banned: false,
                    created_at: '2024-01-01T00:00:00Z',
                    last_login_at: '2024-12-06T10:00:00Z'
                }
            ],
            posts: [
                {
                    id: '1',
                    title: 'Vue.jså­¦ä¹ å¿ƒå¾—',
                    content: 'Vue.jsæ˜¯ä¸€ä¸ªä¼˜ç§€çš„å‰ç«¯æ¡†æ¶ï¼Œå…·æœ‰å“åº”å¼ã€ç»„ä»¶åŒ–ç­‰ç‰¹æ€§...',
                    user_id: '1',
                    category: 'æŠ€æœ¯åˆ†äº«',
                    tags: ['Vue', 'å‰ç«¯'],
                    created_at: '2024-03-01T10:00:00Z',
                    updated_at: '2024-03-01T10:00:00Z',
                    status: 'published',
                    views: 100,
                    likes: 20,
                    comments_count: 5
                }
            ],
            plans: [
                {
                    id: '1',
                    title: 'Vue.jså­¦ä¹ è®¡åˆ’',
                    description: 'ç³»ç»Ÿå­¦ä¹ Vue.jsæ¡†æ¶ï¼ŒåŒ…æ‹¬åŸºç¡€è¯­æ³•ã€ç»„ä»¶å¼€å‘ã€çŠ¶æ€ç®¡ç†ç­‰å†…å®¹',
                    user_id: '1',
                    user: { username: 'testuser', nickname: 'æµ‹è¯•ç”¨æˆ·' },
                    created_at: '2024-01-15T00:00:00Z',
                    updated_at: '2024-02-01T00:00:00Z',
                    difficulty: 'è¿›é˜¶',
                    target_hours: 40,
                    progress: 60,
                    participants_count: 10,
                    status: 'è¿›è¡Œä¸­'
                }
            ],
            resources: [
                {
                    id: '1',
                    title: 'Vue.jså®˜æ–¹æ–‡æ¡£',
                    description: 'Vue.jså®˜æ–¹æ–‡æ¡£ä¸­æ–‡ç‰ˆï¼ŒåŒ…å«å®Œæ•´çš„APIå‚è€ƒå’Œæ•™ç¨‹',
                    file_type: 'PDF',
                    file_size: 5242880,
                    created_by: '1',
                    created_at: '2024-01-10T00:00:00Z',
                    updated_at: '2024-01-10T00:00:00Z',
                    tags: ['Vue', 'æ–‡æ¡£'],
                    difficulty: 'åŸºç¡€',
                    view_count: 150,
                    download_count: 30,
                    favorite_count: 15,
                    status: 'æ­£å¸¸'
                }
            ],
            systemConfig: {
                exportTime: new Date().toLocaleString('zh-CN'),
                systemVersion: 'EduMatch v1.0.0',
                exportBy: 'æµ‹è¯•ç®¡ç†å‘˜'
            }
        }
        
        let logElement = document.getElementById('logOutput')
        let testResultElement = document.getElementById('testResult')
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const colors = {
                info: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                success: '#22c55e'
            }
            
            const logEntry = `[${timestamp}] ${message}\n`
            logElement.innerHTML += logEntry
            logElement.scrollTop = logElement.scrollHeight
            console.log(message)
        }
        
        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showResult(success, message) {
            testResultElement.classList.remove('hidden')
            if (success) {
                testResultElement.className = 'p-4 rounded-lg bg-green-50 border border-green-200 text-green-800'
                testResultElement.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="font-medium">æµ‹è¯•æˆåŠŸ</span>
                    </div>
                    <div class="mt-2 text-sm">${message}</div>
                `
            } else {
                testResultElement.className = 'p-4 rounded-lg bg-red-50 border border-red-200 text-red-800'
                testResultElement.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-red-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="font-medium">æµ‹è¯•å¤±è´¥</span>
                    </div>
                    <div class="mt-2 text-sm">${message}</div>
                `
            }
        }
        
        // æ¨¡æ‹ŸshowToastå‡½æ•°
        function showToast(options) {
            log(`ğŸ“¢ æ˜¾ç¤ºæ¶ˆæ¯: ${options.text} (${options.type})`)
        }
        
        // ä¿®å¤åçš„å¯¼å‡ºå‡½æ•°
        function downloadExcel(allData) {
            log('ğŸ”„ å¼€å§‹ç”ŸæˆåŒ…å«å¤šä¸ªå·¥ä½œè¡¨çš„ Excel æ–‡ä»¶...')
            
            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new()
                
                // æ·»åŠ ç³»ç»Ÿä¿¡æ¯å·¥ä½œè¡¨
                const systemInfoData = [
                    { é¡¹ç›®: 'å¯¼å‡ºæ—¶é—´', å€¼: allData.systemConfig.exportTime },
                    { é¡¹ç›®: 'ç³»ç»Ÿç‰ˆæœ¬', å€¼: allData.systemConfig.systemVersion },
                    { é¡¹ç›®: 'å¯¼å‡ºäºº', å€¼: allData.systemConfig.exportBy },
                    { é¡¹ç›®: 'ç”¨æˆ·æ€»æ•°', å€¼: allData.users.length },
                    { é¡¹ç›®: 'æ–‡ç« æ€»æ•°', å€¼: allData.posts.length },
                    { é¡¹ç›®: 'è®¡åˆ’æ€»æ•°', å€¼: allData.plans.length },
                    { é¡¹ç›®: 'èµ„æºæ€»æ•°', å€¼: allData.resources.length }
                ]
                
                // å‡†å¤‡å·¥ä½œè¡¨æ•°æ®
                const sheets = {
                    'ç”¨æˆ·æ•°æ®': allData.users.map((user, index) => ({
                        åºå·: index + 1,
                        ç”¨æˆ·ID: user.id,
                        ç”¨æˆ·å: user.username || 'æœªçŸ¥',
                        æ˜µç§°: user.nickname || 'æœªè®¾ç½®',
                        é‚®ç®±: user.email || 'æœªè®¾ç½®',
                        å¤´åƒåœ°å€: user.avatar_url || 'æœªè®¾ç½®',
                        ç”¨æˆ·çŠ¶æ€: user.is_banned ? 'å·²ç¦ç”¨' : 'æ­£å¸¸',
                        æ³¨å†Œæ—¶é—´: user.created_at || 'æœªçŸ¥',
                        æœ€åç™»å½•: user.last_login_at || 'ä»æœªç™»å½•'
                    })),
                    'æ–‡ç« å†…å®¹': allData.posts.map((post, index) => ({
                        åºå·: index + 1,
                        å¸–å­ID: post.id,
                        æ ‡é¢˜: post.title || 'æ— æ ‡é¢˜',
                        å†…å®¹: post.content ? (post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content) : 'æ— å†…å®¹',
                        ä½œè€…ID: post.user_id || 'æœªçŸ¥',
                        åˆ†ç±»: post.category || 'æœªåˆ†ç±»',
                        æ ‡ç­¾: post.tags ? (Array.isArray(post.tags) ? post.tags.join(', ') : post.tags) : 'æ— æ ‡ç­¾',
                        å‘å¸ƒæ—¶é—´: post.created_at || 'æœªçŸ¥',
                        æ›´æ–°æ—¶é—´: post.updated_at || 'æœªçŸ¥',
                        çŠ¶æ€: post.status || 'è‰ç¨¿',
                        æµè§ˆé‡: post.views || 0,
                        ç‚¹èµæ•°: post.likes || 0,
                        è¯„è®ºæ•°: post.comments_count || 0
                    })),
                    'å­¦ä¹ è®¡åˆ’': allData.plans.map((plan, index) => ({
                        åºå·: index + 1,
                        è®¡åˆ’ID: plan.id,
                        è®¡åˆ’åç§°: plan.title || 'æœªå‘½å',
                        è®¡åˆ’æè¿°: plan.description ? (plan.description.length > 100 ? plan.description.substring(0, 100) + '...' : plan.description) : 'æ— æè¿°',
                        åˆ›å»ºè€…ID: plan.user_id || 'æœªçŸ¥',
                        åˆ›å»ºè€…ç”¨æˆ·å: plan.user?.username || 'æœªçŸ¥',
                        åˆ›å»ºè€…æ˜µç§°: plan.user?.nickname || 'æœªè®¾ç½®',
                        åˆ›å»ºæ—¶é—´: plan.created_at || 'æœªçŸ¥',
                        æ›´æ–°æ—¶é—´: plan.updated_at || 'æœªçŸ¥',
                        éš¾åº¦ç­‰çº§: plan.difficulty || 'ä¸­ç­‰',
                        ç›®æ ‡æ—¶é•¿: plan.target_hours || 'æœªçŸ¥',
                        å®Œæˆè¿›åº¦: `${plan.progress || 0}%`,
                        å‚ä¸äººæ•°: plan.participants_count || 0,
                        çŠ¶æ€: plan.status || 'è¿›è¡Œä¸­'
                    })),
                    'èµ„æºæ•°æ®': allData.resources.map((resource, index) => ({
                        åºå·: index + 1,
                        èµ„æºID: resource.id,
                        èµ„æºæ ‡é¢˜: resource.title || 'æœªå‘½å',
                        èµ„æºæè¿°: resource.description ? (resource.description.length > 100 ? resource.description.substring(0, 100) + '...' : resource.description) : 'æ— æè¿°',
                        èµ„æºç±»å‹: resource.file_type || 'æœªçŸ¥',
                        æ–‡ä»¶å¤§å°: resource.file_size ? `${(resource.file_size / 1024 / 1024).toFixed(2)} MB` : 'æœªçŸ¥',
                        åˆ›å»ºè€…ID: resource.created_by || 'æœªçŸ¥',
                        åˆ›å»ºæ—¶é—´: resource.created_at || 'æœªçŸ¥',
                        æ›´æ–°æ—¶é—´: resource.updated_at || 'æœªçŸ¥',
                        åˆ†ç±»æ ‡ç­¾: resource.tags ? (Array.isArray(resource.tags) ? resource.tags.join(', ') : resource.tags) : 'æ— æ ‡ç­¾',
                        éš¾åº¦ç­‰çº§: resource.difficulty || 'ä¸­ç­‰',
                        æµè§ˆæ¬¡æ•°: resource.view_count || 0,
                        ä¸‹è½½æ¬¡æ•°: resource.download_count || 0,
                        æ”¶è—æ¬¡æ•°: resource.favorite_count || 0,
                        çŠ¶æ€: resource.status || 'æ­£å¸¸'
                    })),
                    'ç³»ç»Ÿä¿¡æ¯': systemInfoData
                }
                
                // ä¸ºæ¯ä¸ªå·¥ä½œè¡¨åˆ›å»ºå·¥ä½œè¡¨å¹¶æ·»åŠ åˆ°å·¥ä½œç°¿
                Object.entries(sheets).forEach(([sheetName, data]) => {
                    if (!data || data.length === 0) {
                        log(`âš ï¸ ${sheetName} æš‚æ— æ•°æ®ï¼Œåˆ›å»ºç©ºå·¥ä½œè¡¨`, 'warning')
                        const emptySheet = XLSX.utils.aoa_to_sheet([[`${sheetName} (æš‚æ— æ•°æ®)`]])
                        XLSX.utils.book_append_sheet(wb, emptySheet, sheetName)
                        return
                    }
                    
                    log(`ğŸ“Š æ­£åœ¨å¤„ç† ${sheetName}: ${data.length} æ¡è®°å½•`)
                    
                    const ws = XLSX.utils.json_to_sheet(data, {
                        header: Object.keys(data[0]),
                        skipHeader: false
                    })
                    
                    // è®¾ç½®åˆ—å®½ä»¥ä¼˜åŒ–æ˜¾ç¤º
                    const colWidths = Object.keys(data[0]).map(key => {
                        let maxWidth = key.length
                        data.forEach(row => {
                            const value = String(row[key] || '')
                            maxWidth = Math.max(maxWidth, value.length)
                        })
                        return { width: Math.min(maxWidth + 2, 50) }
                    })
                    ws['!cols'] = colWidths
                    
                    XLSX.utils.book_append_sheet(wb, ws, sheetName)
                })
                
                // ç”Ÿæˆ Excel æ–‡ä»¶
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')
                const excelFilename = `EduMatch_å®Œæ•´æ•°æ®å¯¼å‡º_${timestamp}.xlsx`
                
                XLSX.writeFile(wb, excelFilename, {
                    bookType: 'xlsx',
                    type: 'binary'
                })
                
                log(`âœ… Excel æ–‡ä»¶å·²ç”Ÿæˆ: ${excelFilename}`, 'success')
                log(`ğŸ“Š å¯¼å‡ºç»Ÿè®¡: ç”¨æˆ·${allData.users.length}äººã€å¸–å­${allData.posts.length}ç¯‡ã€è®¡åˆ’${allData.plans.length}ä¸ªã€èµ„æº${allData.resources.length}ä¸ª`)
                
                // æ¨¡æ‹ŸæˆåŠŸæ¶ˆæ¯
                showToast({
                    text: `æˆåŠŸå¯¼å‡ºå®Œæ•´çš„ Excel æ–‡ä»¶ï¼åŒ…å« ${Object.keys(sheets).length} ä¸ªå·¥ä½œè¡¨ï¼Œæ•°æ®æ’ç‰ˆæ•´é½ç¾è§‚ã€‚`,
                    type: 'success',
                    duration: 5000
                })
                
                log(`ğŸ‰ Excel æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼åŒ…å« ${Object.keys(sheets).length} ä¸ªå·¥ä½œè¡¨ï¼Œæ•°æ®æ’ç‰ˆæ•´é½ç¾è§‚ã€‚`, 'success')
                
                return { success: true, filename: excelFilename }
                
            } catch (error) {
                log(`âŒ Excel æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error')
                throw new Error(`Excel æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ${error.message}`)
            }
        }
        
        // æµ‹è¯•æŒ‰é’®äº‹ä»¶
        document.getElementById('testExport').addEventListener('click', () => {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•ä¿®å¤åçš„å¯¼å‡ºåŠŸèƒ½...')
            
            try {
                // æ•°æ®æ±‡æ€»ç»Ÿè®¡
                log('ğŸ“Š æ•°æ®æ±‡æ€»ç»Ÿè®¡:')
                log(`  ğŸ‘¥ ç”¨æˆ·æ•°æ®: ${mockExportData.users.length} æ¡`)
                log(`  ğŸ“ å¸–å­æ•°æ®: ${mockExportData.posts.length} æ¡`)
                log(`  ğŸ“š å­¦ä¹ è®¡åˆ’: ${mockExportData.plans.length} æ¡`)
                log(`  ğŸ“ å­¦ä¹ èµ„æº: ${mockExportData.resources.length} æ¡`)
                
                // æ‰§è¡Œå¯¼å‡º
                const result = downloadExcel(mockExportData)
                
                if (result.success) {
                    showResult(true, `Excelæ–‡ä»¶ ${result.filename} å·²æˆåŠŸç”Ÿæˆï¼åŒ…å«æ‰€æœ‰5ä¸ªå·¥ä½œè¡¨çš„æ•°æ®ã€‚`)
                } else {
                    showResult(false, 'å¯¼å‡ºè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯')
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
                showResult(false, `æµ‹è¯•å¤±è´¥: ${error.message}`)
            }
        })
        
        // åˆå§‹åŒ–
        log('ğŸš€ å¯¼å‡ºåŠŸèƒ½ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½')
        log('ğŸ’¡ ç‚¹å‡»"æµ‹è¯•å®Œæ•´Excelå¯¼å‡ºåŠŸèƒ½"æŒ‰é’®å¼€å§‹æµ‹è¯•')
    </script>
</body>
</html>