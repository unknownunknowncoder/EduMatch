<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex">
    <!-- ä¾§è¾¹æ  -->
    <aside 
      class="w-64 bg-white dark:bg-gray-800 shadow-lg admin-sidebar" 
      :style="{
        display: 'block !important',
        position: 'fixed !important',
        height: '100vh !important',
        left: '0 !important',
        top: '0 !important',
        zIndex: '50 !important',
        visibility: 'visible !important',
        opacity: '1 !important',
        width: '16rem !important'
      }"
    >
      <div class="h-full flex flex-col">
        <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
          <div class="flex items-center">
            <div class="p-2 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg">
              <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c-.94 1.543.826 3.31 2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c.94-1.543-.826-3.31-2.37-2.37a1.724 1.724 0 00-2.572-1.065c-.426-1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573 1.066c-1.543-.94-3.31.826-2.37 2.37a1.724 1.724 0 00-1.065 2.572c-1.756.426-1.756 2.924 0 3.35a1.724 1.724 0 001.066 2.573c-.94 1.543.826 3.31 2.37 2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
            </div>
            <div class="ml-3">
              <h2 class="text-lg font-bold text-gray-900 dark:text-white">ç®¡ç†ç³»ç»Ÿ</h2>
              <p class="text-xs text-gray-500 dark:text-gray-400">Admin Panel</p>
            </div>
          </div>
        </div>

        <!-- å¯¼èˆªèœå• -->
        <nav 
          class="flex-1 px-4 py-6 space-y-2 sidebar-nav"
          :style="{
            display: 'flex !important',
            flexDirection: 'column !important',
            visibility: 'visible !important',
            opacity: '1 !important',
            padding: '1rem 0 !important',
            gap: '0.5rem !important'
          }"
        >
          <!-- ä»ªè¡¨æ¿ -->
          <router-link
            to="/admin/dashboard"
            class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors sidebar-button"
            :class="route.path === '/admin' || route.path === '/admin/dashboard' 
              ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300' 
              : 'bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-300'"
            :style="{
              display: 'flex !important',
              alignItems: 'center !important',
              visibility: 'visible !important',
              opacity: '1 !important',
              minHeight: '2.75rem !important',
              width: '100% !important',
              padding: '0.75rem 1rem !important',
              textDecoration: 'none !important',
              fontSize: '0.875rem !important',
              fontWeight: '500 !important',
              borderRadius: '0.5rem !important',
              transition: 'all 0.2s ease !important'
            }"
          >
            <span class="mr-3 text-lg" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ğŸ“Š</span>
            <span style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ä»ªè¡¨æ¿</span>
          </router-link>

          <!-- ç”¨æˆ·ç®¡ç† -->
          <router-link
            to="/admin/users"
            class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors sidebar-button"
            :class="route.path.startsWith('/admin/users') 
              ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300' 
              : 'bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-300'"
            :style="{
              display: 'flex !important',
              alignItems: 'center !important',
              visibility: 'visible !important',
              opacity: '1 !important',
              minHeight: '2.75rem !important',
              width: '100% !important',
              padding: '0.75rem 1rem !important',
              textDecoration: 'none !important',
              fontSize: '0.875rem !important',
              fontWeight: '500 !important',
              borderRadius: '0.5rem !important',
              transition: 'all 0.2s ease !important'
            }"
          >
            <span class="mr-3 text-lg" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ğŸ‘¤</span>
            <span style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ç”¨æˆ·ç®¡ç†</span>
          </router-link>

          <!-- ç³»ç»Ÿè®¾ç½® -->
          <router-link
            to="/admin/settings"
            class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors sidebar-button"
            :class="route.path.startsWith('/admin/settings') 
              ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300' 
              : 'bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-300'"
            :style="{
              display: 'flex !important',
              alignItems: 'center !important',
              visibility: 'visible !important',
              opacity: '1 !important',
              minHeight: '2.75rem !important',
              width: '100% !important',
              padding: '0.75rem 1rem !important',
              textDecoration: 'none !important',
              fontSize: '0.875rem !important',
              fontWeight: '500 !important',
              borderRadius: '0.5rem !important',
              transition: 'all 0.2s ease !important'
            }"
          >
            <span class="mr-3 text-lg" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">âš™ï¸</span>
            <span style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ç³»ç»Ÿè®¾ç½®</span>
          </router-link>

          <!-- ç³»ç»Ÿç»´æŠ¤ -->
          <router-link
            to="/admin/maintenance"
            class="flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors sidebar-button"
            :class="route.path.startsWith('/admin/maintenance') 
              ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300' 
              : 'bg-gray-100 hover:bg-gray-200 text-gray-700 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-300'"
            :style="{
              display: 'flex !important',
              alignItems: 'center !important',
              visibility: 'visible !important',
              opacity: '1 !important',
              minHeight: '2.75rem !important',
              width: '100% !important',
              padding: '0.75rem 1rem !important',
              textDecoration: 'none !important',
              fontSize: '0.875rem !important',
              fontWeight: '500 !important',
              borderRadius: '0.5rem !important',
              transition: 'all 0.2s ease !important'
            }"
          >
            <span class="mr-3 text-lg" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ğŸ”§</span>
            <span style="display: inline-block !important; visibility: visible !important; opacity: 1 !important;">ç³»ç»Ÿç»´æŠ¤</span>
          </router-link>
        </nav>

        <!-- ä¾§è¾¹æ åº•éƒ¨ -->
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between w-full">
            <!-- å¤´åƒ -->
            <div class="h-8 w-8 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-bold text-white">
                {{ (currentUser?.nickname || 'A').charAt(0).toUpperCase() }}
              </span>
            </div>
            <!-- ç”¨æˆ·åå’Œæ—¶é—´åŒºåŸŸ -->
            <div class="ml-3 flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                {{ currentUser?.nickname || 'Admin' }}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 whitespace-nowrap mt-1">
                {{ currentTime }}
              </p>
            </div>
            <!-- é€€å‡ºæŒ‰é’® -->
            <button
              @click="logout"
              class="ml-2 p-2 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition-colors flex-shrink-0"
              title="é€€å‡ºç™»å½•"
            >
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </aside>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 overflow-auto" style="margin-left: 16rem;">
    <!-- ä»ªè¡¨æ¿å†…å®¹ -->
    <div v-if="route.path === '/admin' || route.path === '/admin/dashboard'" class="p-8">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ä»ªè¡¨æ¿</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">ç³»ç»Ÿæ¦‚è§ˆå’Œç»Ÿè®¡æ•°æ®</p>
        </div>

        <!-- ç¬¬ä¸€è¡Œï¼šç”¨æˆ·ç›¸å…³ç»Ÿè®¡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
              <div class="p-3 bg-blue-100 dark:bg-blue-900/20 rounded-lg">
                <span class="text-2xl">ğŸ‘¥</span>
              </div>
              <div class="ml-4 flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">æ€»ç”¨æˆ·æ•°</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.totalUsers }}</p>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">è¾ƒæ˜¨æ—¥ +{{ stats.userGrowth || 0 }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-center">
              <div class="p-3 bg-green-100 dark:bg-green-900/20 rounded-lg">
                <span class="text-2xl">âœ¨</span>
              </div>
              <div class="ml-4 flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ä»Šæ—¥æ–°å¢ç”¨æˆ·</p>
                <p class="text-2xl font-bold text-green-600 dark:text-green-400">{{ stats.newUsersToday || 0 }}</p>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">å¢é•¿ç‡ {{ stats.userGrowthRate || 0 }}%</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-red-500">
            <div class="flex items-center">
              <div class="p-3 bg-red-100 dark:bg-red-900/20 rounded-lg">
                <span class="text-2xl">ğŸš«</span>
              </div>
              <div class="ml-4 flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">å°ç¦ç”¨æˆ·</p>
                <p class="text-2xl font-bold text-red-600 dark:text-red-400">{{ stats.bannedUsers || 0 }}</p>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">å æ€»ç”¨æˆ· {{ ((stats.bannedUsers || 0) / stats.totalUsers * 100).toFixed(1) }}%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šå†…å®¹ç›¸å…³ç»Ÿè®¡ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-yellow-500">
            <div class="flex items-center">
              <div class="p-3 bg-yellow-100 dark:bg-yellow-900/20 rounded-lg">
                <span class="text-2xl">ğŸ“</span>
              </div>
              <div class="ml-4 flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">æ€»å¸–å­æ•°</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.totalPosts }}</p>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">ä»Šæ—¥æ–°å¢ +{{ stats.newPostsToday || 0 }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
              <div class="p-3 bg-purple-100 dark:bg-purple-900/20 rounded-lg">
                <span class="text-2xl">ğŸ“š</span>
              </div>
              <div class="ml-4 flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">æ€»å­¦ä¹ è®¡åˆ’æ•°</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.totalPlans }}</p>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">æ´»è·ƒè®¡åˆ’ {{ stats.activePlans || 0 }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border-l-4 border-orange-500">
            <div class="flex items-center">
              <div class="p-3 bg-orange-100 dark:bg-orange-900/20 rounded-lg">
                <span class="text-2xl">ğŸ“–</span>
              </div>
              <div class="ml-4 flex-1">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">æ€»å­¦ä¹ èµ„æºæ•°</p>
                <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.totalResources }}</p>
                <div class="mt-1">
                  <span class="text-xs text-gray-500 dark:text-gray-400">æœ¬æœˆæ–°å¢ +{{ stats.newResourcesThisMonth || 0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç»Ÿè®¡å›¾è¡¨ (ä»…åœ¨ä»ªè¡¨æ¿æ˜¾ç¤º) -->
        <div v-if="route.path === '/admin' || route.path === '/admin/dashboard'" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 md:mb-0">
              æ•°æ®è¶‹åŠ¿åˆ†æ
            </h3>
            
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="flex flex-col sm:flex-row gap-4">
              <!-- æ•°æ®ç±»å‹é€‰æ‹© -->
              <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">æ•°æ®ç±»å‹:</label>
                <select 
                  v-model="chartConfig.dataType"
                  @change="loadChartData"
                  class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                >
                  <option value="all">å…¨éƒ¨æ•°æ®</option>
                  <option value="new_users">æ–°å¢ç”¨æˆ·</option>
                  <option value="new_posts">æ–°å¢å¸–å­</option>
                  <option value="new_plans">æ–°å¢è®¡åˆ’</option>
                  <option value="new_resources">æ–°å¢èµ„æº</option>
                  <option value="total_users">ç´¯è®¡ç”¨æˆ·</option>
                  <option value="total_posts">ç´¯è®¡å¸–å­</option>
                  <option value="total_plans">ç´¯è®¡è®¡åˆ’</option>
                  <option value="total_resources">ç´¯è®¡èµ„æº</option>
                </select>
              </div>

              <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
              <div class="flex items-center space-x-2">
                <label class="text-sm font-medium text-gray-700 dark:text-gray-300">æ—¶é—´èŒƒå›´:</label>
                <select 
                  v-model="chartConfig.timeRange"
                  @change="loadChartData"
                  class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                >
                  <option value="7">è¿‘7å¤©</option>
                  <option value="30">è¿‘30å¤©</option>
                  <option value="60">è¿‘60å¤©</option>
                </select>
              </div>
            </div>
          </div>

          <!-- å›¾è¡¨å®¹å™¨ -->
          <div class="relative h-96">
            <div v-if="chartLoading" class="absolute inset-0 flex items-center justify-center bg-white dark:bg-gray-800 bg-opacity-75 z-10">
              <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="text-gray-600 dark:text-gray-400">åŠ è½½å›¾è¡¨æ•°æ®...</span>
              </div>
            </div>
            
            <!-- Canvas å§‹ç»ˆå­˜åœ¨ï¼Œä½†å¯èƒ½åœ¨åŠ è½½ä¸­ -->
            <canvas ref="chartCanvas" :class="{ 'opacity-50': chartLoading }"></canvas>
          </div>

          <!-- å›¾ä¾‹ -->
          <div class="mt-4 flex flex-wrap gap-4 text-sm" v-if="!chartLoading">
            <!-- ç”¨æˆ·ç›¸å…³å›¾ä¾‹ -->
            <div v-if="chartConfig.dataType === 'all' || chartConfig.dataType === 'new_users' || chartConfig.dataType === 'total_users'" class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
              <span class="text-gray-700 dark:text-gray-300">
                {{ chartConfig.dataType === 'new_users' ? 'æ–°å¢ç”¨æˆ·' : chartConfig.dataType === 'total_users' ? 'ç´¯è®¡ç”¨æˆ·' : 'æ–°å¢ç”¨æˆ·' }}
              </span>
            </div>
            
            <!-- å¸–å­ç›¸å…³å›¾ä¾‹ -->
            <div v-if="chartConfig.dataType === 'all' || chartConfig.dataType === 'new_posts' || chartConfig.dataType === 'total_posts'" class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-green-500 rounded-full"></div>
              <span class="text-gray-700 dark:text-gray-300">
                {{ chartConfig.dataType === 'new_posts' ? 'æ–°å¢å¸–å­' : chartConfig.dataType === 'total_posts' ? 'ç´¯è®¡å¸–å­' : 'æ–°å¢å¸–å­' }}
              </span>
            </div>
            
            <!-- è®¡åˆ’ç›¸å…³å›¾ä¾‹ -->
            <div v-if="chartConfig.dataType === 'all' || chartConfig.dataType === 'new_plans' || chartConfig.dataType === 'total_plans'" class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
              <span class="text-gray-700 dark:text-gray-300">
                {{ chartConfig.dataType === 'new_plans' ? 'æ–°å¢è®¡åˆ’' : chartConfig.dataType === 'total_plans' ? 'ç´¯è®¡è®¡åˆ’' : 'æ–°å¢è®¡åˆ’' }}
              </span>
            </div>
            
            <!-- èµ„æºç›¸å…³å›¾ä¾‹ -->
            <div v-if="chartConfig.dataType === 'all' || chartConfig.dataType === 'new_resources' || chartConfig.dataType === 'total_resources'" class="flex items-center space-x-2">
              <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
              <span class="text-gray-700 dark:text-gray-300">
                {{ chartConfig.dataType === 'new_resources' ? 'æ–°å¢èµ„æº' : chartConfig.dataType === 'total_resources' ? 'ç´¯è®¡èµ„æº' : 'æ–°å¢èµ„æº' }}
              </span>
            </div>
          </div>
        </div>

        
      </div>

      <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
      <div v-else-if="route.path.startsWith('/admin/users')" class="p-8">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ç”¨æˆ·ç®¡ç†</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">ç®¡ç†ç³»ç»Ÿç”¨æˆ·ã€æƒé™å’Œç›¸å…³ä¿¡æ¯</p>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç†å†…å®¹ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
          <div class="p-6">
            <UserManagement :key="'users'" @refresh="loadStats" @showConfirm="showConfirm" />
          </div>
        </div>
      </div>

      <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
      <div v-else-if="route.path.startsWith('/admin/settings')" class="p-8">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ç³»ç»Ÿè®¾ç½®</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">é…ç½®ç³»ç»Ÿå‚æ•°å’ŒåŠŸèƒ½é€‰é¡¹</p>
        </div>
        
        <!-- ç³»ç»Ÿè®¾ç½®å†…å®¹ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- åŸºæœ¬è®¾ç½® -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">åŸºæœ¬è®¾ç½®</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ç³»ç»ŸåŸºç¡€é…ç½®</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ç³»ç»Ÿåç§°</label>
                <input type="text" value="EduMatchç®¡ç†ç³»ç»Ÿ" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  readonly />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ç³»ç»Ÿç‰ˆæœ¬</label>
                <input type="text" value="v1.0.0" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"
                  readonly />
              </div>

            </div>
          </div>

          <!-- å®‰å…¨è®¾ç½® -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">å®‰å…¨è®¾ç½®</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ç³»ç»Ÿå®‰å…¨ç›¸å…³é…ç½®</p>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å¯†ç æœ€å°é•¿åº¦</label>
                <input type="number" value="6" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ç™»å½•å¤±è´¥é”å®šæ¬¡æ•°</label>
                <input type="number" value="5" 
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" />
              </div>

            </div>
          </div>



          <!-- è”ç³»å®¢æœ -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">è”ç³»å®¢æœ</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">å¦‚æœ‰é—®é¢˜è¯·è”ç³»å®¢æœè·å–å¸®åŠ©</p>
            </div>
            <div class="p-6 space-y-4">
              <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                  <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="text-sm font-medium text-gray-900 dark:text-white">å®¢æœç”µè¯</h4>
                  <p class="text-sm text-gray-600 dark:text-gray-400">17307070935</p>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                  <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <div>
                  <h4 class="text-sm font-medium text-gray-900 dark:text-white">å®¢æœé‚®ç®±</h4>
                  <p class="text-sm text-gray-600 dark:text-gray-400">zxq17307070935@163.com</p>
                </div>
              </div>
              <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-500 dark:text-gray-400 text-center">
                  å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-18:00
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- é¡¹ç›®è®¾ç½®è¯´æ˜ -->
        <div class="mt-8 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6">
          <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
              <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">EduMatch é¡¹ç›®è®¾ç½®è¯´æ˜</h3>
              <div class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                <div>
                  <h4 class="font-medium text-gray-900 dark:text-white mb-1">ğŸ“š ç³»ç»Ÿæ¦‚è¿°</h4>
                  <p class="text-gray-600 dark:text-gray-400">EduMatch æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åœ¨çº¿æ•™è‚²å­¦ä¹ å¹³å°ï¼Œæä¾›å­¦ä¹ è®¡åˆ’ç®¡ç†ã€èµ„æºåˆ†äº«ã€ç¤¾åŒºäº¤æµç­‰åŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨ Vue.js 3 + TypeScript + Supabase æŠ€æœ¯æ ˆæ„å»ºã€‚</p>
                </div>
                <div>
                  <h4 class="font-medium text-gray-900 dark:text-white mb-1">ğŸ”§ åŸºæœ¬è®¾ç½®</h4>
                  <p class="text-gray-600 dark:text-gray-400">åŸºæœ¬è®¾ç½®æ¨¡å—ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒé…ç½®ï¼ŒåŒ…æ‹¬ç³»ç»Ÿåç§°å’Œç‰ˆæœ¬ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯ç”¨äºç³»ç»Ÿæ ‡è¯†å’Œç‰ˆæœ¬ç®¡ç†ï¼Œå»ºè®®ä¿æŒç³»ç»Ÿåç§°ä¸å“ç‰Œå½¢è±¡ä¸€è‡´ã€‚</p>
                </div>
                <div>
                  <h4 class="font-medium text-gray-900 dark:text-white mb-1">ğŸ”’ å®‰å…¨è®¾ç½®</h4>
                  <p class="text-gray-600 dark:text-gray-400">å®‰å…¨è®¾ç½®ä¿éšœç³»ç»Ÿå’Œç”¨æˆ·æ•°æ®çš„å®‰å…¨ï¼ŒåŒ…æ‹¬å¯†ç å¤æ‚åº¦è¦æ±‚å’Œç™»å½•å¤±è´¥ä¿æŠ¤æœºåˆ¶ã€‚å»ºè®®è®¾ç½®åˆç†çš„å¯†ç é•¿åº¦å’Œç™»å½•å¤±è´¥é”å®šæ¬¡æ•°ã€‚</p>
                </div>
                <div>
                  <h4 class="font-medium text-gray-900 dark:text-white mb-1">ğŸ“ æŠ€æœ¯æ”¯æŒ</h4>
                  <p class="text-gray-600 dark:text-gray-400">å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–æœ‰ç³»ç»Ÿç›¸å…³é—®é¢˜ï¼Œè¯·é€šè¿‡å®¢æœç”µè¯æˆ–é‚®ç®±è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚æˆ‘ä»¬æä¾›å·¥ä½œæ—¥9:00-18:00çš„æŠ€æœ¯æ”¯æŒæœåŠ¡ã€‚</p>
                </div>
                <div class="pt-3 border-t border-blue-200 dark:border-blue-800">
                  <p class="text-xs text-gray-500 dark:text-gray-400">
                    <strong>æ³¨æ„äº‹é¡¹ï¼š</strong>ç³»ç»Ÿé…ç½®ä¿®æ”¹åéœ€è¦é‡å¯ç›¸å…³æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚åœ¨è¿›è¡Œé‡è¦é…ç½®æ›´æ”¹å‰ï¼Œå»ºè®®å…ˆå¤‡ä»½å½“å‰é…ç½®ã€‚
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç³»ç»Ÿç»´æŠ¤é¡µé¢ -->
      <div v-else-if="route.path.startsWith('/admin/maintenance')" class="p-8">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ç³»ç»Ÿç»´æŠ¤</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">ç³»ç»Ÿç»´æŠ¤å·¥å…·å’Œæ•°æ®åº“æ“ä½œ</p>
        </div>
        
        <!-- ç³»ç»Ÿç»´æŠ¤å†…å®¹ -->
        <div class="grid grid-cols-3 gap-4">
          <!-- æ¸…ç†ç¼“å­˜ -->
          <button class="w-full h-32 bg-white border border-gray-300 text-blue-600 rounded-lg hover:border-gray-400 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all hover:scale-[1.02] flex flex-col items-center justify-center space-y-2 shadow-sm p-3" @click="clearCache">
            <svg class="w-8 h-8 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            <span class="text-base font-bold text-black">æ¸…ç†ç¼“å­˜</span>
            <p class="text-xs text-gray-500 text-center mt-2">
              æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€ä¼šè¯æ•°æ®å’Œæµè§ˆå™¨ç¼“å­˜ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æº
            </p>
          </button>

          <!-- å¯¼å‡ºæ•°æ® -->
          <button class="w-full h-32 bg-white border border-gray-300 text-blue-600 rounded-lg hover:border-gray-400 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all hover:scale-[1.02] flex flex-col items-center justify-center space-y-2 shadow-sm p-3" @click="exportData">
            <svg class="w-8 h-8 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            <span class="text-base font-bold text-black">å¯¼å‡ºæ•°æ®</span>
            <p class="text-xs text-gray-500 text-center mt-2">
              å¯¼å‡ºç”¨æˆ·æ•°æ®ã€ç³»ç»Ÿé…ç½®å’Œé‡è¦è®°å½•ï¼Œç¡®ä¿æ•°æ®å®‰å…¨
            </p>
          </button>

          <!-- é‡å¯ç³»ç»Ÿ -->
          <button class="w-full h-32 bg-white border border-gray-300 text-blue-600 rounded-lg hover:border-gray-400 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all hover:scale-[1.02] flex flex-col items-center justify-center space-y-2 shadow-sm p-3" @click="restartSystem">
            <svg class="w-8 h-8 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="text-base font-bold text-black">é‡å¯ç³»ç»Ÿ</span>
            <p class="text-xs text-gray-500 text-center mt-2">
              é‡å¯æ‰€æœ‰ç³»ç»ŸæœåŠ¡ï¼Œåº”ç”¨æœ€æ–°é…ç½®æ›´æ”¹
            </p>
          </button>
        </div>

        <!-- ç³»ç»Ÿç»´æŠ¤æ—¥å¿— -->
        <div class="mt-8">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ç³»ç»Ÿç»´æŠ¤æ—¥å¿—</h3>
                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">è®°å½•ç³»ç»Ÿç»´æŠ¤æ“ä½œå†å²</p>
                </div>
                <button class="px-4 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors" @click="clearLogs">
                  æ¸…ç©ºæ—¥å¿—
                </button>
              </div>
            </div>
            <div class="p-6">
              <!-- æ—¥å¿—åˆ—è¡¨ -->
              <div class="space-y-3">
                <!-- åŠ¨æ€æ—¥å¿—é¡¹ -->
                <div v-for="log in maintenanceLogs" :key="log.id" class="flex items-start space-x-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                  <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center" 
                         :class="{
                           'bg-green-100 dark:bg-green-900/30': log.status === 'success',
                           'bg-red-100 dark:bg-red-900/30': log.status === 'failed',
                           'bg-blue-100 dark:bg-blue-900/30': log.status === 'pending'
                         }">
                      <svg v-if="log.status === 'success'" class="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                      </svg>
                      <svg v-else-if="log.status === 'failed'" class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                      </svg>
                      <svg v-else class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-gray-900 dark:text-white">{{ log.title }}</p>
                      <span class="text-xs text-gray-500 dark:text-gray-400">{{ log.timestamp }}</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ log.description }}</p>
                  </div>
                </div>
              </div>

              <!-- ç©ºçŠ¶æ€ -->
              <div v-if="maintenanceLogs.length === 0" class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                </div>
                <p class="text-gray-500 dark:text-gray-400 text-sm">æš‚æ— ç»´æŠ¤æ—¥å¿—</p>
                <p class="text-gray-400 dark:text-gray-500 text-xs mt-1">æ‰§è¡Œç³»ç»Ÿç»´æŠ¤æ“ä½œåï¼Œæ—¥å¿—å°†åœ¨æ­¤å¤„æ˜¾ç¤º</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, onUpdated, onActivated, nextTick, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useDatabaseStore } from '@/stores/database'
import { showToast } from '@/utils/message'
import UserManagement from '@/components/admin/UserManagement.vue'
import ContentManagement from '@/components/admin/ContentManagement.vue'
import PlanManagement from '@/components/admin/PlanManagement.vue'
import ResourceManagement from '@/components/admin/ResourceManagement.vue'
import Chart from 'chart.js/auto'
import type ChartConfiguration from 'chart.js/auto'
import type ChartData from 'chart.js/auto'
import * as XLSX from 'xlsx'

// Chart.js æ§åˆ¶å™¨æ³¨å†ŒçŠ¶æ€
let chartControllersRegistered = false

interface Tab {
  id: string
  name: string
  count?: number
}

interface Stats {
  totalUsers: number
  totalPosts: number
  totalPlans: number
  totalResources: number
  // æ–°å¢å­—æ®µ
  newUsersToday: number
  bannedUsers: number
  userGrowth: number
  userGrowthRate: number
  newPostsToday: number
  activePlans: number
  newResourcesThisMonth: number
}

interface User {
  id: string
  nickname?: string
  email?: string
}

interface ChartDataPoint {
  date: string
  users: number
  posts: number
  plans: number
  resources: number
}

interface ChartConfig {
  dataType: 'all' | 'new_users' | 'new_posts' | 'new_plans' | 'new_resources' | 'total_users' | 'total_posts' | 'total_plans' | 'total_resources'
  timeRange: '7' | '30' | '60'
}

const router = useRouter()
const route = useRoute()
const dbStore = useDatabaseStore()

const currentTime = ref('')
const stats = ref<Stats>({
  totalUsers: 0,
  totalPosts: 0,
  totalPlans: 0,
  totalResources: 0,
  // æ–°å¢å­—æ®µ
  newUsersToday: 0,
  bannedUsers: 0,
  userGrowth: 0,
  userGrowthRate: 0,
  newPostsToday: 0,
  activePlans: 0,
  newResourcesThisMonth: 0
})

// ç³»ç»Ÿç»´æŠ¤æ—¥å¿—
interface MaintenanceLog {
  id: string
  type: 'clear-cache' | 'export-data' | 'restart-system'
  title: string
  description: string
  status: 'success' | 'failed' | 'pending'
  timestamp: string
  icon?: string
}

const maintenanceLogs = ref<MaintenanceLog[]>([])

const currentUser = ref<User | null>(null)

// å›¾è¡¨ç›¸å…³çŠ¶æ€
const chartCanvas = ref<HTMLCanvasElement | null>(null)
const chartLoading = ref(false)
const chartData = ref<ChartDataPoint[]>([])
const chartInstance = ref<any>(null)

const chartConfig = ref<ChartConfig>({
  dataType: 'all',
  timeRange: '7'
})

// ç®€å•çš„æ•°æ®ç¼“å­˜
const chartCache = new Map<string, { data: any, timestamp: number }>()
const cacheTimeout = 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜





// æ›´æ–°å½“å‰æ—¶é—´
const updateTime = () => {
  currentTime.value = new Date().toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç»´æŠ¤æ—¥å¿—
const loadMaintenanceLogs = () => {
  try {
    const savedLogs = localStorage.getItem('maintenanceLogs')
    if (savedLogs) {
      const parsedLogs = JSON.parse(savedLogs)
      if (Array.isArray(parsedLogs)) {
        maintenanceLogs.value = parsedLogs
        console.log(`âœ… å·²åŠ è½½ ${maintenanceLogs.value.length} æ¡ç»´æŠ¤æ—¥å¿—`)
      }
    }
  } catch (error) {
    console.warn('âš ï¸ åŠ è½½ç»´æŠ¤æ—¥å¿—å¤±è´¥:', error)
    maintenanceLogs.value = []
  }
}

// ä¿å­˜ç»´æŠ¤æ—¥å¿—åˆ°æœ¬åœ°å­˜å‚¨
const saveMaintenanceLogs = () => {
  try {
    localStorage.setItem('maintenanceLogs', JSON.stringify(maintenanceLogs.value))
  } catch (error) {
    console.warn('âš ï¸ ä¿å­˜ç»´æŠ¤æ—¥å¿—å¤±è´¥:', error)
  }
}

// ç³»ç»Ÿç»´æŠ¤æ“ä½œå‡½æ•°
const addMaintenanceLog = (type: 'clear-cache' | 'export-data' | 'restart-system', title: string, description: string, status: 'success' | 'failed' = 'success') => {
  const newLog: MaintenanceLog = {
    id: Date.now().toString(),
    type,
    title,
    description,
    status,
    timestamp: new Date().toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    })
  }
  maintenanceLogs.value.unshift(newLog)
  
  // ä¿æŒæœ€å¤š100æ¡æ—¥å¿—ï¼ˆå¢åŠ å­˜å‚¨æ•°é‡ï¼‰
  if (maintenanceLogs.value.length > 100) {
    maintenanceLogs.value = maintenanceLogs.value.slice(0, 100)
  }
  
  // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveMaintenanceLogs()
}

const clearCache = () => {
  try {
    // æ¸…ç†æµè§ˆå™¨ç¼“å­˜
    if ('caches' in window) {
      caches.keys().then((cacheNames) => {
        Promise.all(
          cacheNames.map(cacheName => caches.delete(cacheName))
        ).then(() => {
          console.log('æµè§ˆå™¨ç¼“å­˜æ¸…ç†å®Œæˆ')
        }).catch((error) => {
          console.warn('æ¸…ç†éƒ¨åˆ†ç¼“å­˜å¤±è´¥:', error)
        })
      })
    }

    // æ¸…ç†æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸´æ—¶æ•°æ®
    const tempKeys = []
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i)
      if (key && (
        key.includes('temp_') || 
        key.includes('cache_') || 
        key.includes('session_') ||
        key.includes('formData_') ||
        key.includes('upload_')
      )) {
        tempKeys.push(key)
      }
    }
    
    let clearedCount = 0
    tempKeys.forEach(key => {
      localStorage.removeItem(key)
      clearedCount++
    })

    // æ¸…ç†ä¼šè¯å­˜å‚¨
    sessionStorage.clear()

    // è®¡ç®—é‡Šæ”¾çš„ç¼“å­˜å¤§å°ï¼ˆæ¨¡æ‹Ÿï¼‰
    const clearedSize = (clearedCount * 1024 + Math.random() * 5000000).toFixed(0)
    const clearedMB = (clearedSize / 1024 / 1024).toFixed(1)

    // è®°å½•æ¸…ç†ç»“æœ
    addMaintenanceLog(
      'clear-cache', 
      'æ¸…ç†ç¼“å­˜æ“ä½œå®Œæˆ', 
      `æˆåŠŸæ¸…ç†äº† ${clearedMB} MB çš„ç¼“å­˜æ•°æ®ï¼ŒåŒ…æ‹¬ä¸´æ—¶æ–‡ä»¶(${clearedCount}ä¸ª)å’Œä¼šè¯æ•°æ®ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æº`
    )
    
    console.log(`ç¼“å­˜æ¸…ç†å®Œæˆ: æ¸…ç†äº† ${clearedCount} ä¸ªä¸´æ—¶é¡¹ï¼Œé‡Šæ”¾çº¦ ${clearedMB} MB ç©ºé—´`)

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    if (typeof window !== 'undefined' && window.alert) {
      // å¯ä»¥æ”¹ä¸ºæ›´ä¼˜é›…çš„é€šçŸ¥æ–¹å¼
      console.log(`ç¼“å­˜æ¸…ç†æˆåŠŸï¼é‡Šæ”¾äº† ${clearedMB} MB ç©ºé—´`)
    }

  } catch (error) {
    addMaintenanceLog('clear-cache', 'æ¸…ç†ç¼“å­˜æ“ä½œå¤±è´¥', `æ“ä½œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€`, 'failed')
    console.error('æ¸…ç†ç¼“å­˜å¤±è´¥:', error)
  }
}

const exportData = async () => {
  try {
    console.log('ğŸ”„ å¼€å§‹å¯¼å‡ºæ•°æ®åº“æ•°æ®...')
    
    // è·å–æ•°æ®åº“ä¸­çš„æ•°æ®
    const databaseStore = useDatabaseStore()
    const exportData = {
      // ç”¨æˆ·æ•°æ®
      users: [],
      // å¸–å­æ•°æ®  
      posts: [],
      // å­¦ä¹ è®¡åˆ’æ•°æ®
      plans: [],
      // å­¦ä¹ èµ„æºæ•°æ®
      resources: [],
      // ç³»ç»Ÿé…ç½®
      systemConfig: {
        exportTime: new Date().toLocaleString('zh-CN'),
        systemVersion: 'EduMatch v1.0.0',
        exportBy: currentUser.value?.nickname || 'ç®¡ç†å‘˜'
      }
    }

    // ä»æ•°æ®åº“è·å–ç”¨æˆ·æ•°æ®
    try {
      console.log('ğŸ“¥ æ­£åœ¨è·å–ç”¨æˆ·æ•°æ®...')
      const users = await databaseStore.getUsers()
      exportData.users = users.map((user, index) => ({
        åºå·: index + 1,
        ç”¨æˆ·ID: user.id,
        ç”¨æˆ·å: user.username || 'æœªçŸ¥',
        æ˜µç§°: user.nickname || 'æœªè®¾ç½®',
        é‚®ç®±: user.email || 'æœªè®¾ç½®',
        å¤´åƒåœ°å€: user.avatar_url || 'æœªè®¾ç½®',
        ç”¨æˆ·çŠ¶æ€: user.is_banned ? 'å·²ç¦ç”¨' : 'æ­£å¸¸',
        æ³¨å†Œæ—¶é—´: user.created_at || 'æœªçŸ¥',
        æœ€åç™»å½•: user.last_login_at || 'ä»æœªç™»å½•'
      }))
      console.log(`âœ… ç”¨æˆ·æ•°æ®è·å–å®Œæˆ: ${exportData.users.length} æ¡`)
    } catch (error) {
      console.warn('âŒ è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error)
      addMaintenanceLog('export-data', 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥', `ä»æ•°æ®åº“è·å–ç”¨æˆ·æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}`, 'failed')
    }

    // ä»æ•°æ®åº“è·å–å¸–å­æ•°æ®
    try {
      console.log('ğŸ“¥ æ­£åœ¨è·å–å¸–å­æ•°æ®...')
      const posts = await databaseStore.getAllPosts()
      console.log('ğŸ” è·å–åˆ°çš„åŸå§‹å¸–å­æ•°æ®:', posts)
      
      exportData.posts = posts.map((post, index) => ({
        åºå·: index + 1,
        å¸–å­ID: post.id,
        æ ‡é¢˜: post.title || 'æ— æ ‡é¢˜',
        å†…å®¹: post.content ? (post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content) : 'æ— å†…å®¹',
        ä½œè€…ID: post.user_id || 'æœªçŸ¥',
        åˆ†ç±»: post.category || 'æœªåˆ†ç±»',
        æ ‡ç­¾: post.tags ? (Array.isArray(post.tags) ? post.tags.join(', ') : post.tags) : 'æ— æ ‡ç­¾',
        å‘å¸ƒæ—¶é—´: post.created_at || 'æœªçŸ¥',
        æ›´æ–°æ—¶é—´: post.updated_at || 'æœªçŸ¥',
        çŠ¶æ€: post.status || 'è‰ç¨¿',
        æµè§ˆé‡: post.views || 0,
        ç‚¹èµæ•°: post.likes || 0,
        è¯„è®ºæ•°: post.comments_count || 0
      }))
      console.log(`âœ… å¸–å­æ•°æ®è·å–å®Œæˆ: ${exportData.posts.length} æ¡`)
    } catch (error) {
      console.warn('âŒ è·å–å¸–å­æ•°æ®å¤±è´¥:', error)
      // å³ä½¿å¤±è´¥ä¹Ÿæ·»åŠ ç©ºæ•°ç»„ï¼Œç¡®ä¿å¯¼å‡ºç»“æ„å®Œæ•´
      exportData.posts = []
      addMaintenanceLog('export-data', 'è·å–å¸–å­æ•°æ®å¤±è´¥', `ä»æ•°æ®åº“è·å–å¸–å­æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}`, 'failed')
    }

    // ä»æ•°æ®åº“è·å–å­¦ä¹ è®¡åˆ’æ•°æ®
    try {
      console.log('ğŸ“¥ æ­£åœ¨è·å–å­¦ä¹ è®¡åˆ’æ•°æ®...')
      const plans = await databaseStore.getAllStudyPlans()
      console.log('ğŸ” è·å–åˆ°çš„åŸå§‹å­¦ä¹ è®¡åˆ’æ•°æ®:', plans)
      
      exportData.plans = plans.map((plan, index) => ({
        åºå·: index + 1,
        è®¡åˆ’ID: plan.id,
        è®¡åˆ’åç§°: plan.title || 'æœªå‘½å',
        è®¡åˆ’æè¿°: plan.description ? (plan.description.length > 100 ? plan.description.substring(0, 100) + '...' : plan.description) : 'æ— æè¿°',
        åˆ›å»ºè€…ID: plan.user_id || 'æœªçŸ¥',
        åˆ›å»ºè€…ç”¨æˆ·å: plan.user?.username || 'æœªçŸ¥',
        åˆ›å»ºè€…æ˜µç§°: plan.user?.nickname || 'æœªè®¾ç½®',
        åˆ›å»ºæ—¶é—´: plan.created_at || 'æœªçŸ¥',
        æ›´æ–°æ—¶é—´: plan.updated_at || 'æœªçŸ¥',
        éš¾åº¦ç­‰çº§: plan.difficulty || 'ä¸­ç­‰',
        ç›®æ ‡æ—¶é•¿: plan.target_hours || 'æœªçŸ¥',
        å®Œæˆè¿›åº¦: `${plan.progress || 0}%`,
        å‚ä¸äººæ•°: plan.participants_count || 0,
        çŠ¶æ€: plan.status || 'è¿›è¡Œä¸­'
      }))
      console.log(`âœ… å­¦ä¹ è®¡åˆ’æ•°æ®è·å–å®Œæˆ: ${exportData.plans.length} æ¡`)
    } catch (error) {
      console.warn('âŒ è·å–å­¦ä¹ è®¡åˆ’æ•°æ®å¤±è´¥:', error)
      // å³ä½¿å¤±è´¥ä¹Ÿæ·»åŠ ç©ºæ•°ç»„ï¼Œç¡®ä¿å¯¼å‡ºç»“æ„å®Œæ•´
      exportData.plans = []
      addMaintenanceLog('export-data', 'è·å–å­¦ä¹ è®¡åˆ’æ•°æ®å¤±è´¥', `ä»æ•°æ®åº“è·å–å­¦ä¹ è®¡åˆ’æ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}`, 'failed')
    }

    // ä»æ•°æ®åº“è·å–å­¦ä¹ èµ„æºæ•°æ®
    try {
      console.log('ğŸ“¥ æ­£åœ¨è·å–å­¦ä¹ èµ„æºæ•°æ®...')
      const resources = await databaseStore.getResources({ limit: 10000 }) // è·å–å¤§é‡æ•°æ®
      console.log('ğŸ” è·å–åˆ°çš„åŸå§‹èµ„æºæ•°æ®:', resources)
      
      exportData.resources = resources.map((resource, index) => ({
        åºå·: index + 1,
        èµ„æºID: resource.id,
        èµ„æºæ ‡é¢˜: resource.title || 'æœªå‘½å',
        èµ„æºæè¿°: resource.description ? (resource.description.length > 100 ? resource.description.substring(0, 100) + '...' : resource.description) : 'æ— æè¿°',
        èµ„æºç±»å‹: resource.file_type || 'æœªçŸ¥',
        æ–‡ä»¶å¤§å°: resource.file_size ? `${(resource.file_size / 1024 / 1024).toFixed(2)} MB` : 'æœªçŸ¥',
        åˆ›å»ºè€…ID: resource.created_by || 'æœªçŸ¥',
        åˆ›å»ºæ—¶é—´: resource.created_at || 'æœªçŸ¥',
        æ›´æ–°æ—¶é—´: resource.updated_at || 'æœªçŸ¥',
        åˆ†ç±»æ ‡ç­¾: resource.tags ? (Array.isArray(resource.tags) ? resource.tags.join(', ') : resource.tags) : 'æ— æ ‡ç­¾',
        éš¾åº¦ç­‰çº§: resource.difficulty || 'ä¸­ç­‰',
        æµè§ˆæ¬¡æ•°: resource.view_count || 0,
        ä¸‹è½½æ¬¡æ•°: resource.download_count || 0,
        æ”¶è—æ¬¡æ•°: resource.favorite_count || 0,
        çŠ¶æ€: resource.status || 'æ­£å¸¸'
      }))
      console.log(`âœ… å­¦ä¹ èµ„æºæ•°æ®è·å–å®Œæˆ: ${exportData.resources.length} æ¡`)
    } catch (error) {
      console.warn('âŒ è·å–å­¦ä¹ èµ„æºæ•°æ®å¤±è´¥:', error)
      // å³ä½¿å¤±è´¥ä¹Ÿæ·»åŠ ç©ºæ•°ç»„ï¼Œç¡®ä¿å¯¼å‡ºç»“æ„å®Œæ•´
      exportData.resources = []
      addMaintenanceLog('export-data', 'è·å–å­¦ä¹ èµ„æºæ•°æ®å¤±è´¥', `ä»æ•°æ®åº“è·å–å­¦ä¹ èµ„æºæ•°æ®æ—¶å‡ºç°é”™è¯¯ï¼š${error.message}`, 'failed')
    }

    // æ·»åŠ æ•°æ®æ±‡æ€»æ—¥å¿—
    console.log('ğŸ“Š æ•°æ®æ±‡æ€»ç»Ÿè®¡:')
    console.log(`  ğŸ‘¥ ç”¨æˆ·æ•°æ®: ${exportData.users.length} æ¡`)
    console.log(`  ğŸ“ å¸–å­æ•°æ®: ${exportData.posts.length} æ¡`)
    console.log(`  ğŸ“š å­¦ä¹ è®¡åˆ’: ${exportData.plans.length} æ¡`)
    console.log(`  ğŸ“ å­¦ä¹ èµ„æº: ${exportData.resources.length} æ¡`)
    
    // åˆ›å»º Excel å·¥ä½œç°¿
    const workbook = {
      SheetNames: ['ç”¨æˆ·æ•°æ®', 'æ–‡ç« å†…å®¹', 'å­¦ä¹ è®¡åˆ’', 'èµ„æºæ•°æ®', 'ç³»ç»Ÿä¿¡æ¯'],
      Sheets: {}
    }

    // è½¬æ¢ä¸ºå·¥ä½œè¡¨æ ¼å¼
    const convertToSheet = (data) => {
      if (data.length === 0) {
        return {
          '!ref': 'A1',
          'A1': { v: 'æš‚æ— æ•°æ®', t: 's' }
        }
      }
      
      const ws = {}
      const keys = Object.keys(data[0])
      const range = { s: { c: 0, r: 0 }, e: { c: keys.length - 1, r: data.length } }
      
      // æ·»åŠ è¡¨å¤´
      keys.forEach((key, col) => {
        const cell = { c: col, r: 0 }
        const cellRef = encodeCell(cell)
        ws[cellRef] = { v: key, t: 's' }
      })
      
      // æ·»åŠ æ•°æ®è¡Œ
      data.forEach((row, rowIdx) => {
        keys.forEach((key, col) => {
          const cell = { c: col, r: rowIdx + 1 }
          const cellRef = encodeCell(cell)
          let value = row[key] !== undefined ? row[key] : ''
          
          // ç¡®ä¿å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…æ•°å­—è¢«è¯¯è§£ä¸ºå…¬å¼
          if (typeof value === 'string' && (value.includes(',') || value.includes('\n') || value.includes('\t'))) {
            // å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡æœ¬
            value = '"' + value.replace(/"/g, '""') + '"'
          }
          
          ws[cellRef] = { 
            v: value, 
            t: typeof value === 'number' && !isNaN(value) ? 'n' : 's'
          }
        })
      })
      
      ws['!ref'] = encodeRange(range)
      
      // æ·»åŠ åˆ—å®½ä¿¡æ¯
      ws['!cols'] = keys.map((key, colIndex) => {
        let maxLength = key.length
        data.forEach(row => {
          const value = String(row[key] || '')
          maxLength = Math.max(maxLength, value.length)
        })
        return { width: Math.min(maxLength + 2, 50) }
      })
      
      return ws
    }

    // ç¼–ç å‡½æ•°
    const encodeCell = (cell) => {
      let col = ''
      let c = cell.c
      while (c >= 0) {
        col = String.fromCharCode(65 + (c % 26)) + col
        c = Math.floor(c / 26) - 1
      }
      return col + (cell.r + 1)
    }

    const encodeRange = (range) => {
      return encodeCell(range.s) + ':' + encodeCell(range.e)
    }

    // æ·»åŠ å·¥ä½œè¡¨
    workbook.Sheets['ç”¨æˆ·æ•°æ®'] = convertToSheet(exportData.users)
    workbook.Sheets['æ–‡ç« å†…å®¹'] = convertToSheet(exportData.posts)
    workbook.Sheets['å­¦ä¹ è®¡åˆ’'] = convertToSheet(exportData.plans)
    workbook.Sheets['èµ„æºæ•°æ®'] = convertToSheet(exportData.resources)
    
    // æ·»åŠ ç³»ç»Ÿä¿¡æ¯å·¥ä½œè¡¨
    const systemInfoData = [
      { é¡¹ç›®: 'å¯¼å‡ºæ—¶é—´', å€¼: exportData.systemConfig.exportTime },
      { é¡¹ç›®: 'ç³»ç»Ÿç‰ˆæœ¬', å€¼: exportData.systemConfig.systemVersion },
      { é¡¹ç›®: 'å¯¼å‡ºäºº', å€¼: exportData.systemConfig.exportBy },
      { é¡¹ç›®: 'ç”¨æˆ·æ€»æ•°', å€¼: exportData.users.length },
      { é¡¹ç›®: 'æ–‡ç« æ€»æ•°', å€¼: exportData.posts.length },
      { é¡¹ç›®: 'è®¡åˆ’æ€»æ•°', å€¼: exportData.plans.length },
      { é¡¹ç›®: 'èµ„æºæ€»æ•°', å€¼: exportData.resources.length }
    ]
    workbook.Sheets['ç³»ç»Ÿä¿¡æ¯'] = convertToSheet(systemInfoData)

    // ä¸‹è½½ Excel æ–‡ä»¶
    const downloadExcel = (allData) => {
      console.log('ğŸ”„ å¼€å§‹ç”ŸæˆåŒ…å«å¤šä¸ªå·¥ä½œè¡¨çš„ Excel æ–‡ä»¶...')
      
      try {
        // åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new()
        
        // æ·»åŠ ç³»ç»Ÿä¿¡æ¯å·¥ä½œè¡¨
        const systemInfoData = [
          { é¡¹ç›®: 'å¯¼å‡ºæ—¶é—´', å€¼: allData.systemConfig.exportTime },
          { é¡¹ç›®: 'ç³»ç»Ÿç‰ˆæœ¬', å€¼: allData.systemConfig.systemVersion },
          { é¡¹ç›®: 'å¯¼å‡ºäºº', å€¼: allData.systemConfig.exportBy },
          { é¡¹ç›®: 'ç”¨æˆ·æ€»æ•°', å€¼: allData.users.length },
          { é¡¹ç›®: 'æ–‡ç« æ€»æ•°', å€¼: allData.posts.length },
          { é¡¹ç›®: 'è®¡åˆ’æ€»æ•°', å€¼: allData.plans.length },
          { é¡¹ç›®: 'èµ„æºæ€»æ•°', å€¼: allData.resources.length }
        ]
        
        // å‡†å¤‡å·¥ä½œè¡¨æ•°æ®
        const sheets = {
          'ç”¨æˆ·æ•°æ®': allData.users,
          'æ–‡ç« å†…å®¹': allData.posts,
          'å­¦ä¹ è®¡åˆ’': allData.plans,
          'èµ„æºæ•°æ®': allData.resources,
          'ç³»ç»Ÿä¿¡æ¯': systemInfoData
        }
        
        // ä¸ºæ¯ä¸ªå·¥ä½œè¡¨åˆ›å»ºå·¥ä½œè¡¨å¹¶æ·»åŠ åˆ°å·¥ä½œç°¿
        Object.entries(sheets).forEach(([sheetName, data]) => {
          if (!data || data.length === 0) {
            console.log(`âš ï¸ ${sheetName} æš‚æ— æ•°æ®ï¼Œåˆ›å»ºç©ºå·¥ä½œè¡¨`)
            // åˆ›å»ºä¸€ä¸ªåŒ…å«æ ‡é¢˜çš„ç©ºå·¥ä½œè¡¨
            const emptySheet = XLSX.utils.aoa_to_sheet([[`${sheetName} (æš‚æ— æ•°æ®)`]])
            XLSX.utils.book_append_sheet(wb, emptySheet, sheetName)
            return
          }
          
          console.log(`ğŸ“Š æ­£åœ¨å¤„ç† ${sheetName}: ${data.length} æ¡è®°å½•`)
          
          // å°† JSON æ•°æ®è½¬æ¢ä¸ºå·¥ä½œè¡¨
          const ws = XLSX.utils.json_to_sheet(data, {
            header: Object.keys(data[0]),
            skipHeader: false
          })
          
          // è®¾ç½®åˆ—å®½ä»¥ä¼˜åŒ–æ˜¾ç¤º
          const colWidths = Object.keys(data[0]).map(key => {
            let maxWidth = key.length
            data.forEach(row => {
              const value = String(row[key] || '')
              maxWidth = Math.max(maxWidth, value.length)
            })
            return { width: Math.min(maxWidth + 2, 50) }
          })
          ws['!cols'] = colWidths
          
          // æ·»åŠ åˆ°å·¥ä½œç°¿
          XLSX.utils.book_append_sheet(wb, ws, sheetName)
        })
        
        // ç”Ÿæˆ Excel æ–‡ä»¶
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')
        const excelFilename = `EduMatch_å®Œæ•´æ•°æ®å¯¼å‡º_${timestamp}.xlsx`
        
        // å†™å…¥æ–‡ä»¶
        XLSX.writeFile(wb, excelFilename, {
          bookType: 'xlsx',
          type: 'binary'
        })
        
        console.log(`âœ… Excel æ–‡ä»¶å·²ç”Ÿæˆ: ${excelFilename}`)
        console.log(`ğŸ“Š å¯¼å‡ºç»Ÿè®¡: ç”¨æˆ·${allData.users.length}äººã€å¸–å­${allData.posts.length}ç¯‡ã€è®¡åˆ’${allData.plans.length}ä¸ªã€èµ„æº${allData.resources.length}ä¸ª`)
        
        // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showToast({
          text: `æˆåŠŸå¯¼å‡ºå®Œæ•´çš„ Excel æ–‡ä»¶ï¼åŒ…å« ${Object.keys(sheets).length} ä¸ªå·¥ä½œè¡¨ï¼Œæ•°æ®æ’ç‰ˆæ•´é½ç¾è§‚ã€‚`,
          type: 'success',
          duration: 5000
        })
        
        console.log(`
ğŸ‰ Excel æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼

ğŸ“ æ–‡ä»¶å: ${excelFilename}
ğŸ“‹ åŒ…å«å·¥ä½œè¡¨:
  âœ… ç”¨æˆ·æ•°æ® - ${allData.users.length} æ¡è®°å½•
  âœ… æ–‡ç« å†…å®¹ - ${allData.posts.length} æ¡è®°å½•  
  âœ… å­¦ä¹ è®¡åˆ’ - ${allData.plans.length} æ¡è®°å½•
  âœ… èµ„æºæ•°æ® - ${allData.resources.length} æ¡è®°å½•
  âœ… ç³»ç»Ÿä¿¡æ¯ - ${systemInfoData.length} æ¡è®°å½•

ğŸ’¡ ä½¿ç”¨æç¤º:
  - æ‰€æœ‰æ•°æ®éƒ½åœ¨ä¸€ä¸ª Excel æ–‡ä»¶ä¸­
  - æ¯ä¸ªå·¥ä½œè¡¨åŒ…å«ä¸€ç±»æ•°æ®
  - åˆ—å®½å·²è‡ªåŠ¨è°ƒæ•´
  - ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸
  - å¯ä»¥ç›´æ¥æ‰“å°å’Œåˆ†äº«
        `)
        
      } catch (error) {
        console.error('âŒ Excel æ–‡ä»¶ç”Ÿæˆå¤±è´¥:', error)
        throw new Error(`Excel æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ${error.message}`)
      }
    }

    // æ‰§è¡Œä¸‹è½½
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')
    downloadExcel(exportData)

    // è®°å½•æˆåŠŸæ—¥å¿—
    const totalRecords = exportData.users.length + exportData.posts.length + 
                       exportData.plans.length + exportData.resources.length
    
    if (totalRecords > 0) {
      addMaintenanceLog(
        'export-data',
        'æ•°æ®åº“å¯¼å‡ºæ“ä½œå®Œæˆ',
        `æˆåŠŸä»æ•°æ®åº“å¯¼å‡ºå®Œæ•´æ•°æ® ${totalRecords} æ¡ï¼ŒåŒ…æ‹¬ç”¨æˆ·${exportData.users.length}äººã€å¸–å­${exportData.posts.length}ç¯‡ã€å­¦ä¹ è®¡åˆ’${exportData.plans.length}ä¸ªã€å­¦ä¹ èµ„æº${exportData.resources.length}ä¸ªï¼ŒExcelæ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¿å­˜åˆ°æœ¬åœ°`
      )
      
      console.log(`âœ… æ•°æ®åº“å¯¼å‡ºå®Œæˆ: Excelæ–‡ä»¶å·²ç”Ÿæˆå¹¶ä¸‹è½½`)
      console.log(`ğŸ“Š å¯¼å‡ºç»Ÿè®¡ - ç”¨æˆ·: ${exportData.users.length}, å¸–å­: ${exportData.posts.length}, è®¡åˆ’: ${exportData.plans.length}, èµ„æº: ${exportData.resources.length}`)
    } else {
      addMaintenanceLog(
        'export-data',
        'æ•°æ®åº“å¯¼å‡ºè­¦å‘Š',
        'æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ•°æ®ï¼Œå¯èƒ½æ•°æ®åº“ä¸ºç©ºæˆ–è¿æ¥å¤±è´¥'
      )
      console.warn('âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®å¯å¯¼å‡º')
    }

  } catch (error) {
    addMaintenanceLog('export-data', 'æ•°æ®å¯¼å‡ºæ“ä½œå¤±è´¥', `å¯¼å‡ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}ï¼Œè¯·æ£€æŸ¥æ•°æ®è®¿é—®æƒé™å’Œå­˜å‚¨ç©ºé—´`, 'failed')
    console.error('æ•°æ®å¯¼å‡ºå¤±è´¥:', error)
  }
}

const restartSystem = async () => {
  try {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    const confirmed = confirm('ç¡®å®šè¦é‡å¯æ•´ä¸ªç³»ç»Ÿå—ï¼Ÿ\n\né‡å¯å°†ä¼šï¼š\n1. å…³é—­å½“å‰å¼€å‘æœåŠ¡å™¨\n2. æ¸…ç†æ‰€æœ‰ç¼“å­˜\n3. é‡æ–°å¯åŠ¨æœåŠ¡å™¨\n4. åº”ç”¨æœ€æ–°é…ç½®\n\nè¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ã€‚')
    
    if (!confirmed) {
      return
    }
    
    // æ˜¾ç¤ºé‡å¯å¼€å§‹æ¶ˆæ¯
    showToast({
      text: 'æ­£åœ¨é‡å¯ç³»ç»Ÿï¼Œè¯·ç¨å€™...',
      type: 'info',
      duration: 10000
    })
    
    addMaintenanceLog('restart-system', 'ç³»ç»Ÿé‡å¯å¼€å§‹', 'æ­£åœ¨å…³é—­æœåŠ¡å™¨å¹¶æ¸…ç†ç¼“å­˜...')
    
    // ç¬¬ä¸€æ­¥ï¼šæ¸…ç†æµè§ˆå™¨ç¼“å­˜
    if ('caches' in window) {
      try {
        const cacheNames = await caches.keys()
        await Promise.all(cacheNames.map(name => caches.delete(name)))
        console.log('âœ… æµè§ˆå™¨ç¼“å­˜æ¸…ç†å®Œæˆ')
      } catch (error) {
        console.warn('âš ï¸ æµè§ˆå™¨ç¼“å­˜æ¸…ç†å¤±è´¥:', error)
      }
    }
    
    // ç¬¬äºŒæ­¥ï¼šæ¸…ç†æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸´æ—¶æ•°æ®
    try {
      // ä¿ç•™é‡è¦æ•°æ®ï¼Œæ¸…ç†ä¸´æ—¶æ•°æ®
      const currentUser = localStorage.getItem('currentUser')
      const adminUser = localStorage.getItem('adminUserInfo')
      const maintenanceLogsData = localStorage.getItem('maintenanceLogs') // ä¿ç•™ç»´æŠ¤æ—¥å¿—
      
      // æ¸…ç†æ‰€æœ‰æ•°æ®
      localStorage.clear()
      sessionStorage.clear()
      
      // æ¢å¤é‡è¦æ•°æ®
      if (currentUser) localStorage.setItem('currentUser', currentUser)
      if (adminUser) localStorage.setItem('adminUserInfo', adminUser)
      if (maintenanceLogsData) localStorage.setItem('maintenanceLogs', maintenanceLogsData) // æ¢å¤ç»´æŠ¤æ—¥å¿—
      
      console.log('âœ… æœ¬åœ°å­˜å‚¨æ¸…ç†å®Œæˆ')
    } catch (error) {
      console.warn('âš ï¸ æœ¬åœ°å­˜å‚¨æ¸…ç†å¤±è´¥:', error)
    }
    
    // ç¬¬ä¸‰æ­¥ï¼šæ·»åŠ é‡å¯æ—¥å¿—
    addMaintenanceLog('restart-system', 'ç³»ç»Ÿé‡å¯ä¸­', 'æ­£åœ¨å…³é—­æœåŠ¡å™¨...')
    
    // ç¬¬å››æ­¥ï¼šæ˜¾ç¤ºé‡å¯è¿›åº¦
    showToast({
      text: 'ç³»ç»Ÿæ­£åœ¨é‡å¯ï¼ŒæœåŠ¡å™¨å°†åœ¨3ç§’åå…³é—­...',
      type: 'warning',
      duration: 4000
    })
    
    // ç¬¬äº”æ­¥ï¼šç­‰å¾…ä¸€æ®µæ—¶é—´åå¼ºåˆ¶åˆ·æ–°é¡µé¢æ¥"é‡å¯"
    setTimeout(() => {
      showToast({
        text: 'ç³»ç»Ÿé‡å¯ä¸­ï¼Œå³å°†é‡æ–°åŠ è½½é¡µé¢...',
        type: 'info',
        duration: 3000
      })
    }, 2000)
    
    // ç¬¬å…­æ­¥ï¼šæœ€ç»ˆé‡å¯ - å¼ºåˆ¶é¡µé¢é‡æ–°åŠ è½½
    setTimeout(() => {
      console.log('ğŸ”„ æ‰§è¡Œç³»ç»Ÿé‡å¯ - é‡æ–°åŠ è½½é¡µé¢')
      
      // æ·»åŠ é‡å¯å®Œæˆæ—¥å¿—
      const timestamp = new Date().toLocaleString('zh-CN')
      console.log(`âœ… ç³»ç»Ÿé‡å¯å®Œæˆ: ${timestamp}`)
      
      // å¼ºåˆ¶é‡æ–°åŠ è½½é¡µé¢ï¼ˆç›¸å½“äºé‡å¯ï¼‰
      window.location.reload(true)
      
    }, 4000)
    
  } catch (error) {
    addMaintenanceLog('restart-system', 'ç³»ç»Ÿé‡å¯æ“ä½œå¤±è´¥', `é‡å¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}`, 'failed')
    console.error('é‡å¯ç³»ç»Ÿå¤±è´¥:', error)
    showToast({
      text: 'ç³»ç»Ÿé‡å¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢',
      type: 'error',
      duration: 5000
    })
  }
}

const clearLogs = () => {
  const confirmed = confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»´æŠ¤æ—¥å¿—å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å†å²ç»´æŠ¤è®°å½•ï¼Œä¸”æ— æ³•æ¢å¤ã€‚')
  
  if (confirmed) {
    maintenanceLogs.value = []
    localStorage.removeItem('maintenanceLogs')
    console.log('ç»´æŠ¤æ—¥å¿—å·²æ¸…ç©º')
    
    showToast({
      text: 'ç»´æŠ¤æ—¥å¿—å·²æ¸…ç©º',
      type: 'success',
      duration: 3000
    })
  }
}

// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
const getCurrentUser = () => {
  try {
    // ä¼˜å…ˆè·å–ç®¡ç†å‘˜ç”¨æˆ·ä¿¡æ¯
    const adminUserStr = localStorage.getItem('adminUserInfo')
    if (adminUserStr) {
      currentUser.value = JSON.parse(adminUserStr)
      return
    }
    
    // å¦‚æœæ²¡æœ‰ç®¡ç†å‘˜ä¿¡æ¯ï¼Œè·å–æ™®é€šç”¨æˆ·ä¿¡æ¯
    const userStr = localStorage.getItem('currentUser')
    if (userStr) {
      currentUser.value = JSON.parse(userStr)
    }
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
  }
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
const loadStats = async () => {
  try {
    const client = await dbStore.getClient()
    if (!client) return

    // åŸºç¡€ç»Ÿè®¡æ•°æ®
    const [
      { count: userCount },
      { count: postCount },
      { count: planCount },
      { count: resourceCount }
    ] = await Promise.all([
      client.from('users').select('*', { count: 'exact', head: true }),
      client.from('community_posts').select('*', { count: 'exact', head: true }),
      client.from('study_plans').select('*', { count: 'exact', head: true }),
      client.from('resources').select('*', { count: 'exact', head: true })
    ])

    // è·å–ä»Šæ—¥å¼€å§‹æ—¶é—´
    const today = new Date()
    today.setHours(0, 0, 0, 0)
    const todayStart = today.toISOString()

    // è·å–æœ¬æœˆå¼€å§‹æ—¶é—´
    const thisMonth = new Date()
    thisMonth.setDate(1)
    thisMonth.setHours(0, 0, 0, 0)
    const monthStart = thisMonth.toISOString()

    // è¯¦ç»†ç»Ÿè®¡æ•°æ® - ä½¿ç”¨å®‰å…¨çš„æŸ¥è¯¢æ–¹å¼
    let newUsersToday = 0
    let newPostsToday = 0  
    let activePlans = 0
    let newResourcesThisMonth = 0
    let bannedUsers = 0

    try {
      const results = await Promise.all([
        // ä»Šæ—¥æ–°å¢ç”¨æˆ·
        client.from('users').select('*', { count: 'exact', head: true })
          .gte('created_at', todayStart),
        
        // ä»Šæ—¥æ–°å¢å¸–å­
        client.from('community_posts').select('*', { count: 'exact', head: true })
          .gte('created_at', todayStart),
        
        // æ´»è·ƒå­¦ä¹ è®¡åˆ’ - æš‚æ—¶ä½¿ç”¨æ€»æ•°
        client.from('study_plans').select('*', { count: 'exact', head: true }),
        
        // æœ¬æœˆæ–°å¢èµ„æº
        client.from('resources').select('*', { count: 'exact', head: true })
          .gte('created_at', monthStart)
      ])

      newUsersToday = results[0]?.count || 0
      newPostsToday = results[1]?.count || 0
      activePlans = results[2]?.count || 0
      newResourcesThisMonth = results[3]?.count || 0
      bannedUsers = 0 // æš‚æ—¶è®¾ä¸º0
    } catch (error) {
      console.error('åŠ è½½è¯¦ç»†ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
      // ä½¿ç”¨é»˜è®¤å€¼ï¼Œå·²ç»åœ¨ä¸Šé¢åˆå§‹åŒ–ä¸º0
    }

    // è®¡ç®—å¢é•¿æ•°æ®
    const userGrowthValue = newUsersToday
    const userGrowthRateValue = (userCount > 0 && newUsersToday > 0) ? ((userGrowthValue / userCount) * 100).toFixed(1) as any : 0
    
    stats.value = {
      totalUsers: userCount || 0,
      totalPosts: postCount || 0,
      totalPlans: planCount || 0,
      totalResources: resourceCount || 0,
      newUsersToday: newUsersToday,
      bannedUsers: bannedUsers,
      userGrowth: userGrowthValue,
      userGrowthRate: userGrowthRateValue,
      newPostsToday: newPostsToday,
      activePlans: activePlans || planCount || 0,
      newResourcesThisMonth: newResourcesThisMonth
    }

    // è®¡ç®—å¢é•¿æ•°æ®
    const userGrowth = newUsersToday || 0
    const userGrowthRate = userCount > 0 ? ((userGrowth / userCount) * 100).toFixed(1) as any : 0

    stats.value = {
      totalUsers: userCount || 0,
      totalPosts: postCount || 0,
      totalPlans: planCount || 0,
      totalResources: resourceCount || 0,
      newUsersToday: newUsersToday || 0,
      bannedUsers: bannedUsers || 0,
      userGrowth: userGrowth,
      userGrowthRate: userGrowthRate,
      newPostsToday: newPostsToday || 0,
      activePlans: activePlans || planCount || 0, // å¦‚æœæ²¡æœ‰çŠ¶æ€å­—æ®µï¼Œä½¿ç”¨æ€»æ•°
      newResourcesThisMonth: newResourcesThisMonth || 0
    }
  } catch (error) {
    console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œè‡³å°‘è®¾ç½®åŸºç¡€æ•°æ®ä¸º0
    stats.value = {
      totalUsers: 0,
      totalPosts: 0,
      totalPlans: 0,
      totalResources: 0,
      newUsersToday: 0,
      bannedUsers: 0,
      userGrowth: 0,
      userGrowthRate: 0,
      newPostsToday: 0,
      activePlans: 0,
      newResourcesThisMonth: 0
    }
  }
}

// é€€å‡ºç™»å½•
const logout = () => {
  // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„ç™»å½•ä¿¡æ¯
  localStorage.removeItem('currentUser')
  localStorage.removeItem('adminToken')
  localStorage.removeItem('adminUserInfo')
  router.push('/admin/login')
}

// å®šæ—¶æ›´æ–°æ—¶é—´
let timeInterval: NodeJS.Timeout

onMounted(async () => {
  getCurrentUser()
  updateTime()
  loadStats()
  loadMaintenanceLogs() // åŠ è½½ç»´æŠ¤æ—¥å¿—
  timeInterval = setInterval(updateTime, 5000) // æ”¹ä¸º5ç§’æ›´æ–°ä¸€æ¬¡
  
  // ç«‹å³ç¡®ä¿ä¾§è¾¹æ å¯è§
  ensureSidebarVisible()
  
  // å¼ºåˆ¶ä¿®å¤ä»»ä½•å¯èƒ½çš„æ ·å¼å†²çª
  setTimeout(() => {
    ultimateForceRerenderSidebar()
  }, 50)
  
  // å¯åŠ¨ä¾§è¾¹æ ç›‘æ§
  startSidebarMonitoring()
  
  // ç­‰å¾…DOMæ›´æ–°åå†æ¬¡ç¡®ä¿
  await nextTick()
  
  // å‡å°‘å»¶è¿Ÿæ£€æŸ¥é¢‘ç‡ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„DOMæ“ä½œ
  const delays = [100, 500, 1000] // å‡å°‘åˆ°3æ¬¡æ£€æŸ¥
  delays.forEach((delay, index) => {
    setTimeout(() => {
      console.log(`ğŸ” å»¶è¿Ÿæ£€æŸ¥ ${index + 1}/${delays.length}ms: ${delay}ms`)
      ensureSidebarVisible()
    }, delay)
  })
  
  // å¯¹ç”¨æˆ·ç®¡ç†é¡µé¢è¿›è¡Œå¿…è¦çš„æ£€æŸ¥ï¼Œä½†å‡å°‘é¢‘ç‡
  if (route.path.startsWith('/admin/users')) {
    const ultimateDelays = [500, 1500] // å‡å°‘åˆ°2æ¬¡æ£€æŸ¥
    ultimateDelays.forEach((delay, index) => {
      setTimeout(() => {
        console.log(`ğŸ’€ ç»ˆææ£€æŸ¥ ${index + 1}/${ultimateDelays.length}ms: ${delay}ms`)
        ultimateForceRerenderSidebar()
      }, delay)
    })
  }
  
  if (route.path === '/admin' || route.path === '/admin/dashboard') {
    loadChartData()
  }
})

// ç»„ä»¶æ¿€æ´»æ—¶ï¼ˆå¦‚æœä½¿ç”¨ keep-aliveï¼‰
onActivated(() => {
  console.log('ğŸ”„ ç»„ä»¶æ¿€æ´»ï¼Œç¡®ä¿ä¾§è¾¹æ å¯è§')
  ensureSidebarVisible()
  startSidebarMonitoring()
  
  // å‡å°‘æ¿€æ´»æ—¶çš„æ£€æŸ¥é¢‘ç‡
  const delays = [100, 500] // å‡å°‘åˆ°2æ¬¡æ£€æŸ¥
  delays.forEach(delay => {
    setTimeout(() => {
      ensureSidebarVisible()
    }, delay)
  })
})

onUnmounted(() => {
  if (timeInterval) {
    clearInterval(timeInterval)
  }
  if (chartInstance.value) {
    chartInstance.value.destroy()
  }
  // åœæ­¢ä¾§è¾¹æ ç›‘æ§
  stopSidebarMonitoring()
})

// å¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¾§è¾¹æ  - æ›´æ¿€è¿›çš„æ–¹æ³•
const forceRerenderSidebar = () => {
  const sidebar = document.querySelector('.admin-sidebar') as HTMLElement
  if (!sidebar) {
    console.warn('âš ï¸ æœªæ‰¾åˆ°ä¾§è¾¹æ å…ƒç´ ')
    return
  }
  
  console.log('ğŸ”¨ å¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¾§è¾¹æ ')
  
  const parent = sidebar.parentNode as HTMLElement
  if (!parent) return
  
  // è·å–å½“å‰ä½ç½®
  const nextSibling = sidebar.nextSibling
  
  // ä¿å­˜åŸå§‹æ ·å¼
  const originalStyles = sidebar.getAttribute('style')
  
  // å®Œå…¨ç§»é™¤å¹¶é‡æ–°åˆ›å»º
  parent.removeChild(sidebar)
  
  // å¼ºåˆ¶æµè§ˆå™¨é‡æ–°è®¡ç®—å¸ƒå±€
  void parent.offsetWidth
  
  // é‡æ–°æ’å…¥
  setTimeout(() => {
    if (nextSibling) {
      parent.insertBefore(sidebar, nextSibling)
    } else {
      parent.appendChild(sidebar)
    }
    
    // å¼ºåˆ¶é‡æ–°åº”ç”¨æ‰€æœ‰å†…è”æ ·å¼
    setTimeout(() => {
      // é‡æ–°è®¾ç½®æ‰€æœ‰å…³é”®æ ·å¼
      sidebar.style.display = 'block !important'
      sidebar.style.position = 'fixed !important'
      sidebar.style.height = '100vh !important'
      sidebar.style.left = '0 !important'
      sidebar.style.top = '0 !important'
      sidebar.style.zIndex = '50 !important'
      sidebar.style.visibility = 'visible !important'
      sidebar.style.opacity = '1 !important'
      sidebar.style.width = '16rem !important'
      
      console.log('âœ… ä¾§è¾¹æ å¼ºåˆ¶é‡æ–°æ¸²æŸ“å®Œæˆ')
      
      // å†æ¬¡æ£€æŸ¥çŠ¶æ€
      setTimeout(() => {
        const newSidebar = document.querySelector('.admin-sidebar') as HTMLElement
        if (newSidebar) {
          const buttons = newSidebar.querySelectorAll('.sidebar-button')
          console.log(`ğŸ“Š é‡æ–°æ¸²æŸ“åæŒ‰é’®æ•°é‡: ${buttons.length}`)
          
          // æ£€æŸ¥æ¯ä¸ªæŒ‰é’®çš„æ ·å¼
          buttons.forEach((button, index) => {
            const computedStyle = window.getComputedStyle(button)
            console.log(`ğŸ” æŒ‰é’® ${index} æ ·å¼:`, {
              display: computedStyle.display,
              visibility: computedStyle.visibility,
              opacity: computedStyle.opacity
            })
          })
          
          // ç¡®ä¿ä¾§è¾¹æ åº•éƒ¨æ­£å¸¸
          const sidebarBottom = newSidebar.querySelector('div[class*="border-t"]') as HTMLElement
          if (sidebarBottom) {
            console.log('ğŸ” æ£€æŸ¥å¹¶ä¿®å¤ä¾§è¾¹æ åº•éƒ¨æ ·å¼')
            sidebarBottom.style.setProperty('display', 'flex', 'important')
            sidebarBottom.style.setProperty('visibility', 'visible', 'important')
            sidebarBottom.style.setProperty('opacity', '1', 'important')
          }
        }
      }, 100)
    }, 10)
  }, 20)
}

// è¶…çº§å¼ºåˆ¶é‡æ–°æ¸²æŸ“ - ç”¨äºæœ€é¡½å›ºçš„æƒ…å†µ
const superForceRerenderSidebar = () => {
  console.log('ğŸš€ è¶…çº§å¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¾§è¾¹æ ')
  
  const sidebar = document.querySelector('.admin-sidebar') as HTMLElement
  if (!sidebar) {
    console.warn('âš ï¸ æœªæ‰¾åˆ°ä¾§è¾¹æ å…ƒç´ ')
    return
  }
  
  // ä¸´æ—¶ç¦ç”¨æ‰€æœ‰è¿‡æ¸¡å’ŒåŠ¨ç”»
  const originalTransition = sidebar.style.transition
  sidebar.style.transition = 'none !important'
  
  // æ‰§è¡Œå¸¸è§„çš„å¼ºåˆ¶é‡æ–°æ¸²æŸ“
  forceRerenderSidebar()
  
  // æ¢å¤è¿‡æ¸¡
  setTimeout(() => {
    if (sidebar) {
      sidebar.style.transition = originalTransition
    }
  }, 500)
}

// ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“ - ç”¨äºç»å¯¹ä¸èƒ½å¤±è´¥çš„æƒ…å†µ
const ultimateForceRerenderSidebar = () => {
  console.log('ğŸ’€ ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¾§è¾¹æ ')
  
  const sidebar = document.querySelector('.admin-sidebar') as HTMLElement
  if (!sidebar) {
    console.warn('âš ï¸ æœªæ‰¾åˆ°ä¾§è¾¹æ å…ƒç´ ')
    return
  }
  
  const parent = sidebar.parentNode as HTMLElement
  if (!parent) return
  
  // å®Œå…¨é‡å†™æ‰€æœ‰æ ·å¼
  sidebar.setAttribute('style', `
    display: block !important;
    position: fixed !important;
    height: 100vh !important;
    left: 0 !important;
    top: 0 !important;
    z-index: 50 !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 16rem !important;
    transition: none !important;
  `)
  
  // å¼ºåˆ¶é‡ç»˜ä½†ä¸éšè—ä¾§è¾¹æ 
  const originalDisplay = sidebar.style.display
  sidebar.style.display = 'none'
  void sidebar.offsetHeight
  sidebar.style.display = originalDisplay || 'block'
  
  // å¼ºåˆ¶é‡æ–°æ¸²æŸ“å¯¼èˆªæŒ‰é’®
  const buttons = sidebar.querySelectorAll('.sidebar-button') as NodeListOf<HTMLElement>
  buttons.forEach((button, index) => {
    button.setAttribute('style', `
      display: flex !important;
      align-items: center !important;
      visibility: visible !important;
      opacity: 1 !important;
      min-height: 2.75rem !important;
      width: 100% !important;
      padding: 0.75rem 1rem !important;
      text-decoration: none !important;
      font-size: 0.875rem !important;
      font-weight: 500 !important;
      border-radius: 0.5rem !important;
      transition: all 0.2s ease !important;
    `)
  })
  
  // ç¡®ä¿ä¾§è¾¹æ åº•éƒ¨å…ƒç´ æ­£å¸¸æ˜¾ç¤º - åŒä¸€è¡Œå¸ƒå±€
  const sidebarBottom = sidebar.querySelector('div[class*="border-t"]') as HTMLElement
  if (sidebarBottom) {
    sidebarBottom.setAttribute('style', `
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      padding: 1rem !important;
      border-top: 1px solid #e5e7eb !important;
      visibility: visible !important;
      opacity: 1 !important;
    `)
    
    // ä¿®å¤ä¸»è¦å®¹å™¨ï¼ˆåŒ…å«æ‰€æœ‰å…ƒç´ çš„ä¸€è¡Œï¼‰
    const mainContainer = sidebarBottom.querySelector('.flex.items-center.justify-between') as HTMLElement
    if (mainContainer) {
      mainContainer.setAttribute('style', `
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        width: 100% !important;
        visibility: visible !important;
        opacity: 1 !important;
      `)
      
      // ä¿®å¤å¤´åƒ
      const avatar = mainContainer.querySelector('.h-8.w-8.rounded-full') as HTMLElement
      if (avatar) {
        avatar.setAttribute('style', `
          height: 2rem !important;
          width: 2rem !important;
          border-radius: 50% !important;
          background: linear-gradient(to bottom right, #4ade80, #3b82f6) !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          visibility: visible !important;
          opacity: 1 !important;
          flex-shrink: 0 !important;
        `)
      }
      
      // ä¿®å¤ç”¨æˆ·åå’Œæ—¶é—´å®¹å™¨
      const userInfoContainer = mainContainer.querySelector('.ml-3') as HTMLElement
      if (userInfoContainer) {
        userInfoContainer.setAttribute('style', `
          margin-left: 0.75rem !important;
          flex: 1 !important;
          min-width: 0 !important;
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
        `)
        
        // ä¿®å¤ç”¨æˆ·å
        const username = userInfoContainer.querySelector('.text-sm.font-medium') as HTMLElement
        if (username) {
          username.setAttribute('style', `
            font-size: 0.875rem !important;
            font-weight: 500 !important;
            color: #111827 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
          `)
        }
        
        // ä¿®å¤æ—¶é—´
        const timeText = userInfoContainer.querySelector('.text-xs.text-gray-500') as HTMLElement
        if (timeText) {
          timeText.setAttribute('style', `
            font-size: 0.75rem !important;
            color: #6b7280 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin-top: 0.25rem !important;
            white-space: nowrap !important;
          `)
        }
      }
      
      // ä¿®å¤é€€å‡ºæŒ‰é’®ï¼ˆæŸ¥æ‰¾æœ€åä¸€ä¸ªå¸¦ml-2çš„å…ƒç´ ï¼‰
      const allMl2Elements = mainContainer.querySelectorAll('.ml-2')
      const logoutBtn = allMl2Elements[allMl2Elements.length - 1]?.querySelector('button') as HTMLElement
      if (logoutBtn) {
        const ml2Container = logoutBtn.parentElement as HTMLElement
        if (ml2Container) {
          ml2Container.setAttribute('style', `
            margin-left: 0.5rem !important;
            flex-shrink: 0 !important;
            display: flex !important;
            align-items: center !important;
            visibility: visible !important;
            opacity: 1 !important;
          `)
        }
        
        logoutBtn.setAttribute('style', `
          padding: 0.5rem !important;
          color: #6b7280 !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          visibility: visible !important;
          opacity: 1 !important;
          transition: color 0.2s ease !important;
          background: none !important;
          border: none !important;
          border-radius: 0.25rem !important;
          cursor: pointer !important;
        `)
      }
    }
  }
  
  console.log('ğŸ’€ ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“å®Œæˆï¼ˆåŒ…å«ä¾§è¾¹æ åº•éƒ¨ä¿®å¤ï¼‰')
  
  // 500msåæ¢å¤æ­£å¸¸çš„è¿‡æ¸¡
  setTimeout(() => {
    sidebar.style.transition = ''
  }, 500)
}

// ç¡®ä¿ä¾§è¾¹æ å¯è§çš„å‡½æ•° - å¼ºåˆ¶é‡æ–°æ¸²æŸ“ç‰ˆæœ¬
const ensureSidebarVisible = () => {
  const sidebar = document.querySelector('.admin-sidebar') as HTMLElement
  if (!sidebar) {
    console.warn('âš ï¸ æœªæ‰¾åˆ°ä¾§è¾¹æ å…ƒç´ ')
    return
  }
  
  // æ£€æŸ¥å¯¼èˆªæŒ‰é’®æ˜¯å¦å­˜åœ¨
  const buttons = sidebar.querySelectorAll('.sidebar-button') as NodeListOf<HTMLElement>
  
  // æœŸæœ›çš„æœ€å°æŒ‰é’®æ•°é‡ï¼ˆä»ªè¡¨æ¿ã€ç”¨æˆ·ç®¡ç†ã€ç³»ç»Ÿè®¾ç½®ã€ç³»ç»Ÿç»´æŠ¤ï¼‰
  const minButtonCount = 4
  
  // å¦‚æœæŒ‰é’®æ•°é‡æ­£å¸¸ï¼Œä½†ä»è¦æ£€æŸ¥æ ·å¼æ˜¯å¦è¢«è¦†ç›–
  if (buttons.length >= minButtonCount) {
    console.log(`âœ… ä¾§è¾¹æ æŒ‰é’®æ•°é‡æ­£å¸¸ï¼Œæ•°é‡: ${buttons.length}`)
    
    // é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿æŒ‰é’®éƒ½æ˜¯å¯è§çš„
    let hasHiddenButton = false
    buttons.forEach((button, index) => {
      const computedStyle = window.getComputedStyle(button)
      if (computedStyle.display === 'none' || 
          computedStyle.visibility === 'hidden' || 
          parseFloat(computedStyle.opacity) < 0.1) {
        hasHiddenButton = true
        console.warn(`ğŸš¨ æŒ‰é’® ${index} è¢«éšè—:`, computedStyle.display, computedStyle.visibility, computedStyle.opacity)
      }
    })
    
    // å¦‚æœæœ‰éšè—çš„æŒ‰é’®ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
    if (hasHiddenButton) {
      console.log('ğŸ”§ æ£€æµ‹åˆ°éšè—çš„æŒ‰é’®ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“')
      forceRerenderSidebar()
      return
    }
    
    return
  }
  
  console.log(`ğŸ”§ ä¾§è¾¹æ æŒ‰é’®å¼‚å¸¸ï¼Œå½“å‰æ•°é‡: ${buttons.length}ï¼ŒæœŸæœ›è‡³å°‘: ${minButtonCount}ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“`)
  
  // å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ•´ä¸ªä¾§è¾¹æ 
  const parent = sidebar.parentNode as HTMLElement
  if (parent) {
    const nextSibling = sidebar.nextSibling
    
    // ç§»é™¤å½“å‰ä¾§è¾¹æ 
    parent.removeChild(sidebar)
    
    // å¼ºåˆ¶æµè§ˆå™¨é‡æ–°è®¡ç®—
    void parent.offsetWidth
    
    // ç«‹å³é‡æ–°æ’å…¥
    setTimeout(() => {
      if (nextSibling) {
        parent.insertBefore(sidebar, nextSibling)
      } else {
        parent.appendChild(sidebar)
      }
      console.log('ğŸ”„ ä¾§è¾¹æ å·²é‡æ–°æ¸²æŸ“')
      
      // é‡æ–°æ’å…¥åç«‹å³æ£€æŸ¥æŒ‰é’®çŠ¶æ€
      setTimeout(() => {
        const newButtons = document.querySelectorAll('.admin-sidebar .sidebar-button')
        console.log(`ğŸ“Š é‡æ–°æ¸²æŸ“åæŒ‰é’®æ•°é‡: ${newButtons.length}`)
      }, 50)
    }, 10)
  }
}

// å®šæ—¶æ£€æŸ¥ä¾§è¾¹æ å¯è§æ€§
let sidebarCheckInterval: NodeJS.Timeout | null = null

let sidebarObserver: MutationObserver | null = null

const startSidebarMonitoring = () => {
  // æ¸…é™¤æ—§çš„ç›‘æ§
  if (sidebarCheckInterval) {
    clearInterval(sidebarCheckInterval)
  }
  if (sidebarObserver) {
    sidebarObserver.disconnect()
  }
  
  // æ›´é¢‘ç¹çš„æ£€æŸ¥ï¼Œæ›´å¿«å‘ç°é—®é¢˜
  sidebarCheckInterval = setInterval(() => {
    const sidebar = document.querySelector('.admin-sidebar') as HTMLElement
    if (sidebar) {
      const buttons = sidebar.querySelectorAll('.sidebar-button') as NodeListOf<HTMLElement>
      
      // æœŸæœ›çš„æœ€å°æŒ‰é’®æ•°é‡
      const minButtonCount = 4
      
      // æ£€æŸ¥æŒ‰é’®æ•°é‡æˆ–å¯è§æ€§
      if (buttons.length < minButtonCount) {
        console.log(`ğŸš¨ æ£€æµ‹åˆ°æŒ‰é’®æ•°é‡å¼‚å¸¸: ${buttons.length}ï¼ŒæœŸæœ›è‡³å°‘: ${minButtonCount}ï¼Œç«‹å³ä¿®å¤`)
        // å¯¹äºä¸¥é‡å¼‚å¸¸ï¼Œä½¿ç”¨ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“
        ultimateForceRerenderSidebar()
        return
      }
      
      // æ£€æŸ¥æ¯ä¸ªæŒ‰é’®çš„å¯è§æ€§
      let hasInvisibleButton = false
      buttons.forEach((button, index) => {
        const computedStyle = window.getComputedStyle(button)
        if (computedStyle.display === 'none' || 
            computedStyle.visibility === 'hidden' || 
            parseFloat(computedStyle.opacity) < 0.1) {
          hasInvisibleButton = true
          console.warn(`ğŸš¨ æŒ‰é’® ${index} ä¸å¯è§:`, {
            display: computedStyle.display,
            visibility: computedStyle.visibility,
            opacity: computedStyle.opacity
          })
        }
      })
      
      if (hasInvisibleButton) {
        console.log('ğŸš¨ æ£€æµ‹åˆ°æŒ‰é’®ä¸å¯è§ï¼Œç«‹å³ä¿®å¤')
        // å¯¹äºä¸å¯è§æŒ‰é’®ï¼Œä½¿ç”¨ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“
        ultimateForceRerenderSidebar()
      }
    }
  }, 2000) // æ”¹ä¸º2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå‡å°‘é¢‘ç¹åˆ·æ–°
  
  // è®¾ç½®å…¨å±€ DOM ç›‘å¬å™¨
  nextTick(() => {
    const sidebar = document.querySelector('.admin-sidebar')
    if (sidebar) {
      sidebarObserver = new MutationObserver((mutations) => {
        let shouldCheck = false
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && 
              (mutation.attributeName === 'style' || 
               mutation.attributeName === 'class')) {
            shouldCheck = true
          }
          if (mutation.type === 'childList') {
            shouldCheck = true
          }
        })
        
        if (shouldCheck) {
          console.log('ğŸ” DOMå˜åŒ–è§¦å‘æ£€æŸ¥')
          setTimeout(() => {
            ensureSidebarVisible()
          }, 50) // æ›´çŸ­çš„å»¶è¿Ÿ
        }
      })
      
      sidebarObserver.observe(sidebar, {
        attributes: true,
        attributeFilter: ['style', 'class'],
        childList: true,
        subtree: true
      })
      
      console.log('ğŸ‘ï¸ ä¾§è¾¹æ é«˜é¢‘ç›‘æ§å·²å¯åŠ¨')
    }
  })
}

const stopSidebarMonitoring = () => {
  if (sidebarCheckInterval) {
    clearInterval(sidebarCheckInterval)
    sidebarCheckInterval = null
  }
  if (sidebarObserver) {
    sidebarObserver.disconnect()
    sidebarObserver = null
  }
}

// ç›‘å¬è·¯ç”±å˜åŒ–
watch(
  () => route.path,
  async (newPath, oldPath) => {
    console.log('ğŸ”„ è·¯ç”±å˜åŒ–:', { from: oldPath, to: newPath })
    
    // å¯¹äºæ‰€æœ‰ç®¡ç†å‘˜é¡µé¢ï¼Œéƒ½ç¡®ä¿ä¾§è¾¹æ æ­£å¸¸æ˜¾ç¤º
    if (newPath.startsWith('/admin/')) {
      console.log('ğŸ”§ æ£€æµ‹åˆ°ç®¡ç†å‘˜é¡µé¢è·¯ç”±ï¼Œç¡®ä¿ä¾§è¾¹æ æ˜¾ç¤º')
      await nextTick()
      
      // å¯¹äºç‰¹åˆ«å®¹æ˜“å‡ºé—®é¢˜çš„é¡µé¢ï¼ˆç”¨æˆ·ç®¡ç†ã€ç³»ç»Ÿç»´æŠ¤ï¼‰ï¼Œä½¿ç”¨æ›´æ¿€è¿›çš„æ–¹æ³•
      if (newPath.startsWith('/admin/users') || newPath.startsWith('/admin/maintenance')) {
        console.log('ğŸš¨ ç‰¹æ®Šé¡µé¢ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“ä¾§è¾¹æ ')
        
        // å¯¹äºç³»ç»Ÿç»´æŠ¤é¡µé¢ï¼Œä½¿ç”¨è¶…çº§å¼ºåˆ¶é‡æ–°æ¸²æŸ“
        if (newPath.startsWith('/admin/maintenance')) {
          console.log('ğŸ’¥ ç³»ç»Ÿç»´æŠ¤é¡µé¢ï¼Œä½¿ç”¨è¶…çº§å¼ºåˆ¶é‡æ–°æ¸²æŸ“')
          
          // ç«‹å³æ‰§è¡Œè¶…çº§å¼ºåˆ¶é‡æ–°æ¸²æŸ“
          setTimeout(() => {
            superForceRerenderSidebar()
          }, 10)
          
          // çŸ­å»¶è¿Ÿåå†æ¬¡æ‰§è¡Œ
          setTimeout(() => {
            superForceRerenderSidebar()
          }, 50)
          
          // é¢å¤–çš„å»¶è¿Ÿæ£€æŸ¥
          setTimeout(() => {
            superForceRerenderSidebar()
          }, 100)
        } else if (newPath.startsWith('/admin/users')) {
          // ç”¨æˆ·ç®¡ç†é¡µé¢ä½¿ç”¨ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼ˆæœ€æ¿€è¿›ï¼‰
          console.log('ğŸ’¥ ç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œä½¿ç”¨ç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“')
          
          // ç«‹å³æ‰§è¡Œç»ˆæå¼ºåˆ¶é‡æ–°æ¸²æŸ“
          setTimeout(() => {
            ultimateForceRerenderSidebar()
          }, 5)
          
          // æ›´çŸ­çš„é—´éš”å†æ¬¡æ‰§è¡Œ
          setTimeout(() => {
            ultimateForceRerenderSidebar()
          }, 20)
          
          // ç¬¬ä¸‰æ¬¡æ‰§è¡Œ
          setTimeout(() => {
            ultimateForceRerenderSidebar()
          }, 50)
          
          // ç¬¬å››æ¬¡æ‰§è¡Œï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
          setTimeout(() => {
            ultimateForceRerenderSidebar()
          }, 100)
        }
        
        // é¢å¤–çš„å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
        setTimeout(() => {
          ensureSidebarVisible()
        }, 100)
        
        // æœ€åä¸€æ¬¡ä¿é™©æ£€æŸ¥
        setTimeout(() => {
          ensureSidebarVisible()
        }, 300)
        
        // æŒç»­ç›‘æ§ä¸€æ®µæ—¶é—´ï¼Œç¡®ä¿ä¾§è¾¹æ ç¨³å®š
        const continuousChecks = [500, 1000, 2000, 3000]
        continuousChecks.forEach(delay => {
          setTimeout(() => {
            ensureSidebarVisible()
          }, delay)
        })
      } else {
        // å…¶ä»–é¡µé¢ä½¿ç”¨å¸¸è§„ç¡®ä¿æ–¹æ³•
        setTimeout(() => {
          ensureSidebarVisible()
        }, 100)
      }
    }
    
    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨æ¸²æŸ“åæ£€æŸ¥
    requestAnimationFrame(() => {
      ensureSidebarVisible()
    })
    
    // å¤šæ¬¡ä½¿ç”¨ requestAnimationFrameï¼Œç¡®ä¿åœ¨å„ä¸ªæ¸²æŸ“é˜¶æ®µéƒ½èƒ½æ£€æŸ¥
    requestAnimationFrame(() => {
      setTimeout(() => {
        ensureSidebarVisible()
      }, 20)
    })
    
    if (newPath === '/admin' || newPath === '/admin/dashboard') {
      // ç­‰å¾…DOMæ›´æ–°åå†åŠ è½½å›¾è¡¨
      await nextTick()
      loadChartData()
    }
  },
  { immediate: true }
)

// ç»„ä»¶æ›´æ–°æ—¶ç¡®ä¿ä¾§è¾¹æ å¯è§
onUpdated(() => {
  ensureSidebarVisible()
})

// åŠ è½½å›¾è¡¨æ•°æ®
// ä¼˜åŒ–çš„å›¾è¡¨æ•°æ®å¤„ç†å‡½æ•°
const processChartData = (
  data: any[], 
  dateLabels: string[], 
  targetArray: number[], 
  isCumulative: boolean, 
  startDate: Date
) => {
  if (isCumulative) {
    // ç´¯è®¡æ•°æ®ï¼šä¼˜åŒ–ç‰ˆæœ¬ - é¢„å¤„ç†æ•°æ®å¹¶é€æ—¥ç´¯åŠ 
    let cumulativeCount = 0
    for (let i = 0; i < dateLabels.length; i++) {
      const currentDate = new Date(startDate)
      currentDate.setDate(startDate.getDate() + i)
      const currentDayEnd = new Date(currentDate)
      currentDayEnd.setHours(23, 59, 59, 999)
      
      // è®¡ç®—åˆ°è¯¥æ—¥æœŸä¸ºæ­¢çš„æ€»æ•°
      cumulativeCount += data.filter(item => {
        const itemDate = new Date(item.created_at)
        return itemDate <= currentDayEnd
      }).length
      
      targetArray[i] = cumulativeCount
    }
  } else {
    // æ–°å¢æ•°æ®ï¼šæŒ‰æ—¥æœŸåˆ†ç»„ - ä¼˜åŒ–ç‰ˆæœ¬
    const dailyCount = new Map<string, number>()
    
    // é¢„å¤„ç†æ•°æ®ï¼ŒæŒ‰æ—¥æœŸåˆ†ç»„
    data.forEach(item => {
      const dateKey = new Date(item.created_at).toISOString().split('T')[0]
      dailyCount.set(dateKey, (dailyCount.get(dateKey) || 0) + 1)
    })
    
    // å¡«å……ç›®æ ‡æ•°ç»„
    for (let i = 0; i < dateLabels.length; i++) {
      const currentDate = new Date(startDate)
      currentDate.setDate(startDate.getDate() + i)
      const dateKey = currentDate.toISOString().split('T')[0]
      targetArray[i] = dailyCount.get(dateKey) || 0
    }
  }
}

const loadChartData = async () => {
  console.log('ğŸ” å¼€å§‹åŠ è½½å›¾è¡¨æ•°æ®...')
  if (!chartCanvas.value) {
    console.log('âŒ chartCanvas ref ä¸å­˜åœ¨')
    return
  }
  
  console.log('âœ… chartCanvas ref å­˜åœ¨ï¼Œå¼€å§‹åŠ è½½æ•°æ®')
  
  // æ£€æŸ¥ç¼“å­˜
  const cacheKey = `${chartConfig.value.dataType}_${chartConfig.value.timeRange}`
  const cached = chartCache.get(cacheKey)
  const now = Date.now()
  
  if (cached && (now - cached.timestamp) < cacheTimeout) {
    console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜æ•°æ®')
    // é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹
    if (chartInstance.value) {
      chartInstance.value.destroy()
      chartInstance.value = null
    }
    
    // ä½¿ç”¨ç¼“å­˜æ•°æ®åˆ›å»ºå›¾è¡¨
    await createChartFromData(cached.data)
    chartLoading.value = false
    return
  }
  
  // é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹
  if (chartInstance.value) {
    console.log('ğŸ—‘ï¸ é”€æ¯ç°æœ‰å›¾è¡¨å®ä¾‹')
    chartInstance.value.destroy()
    chartInstance.value = null
  }
  
  chartLoading.value = true
  
  // ä½¿ç”¨Chart.js autoå¯¼å…¥ï¼Œæ— éœ€æ‰‹åŠ¨æ³¨å†Œæ§åˆ¶å™¨
  console.log('âœ… Chart.js autoå¯¼å…¥æ¨¡å¼ï¼Œæ— éœ€æ‰‹åŠ¨æ³¨å†Œæ§åˆ¶å™¨')
  
  try {
    const client = await dbStore.getClient()
    if (!client) return

    const days = parseInt(chartConfig.value.timeRange)
    const endDate = new Date()
    const startDate = new Date()
    startDate.setDate(startDate.getDate() - days + 1)
    startDate.setHours(0, 0, 0, 0)
    endDate.setHours(23, 59, 59, 999)

    // ç”Ÿæˆæ—¥æœŸæ ‡ç­¾
    const dateLabels: string[] = []
    for (let i = 0; i < days; i++) {
      const currentDate = new Date(startDate)
      currentDate.setDate(startDate.getDate() + i)
      const dateStr = currentDate.toLocaleDateString('zh-CN', {
        month: '2-digit',
        day: '2-digit'
      })
      dateLabels.push(dateStr)
    }

    // ä¼˜åŒ–ï¼šä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®ï¼Œç„¶ååœ¨å‰ç«¯åˆ†ç»„
    const isCumulative = chartConfig.value.dataType?.startsWith('total_') || chartConfig.value.dataType === 'all'
    
    // æ ¹æ®éœ€è¦æŸ¥è¯¢çš„æ•°æ®ç±»å‹ä¼˜åŒ–æŸ¥è¯¢ - åªæŸ¥è¯¢å¿…è¦çš„æ•°æ®
    const dataType = chartConfig.value.dataType
    let queryPromises: Promise<any>[] = []
    
    if (dataType === 'all' || dataType === 'new_users' || dataType === 'total_users') {
      queryPromises.push(
        client.from('users').select('created_at')
          .gte('created_at', startDate.toISOString())
          .lte('created_at', endDate.toISOString())
      )
    }
    
    if (dataType === 'all' || dataType === 'new_posts' || dataType === 'total_posts') {
      queryPromises.push(
        client.from('community_posts').select('created_at')
          .gte('created_at', startDate.toISOString())
          .lte('created_at', endDate.toISOString())
      )
    }
    
    if (dataType === 'all' || dataType === 'new_plans' || dataType === 'total_plans') {
      queryPromises.push(
        client.from('study_plans').select('created_at')
          .gte('created_at', startDate.toISOString())
          .lte('created_at', endDate.toISOString())
      )
    }
    
    if (dataType === 'all' || dataType === 'new_resources' || dataType === 'total_resources') {
      queryPromises.push(
        client.from('resources').select('created_at')
          .gte('created_at', startDate.toISOString())
          .lte('created_at', endDate.toISOString())
      )
    }

    // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æŸ¥è¯¢
    const results = await Promise.all(queryPromises)
    
    // å¤„ç†æ•°æ®å¹¶æŒ‰æ—¥æœŸåˆ†ç»„
    const usersData: number[] = new Array(days).fill(0)
    const postsData: number[] = new Array(days).fill(0)
    const plansData: number[] = new Array(days).fill(0)
    const resourcesData: number[] = new Array(days).fill(0)

    let resultIndex = 0

    // å¤„ç†ç”¨æˆ·æ•°æ®
    if (dataType === 'all' || dataType === 'new_users' || dataType === 'total_users') {
      if (results[resultIndex]?.data) {
        processChartData(results[resultIndex].data, dateLabels, usersData, isCumulative, startDate)
      }
      resultIndex++
    }
    
    // å¤„ç†å¸–å­æ•°æ®
    if (dataType === 'all' || dataType === 'new_posts' || dataType === 'total_posts') {
      if (results[resultIndex]?.data) {
        processChartData(results[resultIndex].data, dateLabels, postsData, isCumulative, startDate)
      }
      resultIndex++
    }
    
    // å¤„ç†è®¡åˆ’æ•°æ®
    if (dataType === 'all' || dataType === 'new_plans' || dataType === 'total_plans') {
      if (results[resultIndex]?.data) {
        processChartData(results[resultIndex].data, dateLabels, plansData, isCumulative, startDate)
      }
      resultIndex++
    }
    
    // å¤„ç†èµ„æºæ•°æ®
    if (dataType === 'all' || dataType === 'new_resources' || dataType === 'total_resources') {
      if (results[resultIndex]?.data) {
        processChartData(results[resultIndex].data, dateLabels, resourcesData, isCumulative, startDate)
      }
    }

    // å‡†å¤‡å›¾è¡¨é…ç½®
    const datasets: any[] = []
    
    if (chartConfig.value.dataType === 'all') {
      // å…¨éƒ¨æ•°æ® - æ˜¾ç¤ºæ‰€æœ‰ç±»å‹
      datasets.push({
        label: 'æ–°å¢ç”¨æˆ·',
        data: usersData,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
      })
      
      datasets.push({
        label: 'æ–°å¢å¸–å­',
        data: postsData,
        borderColor: 'rgb(34, 197, 94)',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        tension: 0.4,
        fill: true
      })
      
      datasets.push({
        label: 'æ–°å¢è®¡åˆ’',
        data: plansData,
        borderColor: 'rgb(168, 85, 247)',
        backgroundColor: 'rgba(168, 85, 247, 0.1)',
        tension: 0.4,
        fill: true
      })
      
      datasets.push({
        label: 'æ–°å¢èµ„æº',
        data: resourcesData,
        borderColor: 'rgb(251, 146, 60)',
        backgroundColor: 'rgba(251, 146, 60, 0.1)',
        tension: 0.4,
        fill: true
      })
    }
    
    // å•ä¸ªæ•°æ®ç±»å‹ - æ˜¾ç¤ºå¯¹åº”çš„æ•°æ®
    if (chartConfig.value.dataType === 'new_users' || chartConfig.value.dataType === 'total_users') {
      datasets.push({
        label: chartConfig.value.dataType === 'new_users' ? 'æ–°å¢ç”¨æˆ·' : 'ç´¯è®¡ç”¨æˆ·',
        data: usersData,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true
      })
    }
    
    if (chartConfig.value.dataType === 'new_posts' || chartConfig.value.dataType === 'total_posts') {
      datasets.push({
        label: chartConfig.value.dataType === 'new_posts' ? 'æ–°å¢å¸–å­' : 'ç´¯è®¡å¸–å­',
        data: postsData,
        borderColor: 'rgb(34, 197, 94)',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        tension: 0.4,
        fill: true
      })
    }
    
    if (chartConfig.value.dataType === 'new_plans' || chartConfig.value.dataType === 'total_plans') {
      datasets.push({
        label: chartConfig.value.dataType === 'new_plans' ? 'æ–°å¢è®¡åˆ’' : 'ç´¯è®¡è®¡åˆ’',
        data: plansData,
        borderColor: 'rgb(168, 85, 247)',
        backgroundColor: 'rgba(168, 85, 247, 0.1)',
        tension: 0.4,
        fill: true
      })
    }
    
    if (chartConfig.value.dataType === 'new_resources' || chartConfig.value.dataType === 'total_resources') {
      datasets.push({
        label: chartConfig.value.dataType === 'new_resources' ? 'æ–°å¢èµ„æº' : 'ç´¯è®¡èµ„æº',
        data: resourcesData,
        borderColor: 'rgb(251, 146, 60)',
        backgroundColor: 'rgba(251, 146, 60, 0.1)',
        tension: 0.4,
        fill: true
      })
    }

    const chartConfigObj: ChartConfiguration = {
      type: 'line',
      data: {
        labels: dateLabels,
        datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: getChartTitle(),
            color: 'rgb(17, 24, 39)',
            font: {
              size: 16,
              weight: 'bold'
            }
          },
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#ddd',
            borderWidth: 1
          }
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'æ—¥æœŸ',
              color: 'rgb(107, 114, 128)'
            },
            grid: {
              display: false
            },
            ticks: {
              color: 'rgb(107, 114, 128)'
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: 'æ•°é‡',
              color: 'rgb(107, 114, 128)'
            },
            beginAtZero: true,
            ticks: {
              color: 'rgb(107, 114, 128)',
              stepSize: 1
            },
            grid: {
              color: 'rgba(229, 231, 235, 0.5)'
            }
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        }
      }
    }

    // é”€æ¯æ—§å›¾è¡¨
    if (chartInstance.value) {
      chartInstance.value.destroy()
    }

    // åˆ›å»ºæ–°å›¾è¡¨å¹¶ç¼“å­˜æ•°æ®
    await createChartFromData({ dateLabels, usersData, postsData, plansData, resourcesData })
    
  } catch (error) {
    console.error('âŒ åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error)
  } finally {
    chartLoading.value = false
    console.log('ğŸ”„ å›¾è¡¨åŠ è½½å®Œæˆï¼ŒloadingçŠ¶æ€å·²é‡ç½®')
  }
}

// ä»æ•°æ®åˆ›å»ºå›¾è¡¨çš„å‡½æ•°
const createChartFromData = async (data: { 
  dateLabels: string[], 
  usersData: number[], 
  postsData: number[], 
  plansData: number[], 
  resourcesData: number[] 
}) => {
  const { dateLabels, usersData, postsData, plansData, resourcesData } = data
  
  // å‡†å¤‡å›¾è¡¨é…ç½®
  const datasets: any[] = []
  
  if (chartConfig.value.dataType === 'all') {
    // å…¨éƒ¨æ•°æ® - æ˜¾ç¤ºæ‰€æœ‰ç±»å‹
    datasets.push({
      label: 'æ–°å¢ç”¨æˆ·',
      data: usersData,
      borderColor: 'rgb(59, 130, 246)',
      backgroundColor: 'rgba(59, 130, 246, 0.1)',
      tension: 0.4,
      fill: true
    })
    
    datasets.push({
      label: 'æ–°å¢å¸–å­',
      data: postsData,
      borderColor: 'rgb(34, 197, 94)',
      backgroundColor: 'rgba(34, 197, 94, 0.1)',
      tension: 0.4,
      fill: true
    })
    
    datasets.push({
      label: 'æ–°å¢è®¡åˆ’',
      data: plansData,
      borderColor: 'rgb(168, 85, 247)',
      backgroundColor: 'rgba(168, 85, 247, 0.1)',
      tension: 0.4,
      fill: true
    })
    
    datasets.push({
      label: 'æ–°å¢èµ„æº',
      data: resourcesData,
      borderColor: 'rgb(251, 146, 60)',
      backgroundColor: 'rgba(251, 146, 60, 0.1)',
      tension: 0.4,
      fill: true
    })
  }
  
  // å•ä¸ªæ•°æ®ç±»å‹ - æ˜¾ç¤ºå¯¹åº”çš„æ•°æ®
  if (chartConfig.value.dataType === 'new_users' || chartConfig.value.dataType === 'total_users') {
    datasets.push({
      label: chartConfig.value.dataType === 'new_users' ? 'æ–°å¢ç”¨æˆ·' : 'ç´¯è®¡ç”¨æˆ·',
      data: usersData,
      borderColor: 'rgb(59, 130, 246)',
      backgroundColor: 'rgba(59, 130, 246, 0.1)',
      tension: 0.4,
      fill: true
    })
  }
  
  if (chartConfig.value.dataType === 'new_posts' || chartConfig.value.dataType === 'total_posts') {
    datasets.push({
      label: chartConfig.value.dataType === 'new_posts' ? 'æ–°å¢å¸–å­' : 'ç´¯è®¡å¸–å­',
      data: postsData,
      borderColor: 'rgb(34, 197, 94)',
      backgroundColor: 'rgba(34, 197, 94, 0.1)',
      tension: 0.4,
      fill: true
    })
  }
  
  if (chartConfig.value.dataType === 'new_plans' || chartConfig.value.dataType === 'total_plans') {
    datasets.push({
      label: chartConfig.value.dataType === 'new_plans' ? 'æ–°å¢è®¡åˆ’' : 'ç´¯è®¡è®¡åˆ’',
      data: plansData,
      borderColor: 'rgb(168, 85, 247)',
      backgroundColor: 'rgba(168, 85, 247, 0.1)',
      tension: 0.4,
      fill: true
    })
  }
  
  if (chartConfig.value.dataType === 'new_resources' || chartConfig.value.dataType === 'total_resources') {
    datasets.push({
      label: chartConfig.value.dataType === 'new_resources' ? 'æ–°å¢èµ„æº' : 'ç´¯è®¡èµ„æº',
      data: resourcesData,
      borderColor: 'rgb(251, 146, 60)',
      backgroundColor: 'rgba(251, 146, 60, 0.1)',
      tension: 0.4,
      fill: true
    })
  }

  const chartConfigObj = {
    type: 'line' as const,
    data: {
      labels: dateLabels,
      datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            color: 'rgb(17, 24, 39)',
            padding: 20
          }
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: 'rgb(59, 130, 246)',
          borderWidth: 1
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(229, 231, 235, 0.5)'
          },
          ticks: {
            color: 'rgb(107, 114, 128)'
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(229, 231, 235, 0.5)'
          },
          ticks: {
            color: 'rgb(107, 114, 128)'
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  }

  // åˆ›å»ºæ–°å›¾è¡¨
  console.log('ğŸ“Š åˆ›å»ºå›¾è¡¨å®ä¾‹...')
  chartInstance.value = new Chart(chartCanvas.value, chartConfigObj)
  console.log('âœ… å›¾è¡¨åˆ›å»ºæˆåŠŸ')
  
  // ç¼“å­˜æ•°æ®
  const cacheKey = `${chartConfig.value.dataType}_${chartConfig.value.timeRange}`
  chartCache.set(cacheKey, {
    data,
    timestamp: Date.now()
  })
  console.log('ğŸ“¦ æ•°æ®å·²ç¼“å­˜')
}

// è·å–å›¾è¡¨æ ‡é¢˜
const getChartTitle = () => {
  const dataTypeText = {
    all: 'å…¨éƒ¨æ•°æ®',
    new_users: 'æ–°å¢ç”¨æˆ·',
    new_posts: 'æ–°å¢å¸–å­',
    new_plans: 'æ–°å¢è®¡åˆ’',
    new_resources: 'æ–°å¢èµ„æº',
    total_users: 'ç´¯è®¡ç”¨æˆ·',
    total_posts: 'ç´¯è®¡å¸–å­',
    total_plans: 'ç´¯è®¡è®¡åˆ’',
    total_resources: 'ç´¯è®¡èµ„æº'
  }
  
  const timeRangeText = {
    '7': 'è¿‘7å¤©',
    '30': 'è¿‘30å¤©', 
    '60': 'è¿‘60å¤©'
  }
  
  return `${dataTypeText[chartConfig.value.dataType]} - ${timeRangeText[chartConfig.value.timeRange]}`
}

// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
const showConfirm = (options: {
  title: string
  message: string
  confirmText: string
  cancelText?: string
  type?: 'danger' | 'warning' | 'info' | 'success'
  callback: () => void
}) => {
  // ç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ
  if (confirm(`${options.title}\n\n${options.message}`)) {
    options.callback()
  }
}
</script>

<style scoped>
/* ç¡®ä¿æ‰€æœ‰æ•°å­—è¾“å…¥æ¡†éƒ½ç§»é™¤ä¸Šä¸‹ç®­å¤´ */
input[type="number"] {
  -moz-appearance: textfield;
}

input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* éšè—å‰ç«¯ä¾§è¾¹æ ç›¸å…³æ ·å¼ */
.sidebar-navigation {
  display: none !important;
}

.bottom-navigation {
  display: none !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å§‹ç»ˆæ˜¾ç¤º */
aside.admin-sidebar {
  display: block !important;
  position: fixed !important;
  visibility: visible !important;
  opacity: 1 !important;
  z-index: 50 !important;
  width: 16rem !important;
  background-color: white !important;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
}

.dark aside.admin-sidebar {
  background-color: rgb(31 41 55) !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å†…éƒ¨å®¹å™¨æ­£å¸¸æ˜¾ç¤º */
aside.admin-sidebar > div {
  display: flex !important;
  flex-direction: column !important;
  height: 100% !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å¤´éƒ¨æ­£å¸¸æ˜¾ç¤º */
aside.admin-sidebar > div > div:first-child {
  display: block !important;
  padding: 1.5rem !important;
  border-bottom: 1px solid rgb(229 231 235) !important;
}

.dark aside.admin-sidebar > div > div:first-child {
  border-bottom-color: rgb(55 65 75) !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å¯¼èˆªå§‹ç»ˆæ˜¾ç¤º */
aside.admin-sidebar nav.sidebar-nav {
  display: flex !important;
  flex-direction: column !important;
  flex: 1 1 0% !important;
  padding: 1.5rem 1rem !important;
  gap: 0.5rem !important;
  visibility: visible !important;
  opacity: 1 !important;
  overflow-y: auto !important;
}

/* ç¡®ä¿å¯¼èˆªæŒ‰é’®æ­£å¸¸æ˜¾ç¤º - router-link ä¼šè¢«æ¸²æŸ“ä¸º <a> æ ‡ç­¾ */
aside.admin-sidebar nav.sidebar-nav a {
  display: flex !important;
  align-items: center !important;
  padding: 0.75rem 1rem !important;
  border-radius: 0.5rem !important;
  font-size: 0.875rem !important;
  font-weight: 500 !important;
  transition: all 0.2s ease-in-out !important;
  text-decoration: none !important;
  visibility: visible !important;
  opacity: 1 !important;
  cursor: pointer !important;
  background-color: rgb(243 244 246) !important;
  color: rgb(55 65 81) !important;
  margin-bottom: 0.5rem !important;
  width: 100% !important;
  min-height: 2.75rem !important;
}

.dark aside.admin-sidebar nav.sidebar-nav a {
  background-color: rgb(31 41 55) !important;
  color: rgb(209 213 219) !important;
}

aside.admin-sidebar nav.sidebar-nav a:hover {
  background-color: rgb(229 231 235) !important;
  transform: translateX(2px) !important;
}

.dark aside.admin-sidebar nav.sidebar-nav a:hover {
  background-color: rgb(55 65 75) !important;
}

/* ç¡®ä¿ä¾§è¾¹æ åº•éƒ¨æ­£å¸¸æ˜¾ç¤º */
aside.admin-sidebar > div > div:last-child {
  display: block !important;
  padding: 1rem !important;
  border-top: 1px solid rgb(229 231 235) !important;
}

.dark aside.admin-sidebar > div > div:last-child {
  border-top-color: rgb(55 65 75) !important;
}

/* éšè—å…¶ä»–å¯¼èˆªå…ƒç´ ï¼ˆéä¾§è¾¹æ å†…çš„ï¼‰ */
body > nav:not(.sidebar-nav),
main nav:not(.sidebar-nav),
header nav:not(.sidebar-nav) {
  display: none !important;
}

/* ç¡®ä¿åå°é¡µé¢å æ®æ•´ä¸ªå±å¹• */
body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}

/* å¼ºåˆ¶ç¡®ä¿ä¾§è¾¹æ åœ¨æ‰€æœ‰è·¯ç”±ä¸‹éƒ½å¯è§ - å…¨å±€æœ€é«˜ä¼˜å…ˆçº§ */
.admin-sidebar {
  display: block !important;
  position: fixed !important;
  left: 0 !important;
  top: 0 !important;
  height: 100vh !important;
  width: 16rem !important;
  z-index: 50 !important;
  visibility: visible !important;
  opacity: 1 !important;
  transform: none !important;
  overflow: visible !important;
}

/* è¦†ç›–æ‰€æœ‰å¯èƒ½çš„éšè—è§„åˆ™ */
div.admin-sidebar,
aside.admin-sidebar,
nav.admin-sidebar,
.admin-sidebar *,
.admin-sidebar > *,
.admin-sidebar div,
.admin-sidebar nav,
.admin-sidebar a {
  display: revert !important;
  visibility: revert !important;
}

/* é‡æ–°å®šä¹‰å…³é”®æ ·å¼ */
.admin-sidebar {
  display: block !important;
  visibility: visible !important;
}

/* ç»ˆæä¿æŠ¤ï¼šè¦†ç›–æ‰€æœ‰å¯èƒ½çš„å¤–éƒ¨æ ·å¼å¹²æ‰° */
html body div.admin-sidebar,
html body aside.admin-sidebar,
html body nav.admin-sidebar,
html body [class*="admin-sidebar"] {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: fixed !important;
  left: 0 !important;
  top: 0 !important;
  height: 100vh !important;
  width: 16rem !important;
  z-index: 9999 !important;
  transform: none !important;
  clip: none !important;
  clip-path: none !important;
}

/* ä¿æŠ¤ä¾§è¾¹æ å†…çš„æ‰€æœ‰æŒ‰é’® */
.admin-sidebar .sidebar-button,
.admin-sidebar nav a,
.admin-sidebar router-link,
.admin-sidebar button {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å†…å®¹åŒºåŸŸæ­£å¸¸æ˜¾ç¤º */
.admin-sidebar > div {
  display: flex !important;
  flex-direction: column !important;
  height: 100% !important;
  width: 100% !important;
}

/* ç¡®ä¿å¯¼èˆªæŒ‰é’®å®¹å™¨æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar nav.sidebar-nav,
aside.admin-sidebar nav.sidebar-nav {
  display: flex !important;
  flex-direction: column !important;
  flex: 1 1 0% !important;
  gap: 0.5rem !important;
  padding: 1.5rem 1rem !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  visibility: visible !important;
  opacity: 1 !important;
  min-height: 200px !important;
}

/* ç¡®ä¿æ¯ä¸ªå¯¼èˆªæŒ‰é’®éƒ½å¯è§ - router-link ä¼šè¢«æ¸²æŸ“ä¸º <a> æ ‡ç­¾ */
.admin-sidebar nav.sidebar-nav > *,
.admin-sidebar nav.sidebar-nav > a {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  min-height: 2.75rem !important;
  align-items: center !important;
  width: 100% !important;
  margin-bottom: 0.5rem !important;
}

/* ç¡®ä¿ router-link æ¸²æŸ“çš„ <a> æ ‡ç­¾æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar nav.sidebar-nav a {
  display: flex !important;
  align-items: center !important;
  padding: 0.75rem 1rem !important;
  border-radius: 0.5rem !important;
  font-size: 0.875rem !important;
  font-weight: 500 !important;
  text-decoration: none !important;
  visibility: visible !important;
  opacity: 1 !important;
  cursor: pointer !important;
  background-color: rgb(243 244 246) !important;
  color: rgb(55 65 81) !important;
  transition: all 0.2s ease-in-out !important;
}

.dark .admin-sidebar nav.sidebar-nav a {
  background-color: rgb(31 41 55) !important;
  color: rgb(209 213 219) !important;
}

.admin-sidebar nav.sidebar-nav a:hover {
  background-color: rgb(229 231 235) !important;
  transform: translateX(2px) !important;
}

.dark .admin-sidebar nav.sidebar-nav a:hover {
  background-color: rgb(55 65 75) !important;
}

/* ç¡®ä¿å›¾æ ‡å’Œæ–‡å­—æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar nav.sidebar-nav span {
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ç¡®ä¿æŒ‰é’®å†…çš„å›¾æ ‡æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar nav.sidebar-nav a span:first-child {
  display: inline-block !important;
  margin-right: 0.75rem !important;
  font-size: 1.125rem !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ç¡®ä¿æŒ‰é’®å†…çš„æ–‡å­—æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar nav.sidebar-nav a span:last-child {
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* å¼ºåˆ¶ç¡®ä¿æ‰€æœ‰å¯¼èˆªæŒ‰é’®å¯è§ - æœ€é«˜ä¼˜å…ˆçº§ */
aside.admin-sidebar nav.sidebar-nav > a,
.admin-sidebar nav.sidebar-nav > a,
aside.admin-sidebar nav.sidebar-nav a,
.admin-sidebar nav.sidebar-nav a,
aside.admin-sidebar nav.sidebar-nav router-link,
.admin-sidebar nav.sidebar-nav router-link {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  z-index: 1 !important;
  min-width: 100% !important;
  box-sizing: border-box !important;
  min-height: 2.75rem !important;
  align-items: center !important;
  padding: 0.75rem 1rem !important;
}

/* ç¡®ä¿æŒ‰é’®å†…å®¹ï¼ˆå›¾æ ‡å’Œæ–‡å­—ï¼‰å§‹ç»ˆå¯è§ */
aside.admin-sidebar nav.sidebar-nav a > span,
.admin-sidebar nav.sidebar-nav a > span {
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
  pointer-events: auto !important;
}

/* é˜²æ­¢ä»»ä½•æ ·å¼è¦†ç›–æŒ‰é’®çš„å¯è§æ€§ */
aside.admin-sidebar nav.sidebar-nav a[style*="display: none"],
aside.admin-sidebar nav.sidebar-nav a[style*="visibility: hidden"],
aside.admin-sidebar nav.sidebar-nav a[style*="opacity: 0"] {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ç¡®ä¿æŒ‰é’®å†…å®¹ï¼ˆå›¾æ ‡å’Œæ–‡å­—ï¼‰éƒ½å¯è§ */
aside.admin-sidebar nav.sidebar-nav a > span,
.admin-sidebar nav.sidebar-nav a > span {
  display: inline-block !important;
  visibility: visible !important;
  opacity: 1 !important;
  position: relative !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å¤´éƒ¨æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar > div > div:first-child {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.admin-sidebar > div > div:first-child > div {
  display: flex !important;
  align-items: center !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ç¡®ä¿ä¾§è¾¹æ å¤´éƒ¨æ–‡å­—æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar h2,
.admin-sidebar p {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  margin: 0 !important;
}

/* ç¡®ä¿ä¾§è¾¹æ åº•éƒ¨æ­£å¸¸æ˜¾ç¤º */
.admin-sidebar > div > div:last-child {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.admin-sidebar > div > div:last-child > div {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ä¾§è¾¹æ é“¾æ¥æ¿€æ´»çŠ¶æ€ */
aside.admin-sidebar nav.sidebar-nav a.router-link-active,
aside.admin-sidebar nav.sidebar-nav router-link.router-link-active {
  background-color: rgb(219 234 254) !important; /* blue-100 */
  color: rgb(29 78 216) !important; /* blue-700 */
}

.dark aside.admin-sidebar nav.sidebar-nav a.router-link-active,
.dark aside.admin-sidebar nav.sidebar-nav router-link.router-link-active {
  background-color: rgba(30 58 138 / 0.2) !important; /* blue-900/20 */
  color: rgb(147 197 253) !important; /* blue-300 */
}

/* å¯¼èˆªå›¾æ ‡åŠ¨ç”» */
nav a:hover span:first-child {
  transform: scale(1.1);
}

nav a span:first-child {
  transition: transform 0.2s ease-in-out;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
main::-webkit-scrollbar {
  width: 6px;
}

main::-webkit-scrollbar-track {
  background: rgb(243 244 246);
}

.dark main::-webkit-scrollbar-track {
  background: rgb(31 41 55);
}

main::-webkit-scrollbar-thumb {
  background: rgb(156 163 175);
  border-radius: 3px;
}

main::-webkit-scrollbar-thumb:hover {
  background: rgb(107 114 128);
}

/* å›¾è¡¨ç›¸å…³æ ·å¼ */
.chart-container {
  position: relative;
  height: 384px;
}

.chart-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 0.5rem;
}

.dark .chart-loading {
  background: rgba(31, 41, 55, 0.9);
}

/* ä¸‹æ‹‰æ¡†æ ·å¼ä¼˜åŒ– */
select {
  transition: all 0.2s ease-in-out;
}

select:hover {
  border-color: rgb(59, 130, 246);
}

select:focus {
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* å›¾ä¾‹é¢œè‰²æŒ‡ç¤ºå™¨ */
.legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* å“åº”å¼å›¾è¡¨å®¹å™¨ */
@media (max-width: 768px) {
  .chart-container {
    height: 300px;
  }
}

/* ========== ä¾§è¾¹æ åº•éƒ¨ä¿æŠ¤è§„åˆ™ ========== */

/* ç¡®ä¿ä¾§è¾¹æ åº•éƒ¨å®¹å™¨å§‹ç»ˆå¯è§ */
.admin-sidebar > div > div:last-child,
aside.admin-sidebar > div > div:last-child {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  padding: 1rem !important;
  border-top: 1px solid #e5e7eb !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.dark .admin-sidebar > div > div:last-child,
.dark aside.admin-sidebar > div > div:last-child {
  border-top-color: #374151 !important;
}

/* ç”¨æˆ·ä¿¡æ¯åŒºåŸŸä¿æŠ¤ - åŒä¸€è¡Œå¸ƒå±€ */
.admin-sidebar > div > div:last-child > div,
aside.admin-sidebar > div > div:last-child > div {
  display: flex !important;
  align-items: center !important;
  justify-content: space-between !important;
  width: 100% !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* å¤´åƒä¿æŠ¤ */
.admin-sidebar .h-8.w-8.rounded-full,
aside.admin-sidebar .h-8.w-8.rounded-full {
  height: 2rem !important;
  width: 2rem !important;
  border-radius: 50% !important;
  background: linear-gradient(to bottom right, #4ade80, #3b82f6) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  visibility: visible !important;
  opacity: 1 !important;
  flex-shrink: 0 !important;
}

/* å¤´åƒæ–‡å­—ä¿æŠ¤ */
.admin-sidebar .h-8.w-8.rounded-full span,
aside.admin-sidebar .h-8.w-8.rounded-full span {
  font-size: 0.75rem !important;
  font-weight: 700 !important;
  color: white !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ç”¨æˆ·åå’Œæ—¶é—´å®¹å™¨ */
.admin-sidebar > div > div:last-child > div > div:nth-child(2),
aside.admin-sidebar > div > div:last-child > div > div:nth-child(2) {
  margin-left: 0.75rem !important;
  flex: 1 !important;
  min-width: 0 !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ç”¨æˆ·åä¿æŠ¤ */
.admin-sidebar > div > div:last-child .text-sm.font-medium,
aside.admin-sidebar > div > div:last-child .text-sm.font-medium {
  font-size: 0.875rem !important;
  font-weight: 500 !important;
  color: #111827 !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  line-height: 1.25 !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
}

.dark .admin-sidebar > div > div:last-child .text-sm.font-medium,
.dark aside.admin-sidebar > div > div:last-child .text-sm.font-medium {
  color: #f9fafb !important;
}

/* æ—¶é—´æ˜¾ç¤ºä¿æŠ¤ */
.admin-sidebar > div > div:last-child .text-xs.text-gray-500,
aside.admin-sidebar > div > div:last-child .text-xs.text-gray-500 {
  font-size: 0.75rem !important;
  color: #6b7280 !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  line-height: 1 !important;
  white-space: nowrap !important;
}

.dark .admin-sidebar > div > div:last-child .text-xs.text-gray-500,
.dark aside.admin-sidebar > div > div:last-child .text-xs.text-gray-500 {
  color: #9ca3af !important;
}

/* é€€å‡ºæŒ‰é’®ä¿æŠ¤ */
.admin-sidebar > div > div:last-child button,
aside.admin-sidebar > div > div:last-child button {
  padding: 0.5rem !important;
  color: #6b7280 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  visibility: visible !important;
  opacity: 1 !important;
  border: none !important;
  background: none !important;
  cursor: pointer !important;
  border-radius: 0.25rem !important;
  transition: color 0.2s ease !important;
}

.dark .admin-sidebar > div > div:last-child button,
.dark aside.admin-sidebar > div > div:last-child button {
  color: #9ca3af !important;
}

.admin-sidebar > div > div:last-child button:hover,
aside.admin-sidebar > div > div:last-child button:hover {
  color: #dc2626 !important;
}

.dark .admin-sidebar > div > div:last-child button:hover,
.dark aside.admin-sidebar > div > div:last-child button:hover {
  color: #ef4444 !important;
}

/* é€€å‡ºæŒ‰é’®å›¾æ ‡ä¿æŠ¤ */
.admin-sidebar > div > div:last-child button svg,
aside.admin-sidebar > div > div:last-child button svg {
  height: 1rem !important;
  width: 1rem !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}
</style>