import{d as V,u as N,r as x,g as J,h as U,a as p,b as a,w as A,i as f,v as b,j as h,n as T,t as E,e as C,k as D,o as w,l as j,m as g,_ as R}from"./index-7612b546.js";import{useDatabaseStore as z}from"./database-ff9128f9.js";import"./supabase-f74fb3ee.js";const O={class:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4"},G={class:"max-w-md mx-auto bg-white rounded-lg shadow-lg p-8"},B={key:0,class:"mt-1 text-xs text-red-600"},X={key:0,class:"mt-1 text-xs text-red-600"},Z=["disabled"],F={class:"mt-6 text-center"},Y=V({__name:"RegisterPage",setup(H){const I=N(),_=z(),m=x(!1),o=x(""),l=x("success"),s=J({username:"",nickname:"",password:"",confirmPassword:""});function k(){s.password.length>=6&&s.confirmPassword&&s.password===s.confirmPassword&&(o.value="")}async function S(t){const n=new TextEncoder().encode(t),r=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).map(u=>u.toString(16).padStart(2,"0")).join("")}async function P(){if(!s.username||!s.password){o.value="请填写用户名和密码",l.value="error";return}if(s.password!==s.confirmPassword){o.value="两次输入的密码不一致",l.value="error";return}if(s.password.length<6){o.value="密码长度至少为6位",l.value="error";return}if(s.username.length<3){o.value="用户名长度至少为3位",l.value="error";return}m.value=!0,o.value="";try{let t=null;try{t=await _.getUserByUsername(s.username)}catch(r){console.warn("数据库存储连接失败，尝试直接连接Supabase:",r.message);const{createClient:i}=await g(()=>import("./index-31c5edd2.js"),[]),u="https://aonlahundnkxuyxfsmcy.supabase.co",d="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvbmxhaHVuZG5reHV5eGZzbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjYwNTUsImV4cCI6MjA3ODY0MjA1NX0.IQswPG1NkJKht83isjWJk5nzuhymzETAf81_71kXaVE";if(u&&d){const v=i(u,d),{data:y,error:c}=await v.from("users").select("*").eq("username",s.username).single();c&&c.code!=="PGRST116"?console.error("直接Supabase连接失败:",c):t=y}}if(t){o.value="该用户名已被注册",l.value="error";return}const e=await S(s.password);let n=null;try{n=await _.createUser({username:s.username,password_hash:e})}catch(r){console.warn("数据库存储创建用户失败，尝试直接连接Supabase:",r.message);const{createClient:i}=await g(()=>import("./index-31c5edd2.js"),[]),u="https://aonlahundnkxuyxfsmcy.supabase.co",d="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvbmxhaHVuZG5reHV5eGZzbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjYwNTUsImV4cCI6MjA3ODY0MjA1NX0.IQswPG1NkJKht83isjWJk5nzuhymzETAf81_71kXaVE";if(u&&d){const v=i(u,d),{data:y,error:c}=await v.from("users").insert([{username:s.username,password_hash:e}]).select();if(c)throw console.error("直接Supabase创建用户失败:",c),c;n=y[0]}}o.value="注册成功！正在为您自动登录...",l.value="success";try{const{useDatabaseStore:r}=await g(()=>import("./database-ff9128f9.js"),["assets/database-ff9128f9.js","assets/index-7612b546.js","assets/index-e142188c.css","assets/supabase-f74fb3ee.js"]),u=await r().getUserByUsername(s.username);if(u)await g(()=>import("./index-7612b546.js").then(d=>d.N),["assets/index-7612b546.js","assets/index-e142188c.css"]),localStorage.setItem("currentUser",JSON.stringify(u)),o.value="注册成功！已自动登录",l.value="success",setTimeout(()=>{I.push("/")},1e3);else throw new Error("无法获取刚创建的用户信息")}catch(r){console.error("自动登录失败:",r),o.value="注册成功，请手动登录",l.value="success",setTimeout(()=>{I.push("/login")},2e3)}}catch(t){console.error("注册失败:",t);const e=t instanceof Error?t.message:"未知错误",n=t==null?void 0:t.code,r=t==null?void 0:t.details,i=t==null?void 0:t.hint;console.error("错误详情:",{message:e,code:n,details:r,hint:i}),e!=null&&e.includes("duplicate key")||n==="23505"?o.value="用户名已存在，请选择其他用户名":e!=null&&e.includes("connection")||n==="PGRST301"?o.value="数据库连接失败，请检查网络连接":e!=null&&e.includes("validation")||n==="PGRST116"?o.value="数据格式错误，请检查输入信息":o.value=`注册失败: ${e||"请稍后重试"}`,l.value="error"}finally{m.value=!1}}return(t,e)=>{const n=U("router-link");return w(),p("div",O,[a("div",G,[e[9]||(e[9]=a("div",{class:"text-center mb-6"},[a("h1",{class:"text-2xl font-bold text-gray-800 mb-2"},"用户注册"),a("p",{class:"text-sm text-gray-600"},"创建账号以开始您的学习之旅")],-1)),a("form",{onSubmit:A(P,["prevent"]),class:"space-y-4"},[a("div",null,[e[4]||(e[4]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"用户名",-1)),f(a("input",{"onUpdate:modelValue":e[0]||(e[0]=r=>s.username=r),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入用户名"},null,512),[[b,s.username]])]),a("div",null,[e[5]||(e[5]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"昵称",-1)),f(a("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>s.nickname=r),type:"text",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入昵称（可选）"},null,512),[[b,s.nickname]])]),a("div",null,[e[6]||(e[6]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"密码",-1)),f(a("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>s.password=r),type:"password",minlength:"6",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入密码（至少6位）",onInput:k},null,544),[[b,s.password]]),s.password&&s.password.length<6?(w(),p("div",B," 密码长度不足6位 ")):h("",!0)]),a("div",null,[e[7]||(e[7]=a("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"确认密码",-1)),f(a("input",{"onUpdate:modelValue":e[3]||(e[3]=r=>s.confirmPassword=r),type:"password",minlength:"6",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请再次输入密码",onInput:k},null,544),[[b,s.confirmPassword]]),s.confirmPassword&&s.password!==s.confirmPassword?(w(),p("div",X," 两次输入的密码不一致 ")):h("",!0)]),o.value?(w(),p("div",{key:0,class:T(["p-3 rounded-md text-sm",l.value==="success"?"bg-green-100 text-green-700":"bg-red-100 text-red-700"])},E(o.value),3)):h("",!0),a("button",{type:"submit",disabled:m.value,class:"w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"},E(m.value?"注册中...":"注册"),9,Z)],32),a("div",F,[C(n,{to:"/login",class:"text-blue-600 hover:underline text-sm"},{default:D(()=>[...e[8]||(e[8]=[j(" 已有账号？立即登录 ",-1)])]),_:1})])])])}}}),K=R(Y,[["__file","E:/前端初级课程/program/EduMatch/src/views/RegisterPage.vue"]]);export{K as default};
