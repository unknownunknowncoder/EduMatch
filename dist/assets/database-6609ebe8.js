import{K as A,r as l,A as f,L as w,M as d}from"./index-0e60331d.js";import{supabaseService as n}from"./supabase-b4265a88.js";const M=A("database",()=>{const i=l(!1),u=l(null),a=l(!0),y=f(()=>w.status==="connected"),g=f(()=>w.status==="connecting"),h=f(()=>w.status==="error");async function m(r,e){if(!y.value)throw new Error("数据库未连接");i.value=!0,u.value=null;try{return await d.query(r,e)}catch(t){throw u.value=t instanceof Error?t.message:"查询失败",t}finally{i.value=!1}}async function U(){try{const r=n.getClient(),{data:e,error:t}=await r.from("users").select("*");if(t)throw t;return e}catch(r){return console.error("获取用户数据失败:",r),[]}}async function v(r){return n.createUser(r)}async function _(r){return n.getUserById(r)}async function R(r){return n.getUserByUsername(r)}async function S(r){return n.getUserByEmail(r)}async function p(r){return n.getUserByNickname(r)}async function E(r,e){return n.updateUserNickname(r,e)}async function F(r={}){return n.getResources(r)}async function q(r){return n.getResources({search:r})}async function B(r,e){return n.addLearningRecord({user_id:r,resource_id:e,progress:0})}async function b(r){return n.getLearningRecords(r)}async function C(r){return n.getFavorites(r)}async function P(r){try{const e=await s(),{count:t,error:o}=await e.from("resources").select("*",{count:"exact",head:!0}).eq("created_by",r);if(o)throw o;return t||0}catch(e){return console.error("获取用户资源数量失败:",e),0}}async function T(r){try{const e=await s(),{count:t,error:o}=await e.from("community_posts").select("*",{count:"exact",head:!0}).eq("user_id",r);if(o)throw o;return t||0}catch(e){return console.error("获取用户帖子数量失败:",e),0}}async function L(r){try{const e=await s(),{data:t,error:o}=await e.from("resources").select("*").eq("created_by",r).order("created_at",{ascending:!1});if(o)throw o;return t||[]}catch(e){return console.error("获取用户资源失败:",e),[]}}async function N(r){try{const e=await s(),{data:t,error:o}=await e.from("community_posts").select("*").eq("user_id",r).order("created_at",{ascending:!1});if(o)throw o;return t||[]}catch(e){return console.error("获取用户帖子失败:",e),[]}}async function G(r,e){if(!a.value)return!1;try{const t=await s(),{data:o,error:c}=await t.from("user_follows").select("*").eq("follower_id",r).eq("following_id",e).single();if(c){if(c.code==="PGRST205")return a.value=!1,console.warn("用户关注功能未启用：缺少 user_follows 表"),!1;if(c.code!=="PGRST116")throw c}return!!o}catch(t){return(t==null?void 0:t.code)==="PGRST205"?(a.value=!1,console.warn("用户关注功能未启用：缺少 user_follows 表"),!1):(console.error("检查关注状态失败:",t),!1)}}async function I(r){try{const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(!e.id)throw new Error("用户未登录");if(!a.value)throw new Error("当前环境尚未启用关注功能");const t=await s(),{data:o,error:c}=await t.from("user_follows").insert([{follower_id:e.id,following_id:r,created_at:new Date().toISOString()}]).select();if(c)throw c.code==="PGRST205"?(a.value=!1,new Error("当前环境尚未启用关注功能")):c;return o==null?void 0:o[0]}catch(e){throw console.error("关注用户失败:",e),e}}async function k(r){try{const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(!e.id)throw new Error("用户未登录");if(!a.value)throw new Error("当前环境尚未启用关注功能");const t=await s(),{error:o}=await t.from("user_follows").delete().eq("follower_id",e.id).eq("following_id",r);if(o)throw o.code==="PGRST205"?(a.value=!1,new Error("当前环境尚未启用关注功能")):o;return!0}catch(e){throw console.error("取消关注失败:",e),e}}async function x(r,e){return n.addToFavorites(r,e)}async function O(r,e){return n.removeFromFavorites(r,e)}const s=async()=>d.getClient();return{isLoading:i,error:u,isConnected:y,isConnecting:g,hasError:h,executeQuery:m,getClient:s,getUsers:U,createUser:v,getUserById:_,getUserByUsername:R,getUserByEmail:S,getUserByNickname:p,updateUserNickname:E,getResources:F,searchResources:q,addLearningRecord:B,getLearningRecords:b,getFavorites:C,addToFavorites:x,removeFromFavorites:O,getUserResourceCount:P,getUserPostCount:T,getUserResources:L,getUserPosts:N,isFollowing:G,followUser:I,unfollowUser:k,reconnect:async()=>{await d.init()}}});export{M as useDatabaseStore};
