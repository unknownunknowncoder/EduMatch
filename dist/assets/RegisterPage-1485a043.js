import{d as A,u as D,r as g,g as T,h as V,a as i,b as t,w as R,i as d,v as c,j as f,n as B,t as _,e as C,k as I,o as m,l as N,D as P,_ as O}from"./index-9b7d0a80.js";import{useDatabaseStore as q}from"./database-dd77cb4c.js";import"./supabase-2d6ad7e7.js";const L={class:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4"},M={class:"max-w-md mx-auto bg-white rounded-lg shadow-lg p-8"},j={key:0,class:"mt-1 text-xs text-red-600"},F={key:0,class:"mt-1 text-xs text-red-600"},G=["disabled"],H={class:"mt-6 text-center"},z=A({__name:"RegisterPage",setup(J){const v=D(),b=q(),u=g(!1),o=g(""),a=g("success"),e=T({username:"",nickname:"",password:"",confirmPassword:""});function w(){e.password.length>=6&&e.confirmPassword&&e.password===e.confirmPassword&&(o.value="")}async function S(l){const n=new TextEncoder().encode(l),r=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).map(y=>y.toString(16).padStart(2,"0")).join("")}async function k(){var l,s,n;if(!e.username||!e.password){o.value="请填写用户名和密码",a.value="error";return}if(e.password!==e.confirmPassword){o.value="两次输入的密码不一致",a.value="error";return}if(e.password.length<6){o.value="密码长度至少为6位",a.value="error";return}if(e.username.length<3){o.value="用户名长度至少为3位",a.value="error";return}u.value=!0,o.value="";try{if(await b.getUserByUsername(e.username)){o.value="该用户名已被注册",a.value="error";return}const x=await S(e.password),y=await b.createUser({username:e.username,password_hash:x});o.value="注册成功！正在为您自动登录...",a.value="success";try{const{useDatabaseStore:p}=await P(()=>import("./database-dd77cb4c.js"),["assets/database-dd77cb4c.js","assets/index-9b7d0a80.js","assets/index-875cf341.css","assets/supabase-2d6ad7e7.js"]),h=await p().getUserByUsername(e.username);if(h){const{useAuthStore:U}=await P(()=>import("./index-9b7d0a80.js").then(E=>E.O),["assets/index-9b7d0a80.js","assets/index-875cf341.css"]),K=U();localStorage.setItem("currentUser",JSON.stringify(h)),o.value="注册成功！已自动登录",a.value="success",setTimeout(()=>{v.push("/")},1e3)}else throw new Error("无法获取刚创建的用户信息")}catch(p){console.error("自动登录失败:",p),o.value="注册成功，请手动登录",a.value="success",setTimeout(()=>{v.push("/login")},2e3)}}catch(r){console.error("注册失败:",r),console.error("错误详情:",{message:r.message,code:r.code,details:r.details,hint:r.hint}),(l=r.message)!=null&&l.includes("duplicate key")||r.code==="23505"?o.value="用户名已存在，请选择其他用户名":(s=r.message)!=null&&s.includes("connection")||r.code==="PGRST301"?o.value="数据库连接失败，请检查网络连接":(n=r.message)!=null&&n.includes("validation")||r.code==="PGRST116"?o.value="数据格式错误，请检查输入信息":o.value=`注册失败: ${r.message||"请稍后重试"}`,a.value="error"}finally{u.value=!1}}return(l,s)=>{const n=V("router-link");return m(),i("div",L,[t("div",M,[s[9]||(s[9]=t("div",{class:"text-center mb-6"},[t("h1",{class:"text-2xl font-bold text-gray-800 mb-2"},"用户注册"),t("p",{class:"text-sm text-gray-600"},"创建账号以开始您的学习之旅")],-1)),t("form",{onSubmit:R(k,["prevent"]),class:"space-y-4"},[t("div",null,[s[4]||(s[4]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"用户名",-1)),d(t("input",{"onUpdate:modelValue":s[0]||(s[0]=r=>e.username=r),type:"text",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入用户名"},null,512),[[c,e.username]])]),t("div",null,[s[5]||(s[5]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"昵称",-1)),d(t("input",{"onUpdate:modelValue":s[1]||(s[1]=r=>e.nickname=r),type:"text",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入昵称（可选）"},null,512),[[c,e.nickname]])]),t("div",null,[s[6]||(s[6]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"密码",-1)),d(t("input",{"onUpdate:modelValue":s[2]||(s[2]=r=>e.password=r),type:"password",minlength:"6",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请输入密码（至少6位）",onInput:w},null,544),[[c,e.password]]),e.password&&e.password.length<6?(m(),i("div",j," 密码长度不足6位 ")):f("",!0)]),t("div",null,[s[7]||(s[7]=t("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"确认密码",-1)),d(t("input",{"onUpdate:modelValue":s[3]||(s[3]=r=>e.confirmPassword=r),type:"password",minlength:"6",required:"",class:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"请再次输入密码",onInput:w},null,544),[[c,e.confirmPassword]]),e.confirmPassword&&e.password!==e.confirmPassword?(m(),i("div",F," 两次输入的密码不一致 ")):f("",!0)]),o.value?(m(),i("div",{key:0,class:B(["p-3 rounded-md text-sm",a.value==="success"?"bg-green-100 text-green-700":"bg-red-100 text-red-700"])},_(o.value),3)):f("",!0),t("button",{type:"submit",disabled:u.value,class:"w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"},_(u.value?"注册中...":"注册"),9,G)],32),t("div",H,[C(n,{to:"/login",class:"text-blue-600 hover:underline text-sm"},{default:I(()=>[...s[8]||(s[8]=[N(" 已有账号？立即登录 ",-1)])]),_:1})])])])}}}),Y=O(z,[["__file","E:/前端初级课程/program/EduMatch/src/views/RegisterPage.vue"]]);export{Y as default};
