import{d as V,D as q,r as f,q as F,a as g,b as s,t as m,n as I,j as D,i as j,v as P,F as R,y as T,B as $,o as h,_ as X}from"./index-fbee997b.js";import{useDatabaseStore as Y}from"./database-f936e93a.js";import"./supabase-f56aac63.js";const Z={class:"post-detail"},G={class:"container"},K={class:"back-button"},H={key:0,class:"post-card"},Q={class:"post-header"},W={class:"post-title"},ee={class:"post-meta"},te={class:"author"},oe={class:"date"},re={class:"flex items-center space-x-2 ml-auto"},se=["disabled"],ne={class:"text-sm font-medium"},ae=["disabled"],le={class:"text-sm font-medium"},ie={class:"text-sm font-medium"},ce={class:"post-content"},ue={key:1,class:"comments-section"},de={class:"add-comment"},me=["disabled"],_e={class:"comments-list"},ve={class:"comment-header"},fe={class:"comment-avatar"},ge=["src","alt"],he={class:"comment-user-info"},pe={class:"comment-author"},we={class:"comment-date"},ye={class:"comment-content"},be={key:0,class:"no-comments"},ke=V({__name:"PostDetail",setup(xe){const d=q().params.id,n=f(null),_=f([]),c=f(""),y=f(!1),b=f(!1),p=f(!1),k=f(0),i=Y(),S=t=>{const e=new Date(t);return e.toLocaleDateString("zh-CN")+" "+e.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})},M=()=>{p.value=!p.value,p.value&&setTimeout(()=>{const t=document.querySelector(".comments-section");t&&t.scrollIntoView({behavior:"smooth"})},100)},N=async t=>{if(!y.value){y.value=!0;try{let e=null;const r=localStorage.getItem("currentUser");if(r)try{const o=JSON.parse(r);o.id&&(e=o.id)}catch(o){console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:",o)}if(!e){alert("è¯·å…ˆç™»å½•åå†ç‚¹èµ");return}let a=await i.getClient();if(a||(console.log("ç‚¹èµæ“ä½œï¼šæ•°æ®åº“å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°è¿æ¥..."),await i.reconnect(),a=await i.getClient()),!a){console.error("ç‚¹èµæ“ä½œï¼šæ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥");return}if(t.is_liked){const{error:o}=await a.from("post_likes").delete().eq("user_id",e).eq("post_id",t.id);if(o)throw console.error("å–æ¶ˆç‚¹èµå¤±è´¥:",o),o;t.is_liked=!1,t.like_count=Math.max((t.like_count||0)-1,0),console.log("âœ… å–æ¶ˆç‚¹èµæˆåŠŸ")}else{const{error:o}=await a.from("post_likes").insert([{user_id:e,post_id:t.id}]);if(o)throw console.error("æ·»åŠ ç‚¹èµå¤±è´¥:",o),o;t.is_liked=!0,t.like_count=(t.like_count||0)+1,console.log("âœ… æ·»åŠ ç‚¹èµæˆåŠŸ")}}catch(e){console.error("ç‚¹èµæ“ä½œå¤±è´¥:",e)}finally{y.value=!1}}},z=async t=>{if(!b.value){b.value=!0;try{let e=null;const r=localStorage.getItem("currentUser");if(r)try{const o=JSON.parse(r);o.id&&(e=o.id)}catch(o){console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:",o)}if(!e){alert("è¯·å…ˆç™»å½•åå†æ”¶è—å¸–å­");return}let a=await i.getClient();if(a||(console.log("æ”¶è—æ“ä½œï¼šæ•°æ®åº“å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°è¿æ¥..."),await i.reconnect(),a=await i.getClient()),!a){console.error("æ”¶è—æ“ä½œï¼šæ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥");return}if(t.is_favorited){const{error:o}=await a.from("post_favorites").delete().eq("user_id",e).eq("post_id",t.id);if(o)throw console.error("å–æ¶ˆæ”¶è—å¤±è´¥:",o),o;t.is_favorited=!1,t.favorite_count=Math.max((t.favorite_count||0)-1,0),console.log("âœ… å–æ¶ˆæ”¶è—æˆåŠŸ")}else{const{error:o}=await a.from("post_favorites").insert([{user_id:e,post_id:t.id}]);if(o)throw console.error("æ·»åŠ æ”¶è—å¤±è´¥:",o),o;t.is_favorited=!0,t.favorite_count=(t.favorite_count||0)+1,console.log("âœ… æ·»åŠ æ”¶è—æˆåŠŸ")}}catch(e){console.error("æ”¶è—æ“ä½œå¤±è´¥:",e)}finally{b.value=!1}}},A=async()=>{var t,e;try{let r=await i.getClient();if(r||(console.log("å¸–å­è¯¦æƒ…åŠ è½½ï¼šæ•°æ®åº“å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°è¿æ¥..."),await i.reconnect(),r=await i.getClient()),!r){console.error("å¸–å­è¯¦æƒ…åŠ è½½ï¼šæ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥");return}console.log("ğŸ“– å¼€å§‹åŠ è½½å¸–å­è¯¦æƒ…ï¼ŒID:",d);const{data:a,error:o}=await r.from("community_posts").select(`
        *,
        user:user_id (
          id,
          username,
          nickname
        )
      `).eq("id",d).single();if(o){console.error("âŒ åŠ è½½å¸–å­è¯¦æƒ…å¤±è´¥:",o);return}let u=null;const w=localStorage.getItem("currentUser");if(w)try{const l=JSON.parse(w);l.id&&(u=l.id)}catch(l){console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:",l)}let v=!1;if(u){const{data:l,error:C}=await r.from("post_favorites").select("id").eq("user_id",u).eq("post_id",d);!C&&l&&l.length>0&&(v=!0)}n.value={...a,author_name:((t=a.user)==null?void 0:t.nickname)||((e=a.user)==null?void 0:e.username)||"åŒ¿åç”¨æˆ·",is_favorited:v,favorite_count:a.favorite_count||0},console.log("âœ… å¸–å­è¯¦æƒ…åŠ è½½æˆåŠŸ:",n.value),await x()}catch(r){console.error("âŒ è·å–å¸–å­è¯¦æƒ…å¤±è´¥:",r)}},x=async()=>{try{let t=await i.getClient();if(t||(console.log("è¯„è®ºåŠ è½½ï¼šæ•°æ®åº“å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°è¿æ¥..."),await i.reconnect(),t=await i.getClient()),!t){console.error("è¯„è®ºåŠ è½½ï¼šæ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥");return}console.log("ğŸ’¬ å¼€å§‹åŠ è½½è¯„è®ºï¼Œå¸–å­ID:",d);const{data:e,error:r}=await t.from("post_comments").select(`
        *,
        user:user_id (
          id,
          username,
          nickname
        )
      `).eq("post_id",d).order("created_at",{ascending:!0});if(r){console.error("âŒ åŠ è½½è¯„è®ºå¤±è´¥:",r);return}_.value=(e||[]).map(a=>{var o,u;return{...a,author_name:((o=a.user)==null?void 0:o.nickname)||((u=a.user)==null?void 0:u.username)||"åŒ¿åç”¨æˆ·"}}),k.value=_.value.length,console.log("âœ… è¯„è®ºåŠ è½½å®Œæˆï¼Œæ•°é‡:",_.value.length)}catch(t){console.error("âŒ åŠ è½½è¯„è®ºå¤±è´¥:",t)}},B=(t,e)=>{const r="#DBEAFE",a="#2563EB",o=e?e.charAt(0).toUpperCase():"U",u=`
    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
      <circle cx="20" cy="20" r="20" fill="${r}"/>
      <text x="20" y="26" text-anchor="middle" fill="${a}" font-family="Arial, sans-serif" font-size="16" font-weight="bold">
        ${o}
      </text>
    </svg>
  `.trim();return"data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(u)))},J=async()=>{if(c.value.trim())try{let t=null,e=null,r="å½“å‰ç”¨æˆ·";const a=localStorage.getItem("currentUser");if(a)try{t=JSON.parse(a),t.id&&(e=t.id,r=t.nickname||t.username||"å½“å‰ç”¨æˆ·")}catch(l){console.error("è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:",l)}if(!e)return;console.log("ğŸ’¬ å¼€å§‹å‘è¡¨è¯„è®ºï¼Œå¸–å­ID:",d,"ç”¨æˆ·ID:",e);let o=await i.getClient();if(o||(console.log("å‘è¡¨è¯„è®ºï¼šæ•°æ®åº“å®¢æˆ·ç«¯æœªåˆå§‹åŒ–ï¼Œå°è¯•é‡æ–°è¿æ¥..."),await i.reconnect(),o=await i.getClient()),!o){console.error("å‘è¡¨è¯„è®ºï¼šæ•°æ®åº“å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥");return}const u={}.VITE_SUPABASE_SERVICE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvbmxhaHVuZG5reHV5eGZzbWN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjYwNTUsImV4cCI6MjA3ODY0MjA1NX0.IQswPG1NkJKht83isjWJk5nzuhymzETAf81_71kXaVE";if(u){console.log("ä½¿ç”¨æœåŠ¡ç«¯å¯†é’¥ç»•è¿‡RLSç­–ç•¥");const{createClient:l}=await $(()=>import("./index-31c5edd2.js"),[]),C="https://aonlahundnkxuyxfsmcy.supabase.co";if(C&&u){const L=l(C,u),{data:Ie,error:E}=await L.from("post_comments").insert([{post_id:d,user_id:e,content:c.value.trim()}]).select();if(E){console.error("âŒ ä½¿ç”¨æœåŠ¡ç«¯å¯†é’¥ä¿å­˜è¯„è®ºå¤±è´¥:",E),console.log("å°è¯•ä½¿ç”¨åŸå§‹å®¢æˆ·ç«¯ä¿å­˜è¯„è®º...");const{data:De,error:U}=await o.from("post_comments").insert([{post_id:d,user_id:e,content:c.value.trim()}]).select();if(U){console.error("âŒ åŸå§‹å®¢æˆ·ç«¯ä¿å­˜è¯„è®ºå¤±è´¥:",U),console.log("ä½¿ç”¨æœ¬åœ°æ¨¡å¼ä¿å­˜è¯„è®º");const O={id:"temp-"+Date.now(),post_id:d,user_id:e,content:c.value.trim(),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),author_name:r};_.value.unshift(O),n.value&&(n.value.comment_count=(n.value.comment_count||0)+1),k.value=_.value.length,c.value="",console.log("âœ… è¯„è®ºå‘è¡¨æˆåŠŸï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰");return}else{console.log("âœ… è¯„è®ºå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåŸå§‹å®¢æˆ·ç«¯ï¼‰"),await x(),n.value&&(n.value.comment_count=(n.value.comment_count||0)+1),c.value="",console.log("âœ… è¯„è®ºå‘è¡¨æˆåŠŸ");return}}else{console.log("âœ… è¯„è®ºå·²ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆæœåŠ¡ç«¯å¯†é’¥ï¼‰"),await x(),n.value&&(n.value.comment_count=(n.value.comment_count||0)+1),c.value="",console.log("âœ… è¯„è®ºå‘è¡¨æˆåŠŸ");return}}}console.log("æ²¡æœ‰æœåŠ¡ç«¯å¯†é’¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹å®¢æˆ·ç«¯");const{data:w,error:v}=await o.from("post_comments").insert([{post_id:d,user_id:e,content:c.value.trim()}]).select();if(v){if(console.error("âŒ å‘è¡¨è¯„è®ºå¤±è´¥:",v),v.message.includes("RLS")||v.message.includes("policy")){console.log("RLSç­–ç•¥é™åˆ¶ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼...");const l={id:"temp-"+Date.now(),post_id:d,user_id:e,content:c.value.trim(),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),author_name:r};_.value.unshift(l),n.value&&(n.value.comment_count=(n.value.comment_count||0)+1),k.value=_.value.length,c.value="",console.log("âœ… è¯„è®ºå‘è¡¨æˆåŠŸï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰");return}return}w&&w[0]&&(await x(),n.value&&(n.value.comment_count=(n.value.comment_count||0)+1)),c.value="",console.log("âœ… è¯„è®ºå‘è¡¨æˆåŠŸ"),setTimeout(()=>{const l=document.querySelector(".comment-input");l&&l.focus()},100)}catch(t){console.error("âŒ å‘è¡¨è¯„è®ºå¤±è´¥:",t)}};return F(()=>{A()}),(t,e)=>(h(),g("div",Z,[s("div",G,[s("div",K,[s("button",{onClick:e[0]||(e[0]=r=>t.$router.back()),class:"btn btn-secondary"}," â† è¿”å›ç¤¾åŒº ")]),n.value?(h(),g("div",H,[s("div",Q,[s("h1",W,m(n.value.title),1),s("div",ee,[s("span",te,"ä½œè€…: "+m(n.value.author_name||"åŒ¿åç”¨æˆ·"),1),s("span",oe,m(S(n.value.created_at)),1),s("div",re,[s("button",{onClick:e[1]||(e[1]=r=>N(n.value)),disabled:y.value,class:I(["flex items-center space-x-1 px-3 py-1 rounded-full text-gray-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors disabled:opacity-50",n.value.is_liked?"text-red-500 bg-red-50 dark:bg-red-900/20":"bg-gray-100 dark:bg-gray-700"])},[e[4]||(e[4]=s("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"})],-1)),s("span",ne,m(n.value.like_count||0),1)],10,se),s("button",{onClick:e[2]||(e[2]=r=>z(n.value)),disabled:b.value,class:I(["flex items-center space-x-1 px-3 py-1 rounded-full text-gray-500 hover:text-yellow-500 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 transition-colors disabled:opacity-50",n.value.is_favorited?"text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20":"bg-gray-100 dark:bg-gray-700"])},[e[5]||(e[5]=s("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"})],-1)),s("span",le,m(n.value.favorite_count||0),1)],10,ae),s("button",{onClick:M,class:I(["flex items-center space-x-1 px-3 py-1 rounded-full text-gray-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors",p.value?"bg-blue-100 dark:bg-blue-900/20 text-blue-500":"bg-gray-100 dark:bg-gray-700"])},[e[6]||(e[6]=s("svg",{class:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[s("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})],-1)),s("span",ie,m(k.value),1)],2)])])]),s("div",ce,[s("p",null,m(n.value.content),1)])])):D("",!0),p.value?(h(),g("div",ue,[s("h2",null,"è¯„è®º ("+m(_.value.length)+")",1),s("div",de,[j(s("textarea",{"onUpdate:modelValue":e[3]||(e[3]=r=>c.value=r),placeholder:"å†™ä¸‹ä½ çš„è¯„è®º...",rows:"3",class:"comment-input"},null,512),[[P,c.value]]),s("button",{onClick:J,disabled:!c.value.trim(),class:"btn btn-primary"}," å‘è¡¨è¯„è®º ",8,me)]),s("div",_e,[(h(!0),g(R,null,T(_.value,r=>(h(),g("div",{key:r.id,class:"comment-item"},[s("div",ve,[s("div",fe,[s("img",{src:B(r.user_id,r.author_name),alt:r.author_name||"åŒ¿åç”¨æˆ·",class:"avatar"},null,8,ge)]),s("div",he,[s("span",pe,m(r.author_name||"åŒ¿åç”¨æˆ·"),1),s("span",we,m(S(r.created_at)),1)])]),s("div",ye,m(r.content),1)]))),128)),_.value.length===0?(h(),g("div",be," æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼ ")):D("",!0)])])):D("",!0)])]))}});const Me=X(ke,[["__scopeId","data-v-88a31469"],["__file","E:/å‰ç«¯åˆçº§è¯¾ç¨‹/program/EduMatch/src/views/PostDetail.vue"]]);export{Me as default};
